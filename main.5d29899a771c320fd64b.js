!function(t){function e(e){for(var r,i,s=e[0],a=e[1],o=0,h=[];o<s.length;o++)i=s[o],Object.prototype.hasOwnProperty.call(n,i)&&n[i]&&h.push(n[i][0]),n[i]=0;for(r in a)Object.prototype.hasOwnProperty.call(a,r)&&(t[r]=a[r]);for(u&&u(e);h.length;)h.shift()()}var r={},n={1:0};function i(e){if(r[e])return r[e].exports;var n=r[e]={i:e,l:!1,exports:{}};return t[e].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.e=function(t){var e=[],r=n[t];if(0!==r)if(r)e.push(r[2]);else{var s=new Promise((function(e,i){r=n[t]=[e,i]}));e.push(r[2]=s);var a,o=document.createElement("script");o.charset="utf-8",o.timeout=120,i.nc&&o.setAttribute("nonce",i.nc),o.src=function(t){return i.p+""+({2:"vendors~dat-gui"}[t]||t)+"."+{2:"3d14b300c299d61b6241"}[t]+".js"}(t);var u=new Error;a=function(e){o.onerror=o.onload=null,clearTimeout(h);var r=n[t];if(0!==r){if(r){var i=e&&("load"===e.type?"missing":e.type),s=e&&e.target&&e.target.src;u.message="Loading chunk "+t+" failed.\n("+i+": "+s+")",u.name="ChunkLoadError",u.type=i,u.request=s,r[1](u)}n[t]=void 0}};var h=setTimeout((function(){a({type:"timeout",target:o})}),12e4);o.onerror=o.onload=a,document.head.appendChild(o)}return Promise.all(e)},i.m=t,i.c=r,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(r,n,function(e){return t[e]}.bind(null,n));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i.oe=function(t){throw console.error(t),t};var s=window.webpackJsonp=window.webpackJsonp||[],a=s.push.bind(s);s.push=e,s=s.slice();for(var o=0;o<s.length;o++)e(s[o]);var u=a;i(i.s=11)}([function(t,e){t.exports={sourceCode:"#version 100\nprecision mediump float;uniform vec4 u_color;void main(){gl_FragColor=u_color;}",uniforms:{u_color:{variableType:"vec4",variableName:"u_color"}},consts:{}}},function(t,e){t.exports={sourceCode:"#version 300 es\nprecision mediump float;in vec2 a_pos;out vec3 v_worldPos;uniform float u_gridRadius;uniform mat4 g_viewProj;void main(){v_worldPos=vec3(a_pos.x,0,a_pos.y)*u_gridRadius;gl_Position=g_viewProj*vec4(v_worldPos,1.);}",uniforms:{u_gridRadius:{variableType:"float",variableName:"u_gridRadius"},g_viewProj:{variableType:"mat4",variableName:"g_viewProj"}},consts:{}}},function(t,e){t.exports={sourceCode:"#version 300 es\nprecision mediump float;in vec3 v_worldPos;out vec4 o_fragColor;uniform vec4 u_baseColor;uniform vec4 u_lineColor;uniform float u_gridUnit;uniform float u_gridRadius;void main(){vec2 coord=v_worldPos.xz/u_gridUnit;vec2 grid=abs(fract(coord-0.5)-0.5)/fwidth(coord);float line=min(grid.x,grid.y);float lineAmount=1.-min(line,1.);vec4 color=mix(u_baseColor,u_lineColor,lineAmount);float opacity=smoothstep(u_gridRadius*0.7,u_gridRadius,length(v_worldPos));color=mix(color,vec4(0),opacity);o_fragColor=color;}",uniforms:{u_baseColor:{variableType:"vec4",variableName:"u_baseColor"},u_lineColor:{variableType:"vec4",variableName:"u_lineColor"},u_gridUnit:{variableType:"float",variableName:"u_gridUnit"},u_gridRadius:{variableType:"float",variableName:"u_gridRadius"}},consts:{}}},function(t,e){t.exports={sourceCode:"precision mediump float;\n#ifndef k_MaxBones\n#   defined k_MaxBones 32\n#endif\nattribute vec3 a_pos;attribute vec4 a_joints;attribute vec4 a_weights;uniform mat4 g_viewProj;uniform mat4 u_joints[k_MaxBones];void main(){vec4 pos=vec4(a_pos,1.);vec4 modelPos=(u_joints[int(a_joints.x)]*pos*a_weights.x)+(u_joints[int(a_joints.y)]*pos*a_weights.y)+(u_joints[int(a_joints.z)]*pos*a_weights.z)+(u_joints[int(a_joints.w)]*pos*a_weights.w);gl_Position=g_viewProj*modelPos;}",uniforms:{g_viewProj:{variableType:"mat4",variableName:"g_viewProj"},u_joints:{variableType:"mat4",variableName:"u_joints"}},consts:{}}},function(t,e){t.exports={sourceCode:"#version 100\nprecision mediump float;attribute vec3 a_pos;uniform mat4 u_model;uniform mat4 g_viewProj;void main(){gl_Position=g_viewProj*u_model*vec4(a_pos,1.);}",uniforms:{u_model:{variableType:"mat4",variableName:"u_model"},g_viewProj:{variableType:"mat4",variableName:"g_viewProj"}},consts:{}}},function(t,e,r){t.exports=function(){return new Worker(r.p+"ResourceLoading.worker.3d945e751acf5d2ac95b.js")}},,,,,,function(t,e,r){"use strict";r.r(e);var n={};r.r(n),r.d(n,"create",(function(){return Z})),r.d(n,"clone",(function(){return J})),r.d(n,"copy",(function(){return K})),r.d(n,"fromValues",(function(){return Q})),r.d(n,"set",(function(){return tt})),r.d(n,"identity",(function(){return et})),r.d(n,"transpose",(function(){return rt})),r.d(n,"invert",(function(){return nt})),r.d(n,"adjoint",(function(){return it})),r.d(n,"determinant",(function(){return st})),r.d(n,"multiply",(function(){return at})),r.d(n,"translate",(function(){return ot})),r.d(n,"scale",(function(){return ut})),r.d(n,"rotate",(function(){return ht})),r.d(n,"rotateX",(function(){return ct})),r.d(n,"rotateY",(function(){return lt})),r.d(n,"rotateZ",(function(){return ft})),r.d(n,"fromTranslation",(function(){return dt})),r.d(n,"fromScaling",(function(){return mt})),r.d(n,"fromRotation",(function(){return pt})),r.d(n,"fromXRotation",(function(){return gt})),r.d(n,"fromYRotation",(function(){return vt})),r.d(n,"fromZRotation",(function(){return yt})),r.d(n,"fromRotationTranslation",(function(){return _t})),r.d(n,"fromQuat2",(function(){return xt})),r.d(n,"getTranslation",(function(){return bt})),r.d(n,"getScaling",(function(){return Mt})),r.d(n,"getRotation",(function(){return wt})),r.d(n,"fromRotationTranslationScale",(function(){return Tt})),r.d(n,"fromRotationTranslationScaleOrigin",(function(){return At})),r.d(n,"fromQuat",(function(){return St})),r.d(n,"frustum",(function(){return Et})),r.d(n,"perspective",(function(){return It})),r.d(n,"perspectiveFromFieldOfView",(function(){return Ft})),r.d(n,"ortho",(function(){return Ut})),r.d(n,"lookAt",(function(){return Ct})),r.d(n,"targetTo",(function(){return Nt})),r.d(n,"str",(function(){return Rt})),r.d(n,"frob",(function(){return Ot})),r.d(n,"add",(function(){return kt})),r.d(n,"subtract",(function(){return Bt})),r.d(n,"multiplyScalar",(function(){return zt})),r.d(n,"multiplyScalarAndAdd",(function(){return Lt})),r.d(n,"exactEquals",(function(){return Dt})),r.d(n,"equals",(function(){return Pt})),r.d(n,"mul",(function(){return Vt})),r.d(n,"sub",(function(){return jt}));var i={};r.r(i),r.d(i,"create",(function(){return Gt})),r.d(i,"clone",(function(){return qt})),r.d(i,"length",(function(){return Wt})),r.d(i,"fromValues",(function(){return Ht})),r.d(i,"copy",(function(){return Xt})),r.d(i,"set",(function(){return Yt})),r.d(i,"add",(function(){return $t})),r.d(i,"subtract",(function(){return Zt})),r.d(i,"multiply",(function(){return Jt})),r.d(i,"divide",(function(){return Kt})),r.d(i,"ceil",(function(){return Qt})),r.d(i,"floor",(function(){return te})),r.d(i,"min",(function(){return ee})),r.d(i,"max",(function(){return re})),r.d(i,"round",(function(){return ne})),r.d(i,"scale",(function(){return ie})),r.d(i,"scaleAndAdd",(function(){return se})),r.d(i,"distance",(function(){return ae})),r.d(i,"squaredDistance",(function(){return oe})),r.d(i,"squaredLength",(function(){return ue})),r.d(i,"negate",(function(){return he})),r.d(i,"inverse",(function(){return ce})),r.d(i,"normalize",(function(){return le})),r.d(i,"dot",(function(){return fe})),r.d(i,"cross",(function(){return de})),r.d(i,"lerp",(function(){return me})),r.d(i,"hermite",(function(){return pe})),r.d(i,"bezier",(function(){return ge})),r.d(i,"random",(function(){return ve})),r.d(i,"transformMat4",(function(){return ye})),r.d(i,"transformMat3",(function(){return _e})),r.d(i,"transformQuat",(function(){return xe})),r.d(i,"rotateX",(function(){return be})),r.d(i,"rotateY",(function(){return Me})),r.d(i,"rotateZ",(function(){return we})),r.d(i,"angle",(function(){return Te})),r.d(i,"zero",(function(){return Ae})),r.d(i,"str",(function(){return Se})),r.d(i,"exactEquals",(function(){return Ee})),r.d(i,"equals",(function(){return Ie})),r.d(i,"sub",(function(){return Ue})),r.d(i,"mul",(function(){return Ce})),r.d(i,"div",(function(){return Ne})),r.d(i,"dist",(function(){return Re})),r.d(i,"sqrDist",(function(){return Oe})),r.d(i,"len",(function(){return ke})),r.d(i,"sqrLen",(function(){return Be})),r.d(i,"forEach",(function(){return ze}));var s={};r.r(s),r.d(s,"create",(function(){return Le})),r.d(s,"clone",(function(){return De})),r.d(s,"fromValues",(function(){return Pe})),r.d(s,"copy",(function(){return Ve})),r.d(s,"set",(function(){return je})),r.d(s,"add",(function(){return Ge})),r.d(s,"subtract",(function(){return qe})),r.d(s,"multiply",(function(){return We})),r.d(s,"divide",(function(){return He})),r.d(s,"ceil",(function(){return Xe})),r.d(s,"floor",(function(){return Ye})),r.d(s,"min",(function(){return $e})),r.d(s,"max",(function(){return Ze})),r.d(s,"round",(function(){return Je})),r.d(s,"scale",(function(){return Ke})),r.d(s,"scaleAndAdd",(function(){return Qe})),r.d(s,"distance",(function(){return tr})),r.d(s,"squaredDistance",(function(){return er})),r.d(s,"length",(function(){return rr})),r.d(s,"squaredLength",(function(){return nr})),r.d(s,"negate",(function(){return ir})),r.d(s,"inverse",(function(){return sr})),r.d(s,"normalize",(function(){return ar})),r.d(s,"dot",(function(){return or})),r.d(s,"cross",(function(){return ur})),r.d(s,"lerp",(function(){return hr})),r.d(s,"random",(function(){return cr})),r.d(s,"transformMat4",(function(){return lr})),r.d(s,"transformQuat",(function(){return fr})),r.d(s,"zero",(function(){return dr})),r.d(s,"str",(function(){return mr})),r.d(s,"exactEquals",(function(){return pr})),r.d(s,"equals",(function(){return gr})),r.d(s,"sub",(function(){return vr})),r.d(s,"mul",(function(){return yr})),r.d(s,"div",(function(){return _r})),r.d(s,"dist",(function(){return xr})),r.d(s,"sqrDist",(function(){return br})),r.d(s,"len",(function(){return Mr})),r.d(s,"sqrLen",(function(){return wr})),r.d(s,"forEach",(function(){return Tr}));var a={};r.r(a),r.d(a,"create",(function(){return Ar})),r.d(a,"identity",(function(){return Sr})),r.d(a,"setAxisAngle",(function(){return Er})),r.d(a,"getAxisAngle",(function(){return Ir})),r.d(a,"getAngle",(function(){return Fr})),r.d(a,"multiply",(function(){return Ur})),r.d(a,"rotateX",(function(){return Cr})),r.d(a,"rotateY",(function(){return Nr})),r.d(a,"rotateZ",(function(){return Rr})),r.d(a,"calculateW",(function(){return Or})),r.d(a,"exp",(function(){return kr})),r.d(a,"ln",(function(){return Br})),r.d(a,"pow",(function(){return zr})),r.d(a,"slerp",(function(){return Lr})),r.d(a,"random",(function(){return Dr})),r.d(a,"invert",(function(){return Pr})),r.d(a,"conjugate",(function(){return Vr})),r.d(a,"fromMat3",(function(){return jr})),r.d(a,"fromEuler",(function(){return Gr})),r.d(a,"str",(function(){return qr})),r.d(a,"clone",(function(){return Kr})),r.d(a,"fromValues",(function(){return Qr})),r.d(a,"copy",(function(){return tn})),r.d(a,"set",(function(){return en})),r.d(a,"add",(function(){return rn})),r.d(a,"mul",(function(){return nn})),r.d(a,"scale",(function(){return sn})),r.d(a,"dot",(function(){return an})),r.d(a,"lerp",(function(){return on})),r.d(a,"length",(function(){return un})),r.d(a,"len",(function(){return hn})),r.d(a,"squaredLength",(function(){return cn})),r.d(a,"sqrLen",(function(){return ln})),r.d(a,"normalize",(function(){return fn})),r.d(a,"exactEquals",(function(){return dn})),r.d(a,"equals",(function(){return mn})),r.d(a,"rotationTo",(function(){return pn})),r.d(a,"sqlerp",(function(){return gn})),r.d(a,"setAxes",(function(){return vn}));const o="d1019e7c71cc53ae024d248b43313e933f7b239b",u=(o.slice(0,8),`https://github.com/themikelester/gfx-boilerplate/tree/${o}`);var h,c,l,f,d,m,p,g,v,y,_,x,b;function M(t){switch(t){case c.Float:return 4;case c.Float2:return 8;case c.Float3:return 12;case c.Float4:return 16;case c.Int:return 4;case c.Int2:return 8;case c.Int3:return 12;case c.Int4:return 16;case c.Uint:return 4;case c.Uint2:return 8;case c.Uint3:return 12;case c.Uint4:return 16;case c.Short:return 2;case c.Short2:return 4;case c.Short3:return 6;case c.Short4:return 8;case c.Ushort:return 2;case c.Ushort2:return 4;case c.Ushort3:return 6;case c.Ushort4:return 8;case c.Char:return 1;case c.Char2:return 2;case c.Char3:return 3;case c.Char4:return 4;case c.Uchar:return 1;case c.Uchar2:return 2;case c.Uchar3:return 3;case c.Uchar4:return 4;case c.Half:return 2;case c.Half2:return 4;case c.Half3:return 6;case c.Half4:return 8;case c.Float3x3:return 36;case c.Float4x4:return 64;default:throw new Error(`Unsupported type: ${t}`)}}!function(t){t[t.VertexArrayObject=1]="VertexArrayObject",t[t.TextureFloat=2]="TextureFloat",t[t.TextureHalf=4]="TextureHalf",t[t.TextureFloatLinearFiltering=8]="TextureFloatLinearFiltering",t[t.TextureHalfLinearFiltering=16]="TextureHalfLinearFiltering",t[t.TextureWrite=32]="TextureWrite",t[t.ShaderDerivatives=64]="ShaderDerivatives",t[t.Instancing=128]="Instancing",t[t.AnistropicFiltering=256]="AnistropicFiltering",t[t.ShaderGlsl100=512]="ShaderGlsl100",t[t.ShaderGlsl300=1024]="ShaderGlsl300"}(h||(h={})),function(t){t[t.Undefined=0]="Undefined",t[t.Float=1]="Float",t[t.Float2=2]="Float2",t[t.Float3=3]="Float3",t[t.Float4=4]="Float4",t[t.Int=5]="Int",t[t.Int2=6]="Int2",t[t.Int3=7]="Int3",t[t.Int4=8]="Int4",t[t.Uint=9]="Uint",t[t.Uint2=10]="Uint2",t[t.Uint3=11]="Uint3",t[t.Uint4=12]="Uint4",t[t.Short=13]="Short",t[t.Short2=14]="Short2",t[t.Short3=15]="Short3",t[t.Short4=16]="Short4",t[t.Ushort=17]="Ushort",t[t.Ushort2=18]="Ushort2",t[t.Ushort3=19]="Ushort3",t[t.Ushort4=20]="Ushort4",t[t.Char=21]="Char",t[t.Char2=22]="Char2",t[t.Char3=23]="Char3",t[t.Char4=24]="Char4",t[t.Uchar=25]="Uchar",t[t.Uchar2=26]="Uchar2",t[t.Uchar3=27]="Uchar3",t[t.Uchar4=28]="Uchar4",t[t.Half=29]="Half",t[t.Half2=30]="Half2",t[t.Half3=31]="Half3",t[t.Half4=32]="Half4",t[t.Float3x3=33]="Float3x3",t[t.Float3x4=34]="Float3x4",t[t.Float4x4=35]="Float4x4",t[t.Texture2D=240]="Texture2D",t[t.Texture3D=241]="Texture3D",t[t.TextureCube=242]="TextureCube",t[t.Short_Norm=256]="Short_Norm",t[t.Short2_Norm=257]="Short2_Norm",t[t.Short3_Norm=258]="Short3_Norm",t[t.Short4_Norm=259]="Short4_Norm",t[t.Ushort_Norm=260]="Ushort_Norm",t[t.Ushort2_Norm=261]="Ushort2_Norm",t[t.Ushort3_Norm=262]="Ushort3_Norm",t[t.Ushort4_Norm=263]="Ushort4_Norm",t[t.Char_Norm=264]="Char_Norm",t[t.Char2_Norm=265]="Char2_Norm",t[t.Char3_Norm=266]="Char3_Norm",t[t.Char4_Norm=267]="Char4_Norm",t[t.Uchar_Norm=268]="Uchar_Norm",t[t.Uchar2_Norm=269]="Uchar2_Norm",t[t.Uchar3_Norm=270]="Uchar3_Norm",t[t.Uchar4_Norm=271]="Uchar4_Norm"}(c||(c={})),function(t){t[t.Texture2D=240]="Texture2D",t[t.Texture3D=241]="Texture3D",t[t.TextureCube=242]="TextureCube"}(l||(l={})),function(t){t[t.Undefined=0]="Undefined",t[t.U565=1]="U565",t[t.U8=2]="U8",t[t.U8_sRGB=3]="U8_sRGB",t[t.U8x2=4]="U8x2",t[t.U8x2_sRGB=5]="U8x2_sRGB",t[t.U8x3=6]="U8x3",t[t.U8x3_sRGB=7]="U8x3_sRGB",t[t.U8x4=8]="U8x4",t[t.U8x4_sRGB=9]="U8x4_sRGB",t[t.U10_10_10_2=10]="U10_10_10_2",t[t.F11_11_10=11]="F11_11_10",t[t.F16=12]="F16",t[t.F16x2=13]="F16x2",t[t.F16x3=14]="F16x3",t[t.F16x4=15]="F16x4",t[t.F32x2=16]="F32x2",t[t.F32x3=17]="F32x3",t[t.F32x4=18]="F32x4",t[t.Depth32=19]="Depth32",t[t.Depth24Stencil8=20]="Depth24Stencil8"}(f||(f={})),function(t){t[t.Nearest=0]="Nearest",t[t.Linear=1]="Linear"}(d||(d={})),function(t){t[t.Never=0]="Never",t[t.Less=1]="Less",t[t.Equal=2]="Equal",t[t.LessEqual=3]="LessEqual",t[t.Greater=4]="Greater",t[t.NotEqual=5]="NotEqual",t[t.GreaterEqual=6]="GreaterEqual",t[t.Always=7]="Always"}(m||(m={})),function(t){t[t.Points=0]="Points",t[t.Lines=1]="Lines",t[t.LineLoop=2]="LineLoop",t[t.LineStrip=3]="LineStrip",t[t.Triangles=4]="Triangles",t[t.TriangleStrip=5]="TriangleStrip",t[t.TriangleFan=6]="TriangleFan"}(p||(p={})),function(t){t[t.Undefined=0]="Undefined",t[t.Uniform=1]="Uniform",t[t.Vertex=2]="Vertex",t[t.Index=3]="Index",t[t.Readback=4]="Readback"}(g||(g={})),function(t){t[t.Undefined=0]="Undefined",t[t.UniformBuffer=1]="UniformBuffer",t[t.Texture=2]="Texture"}(v||(v={})),function(t){t[t.None=0]="None",t[t.Static=1]="Static",t[t.Dynamic=2]="Dynamic"}(y||(y={})),function(t){t[t.None=0]="None",t[t.Back=1]="Back",t[t.Front=2]="Front"}(_||(_={})),function(t){t[t.Zero=0]="Zero",t[t.One=1]="One",t[t.Source=2]="Source",t[t.OneMinusSource=3]="OneMinusSource"}(x||(x={})),function(t){t[t.Vertex=0]="Vertex",t[t.Instance=1]="Instance"}(b||(b={}));let w;function T(t){switch(t){case w.FLOAT:return c.Float;case w.FLOAT_VEC2:return c.Float2;case w.FLOAT_VEC3:return c.Float3;case w.FLOAT_VEC4:return c.Float4;case w.INT:return c.Int;case w.INT_VEC2:return c.Int2;case w.INT_VEC3:return c.Int3;case w.INT_VEC4:return c.Int4;case w.FLOAT_MAT3:return c.Float3x3;case w.FLOAT_MAT4:return c.Float4x4;case w.SAMPLER_2D:return c.Texture2D;case w.SAMPLER_3D:return c.Texture3D;case w.SAMPLER_CUBE:return c.TextureCube;case w.UNSIGNED_INT:return c.Uint;case w.UNSIGNED_INT_VEC2:return c.Uint2;case w.UNSIGNED_INT_VEC3:return c.Uint3;case w.UNSIGNED_INT_VEC4:return c.Uint4;default:return L(`Unsupported WebGL type: ${t}`)}}function A(t){switch(255&t){case c.Float:return 1;case c.Float2:return 2;case c.Float3:return 3;case c.Float4:return 4;case c.Int:return 1;case c.Int2:return 2;case c.Int3:return 3;case c.Int4:return 4;case c.Uint:return 1;case c.Uint2:return 2;case c.Uint3:return 3;case c.Uint4:return 4;case c.Short:return 1;case c.Short2:return 2;case c.Short3:return 3;case c.Short4:return 4;case c.Ushort:return 1;case c.Ushort2:return 2;case c.Ushort3:return 3;case c.Ushort4:return 4;case c.Char:return 1;case c.Char2:return 2;case c.Char3:return 3;case c.Char4:return 4;case c.Uchar:return 1;case c.Uchar2:return 2;case c.Uchar3:return 3;case c.Uchar4:return 4;case c.Half:return 1;case c.Half2:return 2;case c.Half3:return 3;case c.Half4:return 4;default:return L(`Unsupported type: ${t}`)}}function S(t){switch(255&t){case c.Float:case c.Float2:case c.Float3:case c.Float4:return w.FLOAT;case c.Int:case c.Int2:case c.Int3:case c.Int4:return w.INT;case c.Uint:case c.Uint2:case c.Uint3:case c.Uint4:return w.UNSIGNED_INT;case c.Short:case c.Short2:case c.Short3:case c.Short4:return w.SHORT;case c.Ushort:case c.Ushort2:case c.Ushort3:case c.Ushort4:return w.UNSIGNED_SHORT;case c.Char:case c.Char2:case c.Char3:case c.Char4:return w.BYTE;case c.Uchar:case c.Uchar2:case c.Uchar3:case c.Uchar4:return w.UNSIGNED_BYTE;case c.Half:case c.Half2:case c.Half3:case c.Half4:return w.HALF_FLOAT;default:return L(`Unsupported type: ${t}`)}}function E(t){switch(t){case p.Points:return w.POINTS;case p.Lines:return w.LINES;case p.LineLoop:return w.LINE_LOOP;case p.LineStrip:return w.LINE_STRIP;case p.Triangles:return w.TRIANGLES;case p.TriangleStrip:return w.TRIANGLE_STRIP;case p.TriangleFan:return w.TRIANGLE_FAN;default:return L(`Unsupported primitive type: ${t}`)}}function I(t){switch(t){case c.Short_Norm:case c.Short2_Norm:case c.Short3_Norm:case c.Short4_Norm:case c.Ushort_Norm:case c.Ushort2_Norm:case c.Ushort3_Norm:case c.Ushort4_Norm:case c.Char_Norm:case c.Char2_Norm:case c.Char3_Norm:case c.Char4_Norm:case c.Uchar_Norm:case c.Uchar2_Norm:case c.Uchar3_Norm:case c.Uchar4_Norm:return!0;default:return!1}}function F(t){switch(t){case c.Uchar:return w.UNSIGNED_BYTE;case c.Uint:return w.UNSIGNED_INT;case c.Ushort:return w.UNSIGNED_SHORT;default:return L(`Unsupported index type: ${t}`)}}function U(t){switch(t){case l.Texture2D:return w.TEXTURE_2D;case l.Texture3D:return w.TEXTURE_3D;case l.TextureCube:return w.TEXTURE_CUBE_MAP;default:return L(`Unsupported texture type: ${t}`)}}function C(t){switch(t){case f.U565:return w.RGB;case f.U8:return w.ALPHA;case f.U8x3:case f.U8x3_sRGB:return w.RGB;case f.U8x4:case f.U8x4_sRGB:return w.RGBA;case f.F16:return w.ALPHA;case f.F16x4:case f.F32x4:return w.RGBA;case f.Depth32:return w.DEPTH_COMPONENT;case f.Depth24Stencil8:return w.DEPTH_STENCIL;default:return L(`Unsupported texel format: ${t}`)}}function N(t){switch(t){case f.U565:return w.RGB;case f.U8:case f.U8_sRGB:return w.RED;case f.U8x2:case f.U8x2_sRGB:return w.RG;case f.U8x3:case f.U8x3_sRGB:return w.RGB;case f.U8x4:case f.U8x4_sRGB:case f.U10_10_10_2:return w.RGBA;case f.F16:return w.RED;case f.F16x2:return w.RG;case f.F16x4:return w.RGBA;case f.F32x2:return w.RG;case f.F32x4:return w.RGBA;case f.F11_11_10:return w.RGB;case f.Depth32:return w.DEPTH_COMPONENT;case f.Depth24Stencil8:return w.DEPTH_STENCIL;default:return L(`Unsupported texel format: ${t}`)}}function R(t){switch(t){case f.U565:return w.RGB565;case f.U8:case f.U8_sRGB:return w.R8;case f.U8x2:case f.U8x2_sRGB:return w.RG8;case f.U8x3:case f.U8x3_sRGB:return w.RGB8;case f.U8x4:case f.U8x4_sRGB:return w.RGBA8;case f.U10_10_10_2:return w.RGB10_A2;case f.F16:return w.R16F;case f.F16x2:return w.RG16F;case f.F16x3:return w.RGB16F;case f.F16x4:return w.RGBA16F;case f.F32x2:return w.RG32F;case f.F32x3:return w.RGB32F;case f.F32x4:return w.RGBA32F;case f.Depth32:return w.DEPTH_COMPONENT32F;case f.Depth24Stencil8:return w.DEPTH24_STENCIL8;default:return L(`Unsupported texel format: ${t}`)}}function O(t){switch(t){case f.Undefined:return 0;case f.U565:return w.UNSIGNED_SHORT_5_6_5;case f.U8:case f.U8_sRGB:case f.U8x2:case f.U8x2_sRGB:case f.U8x3:case f.U8x3_sRGB:case f.U8x4:case f.U8x4_sRGB:return w.UNSIGNED_BYTE;case f.U10_10_10_2:return w.RGBA;case f.F11_11_10:return w.FLOAT;case f.F16:case f.F16x2:case f.F16x4:return w.HALF_FLOAT;case f.F32x2:case f.F32x4:case f.Depth32:return w.FLOAT;case f.Depth24Stencil8:return w.UNSIGNED_INT_24_8;default:return L(`Unsupported texel format: ${t}`)}}function k(t){switch(t){case d.Nearest:return w.NEAREST;case d.Linear:return w.LINEAR;default:return L(`Unsupported texture filter: ${t}`)}}function B(t){switch(t){case x.Zero:return w.ZERO;case x.One:return w.One;case x.Source:return w.SRC_ALPHA;case x.OneMinusSource:return w.ONE_MINUS_SRC_ALPHA;default:return L(`Unsupported blend factor: ${t}`)}}function z(t,e="Assert failed"){t||L(e)}function L(t){throw console.error(t),new Error(t)}function D(t,e){return void 0!==t?t:e}function P(t){return null!=t}function V(t){return t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageBitmap}function j(t,e,r){const n=w.createShader(e);return w.shaderSource(n,r),w.compileShader(n),n}function G(t,e,r){const n=t.vertexLayout.buffers[r],i=t.shader.reflection,s=Object.keys(n.layout);w.bindBuffer(w.ARRAY_BUFFER,e.buffer.glId);for(let t=0;t<s.length;t++){const r=n.layout[s[t]],a=i.attributes[s[t]];if(P(a))if(e.buffer){const t=S(r.type),i=I(r.type);w.enableVertexAttribArray(a.location),w.vertexAttribPointer(a.location,a.components,t,i,n.stride,r.offset+e.offset),n.stepMode===b.Instance&&(w.instancedArrays?w.instancedArrays.vertexAttribDivisorANGLE(a.location,1):w.vertexAttribDivisor(a.location,1))}else w.disableVertexAttribArray(a.location)}}function q(t){return t.type===v.Texture}class W{constructor(){this.objects=[],this.freeList=[],this.count=0}get(t){const e=this.objects[t];return z(void 0!==e,"Invalid ID"),e}create(t){if(++this.count,this.freeList.length>0){const e=this.freeList.pop();return this.objects[e]=t,e}return this.objects.push(t),this.objects.length-1}delete(t){--this.count,delete this.objects[t],this.freeList.push(t)}}class H{constructor(){this.debugEnabled=!1,this.buffers=new W,this.textures=new W,this.shaders=new W,this.renderPipelines=new W,this.resourceTables=new W,this.vertexTables=new W,this.renderPasses=new W,this.depthStencilStates=new W}initialize(t){const e={alpha:!1,antialias:!1,preserveDrawingBuffer:!1};if(w=t.getContext("webgl2",e),w||(w=t.getContext("webgl",e)),!w)return!1;this.webGlVersion=w instanceof WebGLRenderingContext?1:2,console.debug(`Initialized WebGL${this.webGlVersion} context`),this.featureFlags=function(t){let e,r=0;return(e=w.getExtension("OES_vertex_array_object"))&&(r|=h.VertexArrayObject,w.createVertexArray=e.createVertexArrayOES.bind(e),w.deleteVertexArray=e.deleteVertexArrayOES.bind(e),w.bindVertexArray=e.bindVertexArrayOES.bind(e)),(e=w.getExtension("OES_texture_half_float"))&&(r|=h.TextureHalf,w.HALF_FLOAT=e.HALF_FLOAT_OES),(e=w.getExtension("EXT_texture_filter_anisotropic")||w.getExtension("MOZ_EXT_texture_filter_anisotropic")||w.getExtension("WEBKIT_EXT_texture_filter_anisotropic"))&&(r|=h.AnistropicFiltering,w.MAX_TEXTURE_MAX_ANISOTROPY_EXT=e.MAX_TEXTURE_MAX_ANISOTROPY_EXT,w.TEXTURE_MAX_ANISOTROPY_EXT=e.TEXTURE_MAX_ANISOTROPY_EXT),w.getExtension("OES_texture_float")&&(r|=h.TextureFloat),w.getExtension("OES_texture_float_linear")&&(r|=h.TextureFloatLinearFiltering),w.getExtension("OES_texture_half_float_linear")&&(r|=h.TextureHalfLinearFiltering),w.getExtension("OES_standard_derivatives")&&(r|=h.ShaderDerivatives),w.texSubImage2D&&(r|=h.TextureWrite),(w.instancedArrays=w.getExtension("ANGLE_instanced_arrays"))&&(r|=h.Instancing),r|=h.ShaderGlsl100,t>=2&&(r|=h.VertexArrayObject,r|=h.TextureFloat,r|=h.TextureHalf,r|=h.Instancing,r|=h.ShaderGlsl300),r}(this.webGlVersion),this.defaultRenderPass=this.renderPasses.create({name:"Default",width:t.width,height:t.height}),z(0===this.defaultRenderPass),this.current={},w.clearColor(0,0,0,1);const r=new Uint8Array([0,0,0,1]),n={usage:y.Static,type:l.Texture2D,format:f.U8x4,width:1,height:1},i=this.createTexture("DefaultTexture",n,r);return this.defaultTexture=this.textures.get(i),this.isGfxFeatureSupported(h.AnistropicFiltering)&&(this.maxAnisotropy=w.getParameter(w.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),w.pixelStorei(w.UNPACK_COLORSPACE_CONVERSION_WEBGL,w.NONE),!0}isGfxFeatureSupported(t){return!!(this.featureFlags&t)}setDebugEnabled(t){this.debugEnabled=t}resize(t,e){const r=this.renderPasses.get(this.defaultRenderPass);r.width=t,r.height=e}beginFrame(){}endFrame(){}bindRenderPass(t){const e=this.renderPasses.get(t);w.bindFramebuffer(w.FRAMEBUFFER,e.glFramebuffer),w.viewport(0,0,e.width,e.height);const r=w.COLOR_BUFFER_BIT;w.clear(r)}bindPipeline(t){const e=this.renderPipelines.get(t);this.pipeline=e,this.current.shader!==e.shader&&(w.useProgram(e.shader.glProgram),this.current.shader=e.shader),e.renderFormat.blendingEnabled!=this.current.blending&&(this.current.blending=e.renderFormat.blendingEnabled,e.renderFormat.blendingEnabled?w.enable(w.BLEND):w.disable(w.BLEND)),!this.current.blending||this.current.srcBlendFactor==e.renderFormat.srcBlendFactor&&this.current.dstBlendFactor==e.renderFormat.dstBlendFactor||(this.current.srcBlendFactor=D(e.renderFormat.srcBlendFactor,x.One),this.current.dstBlendFactor=D(e.renderFormat.dstBlendFactor,x.OneMinusSource),w.blendFunc(B(this.current.srcBlendFactor),B(this.current.dstBlendFactor)))}draw(t,e,r,n,i){const s=E(t),a=F(r),o=M(r),u=this.buffers.get(e);w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,u.glId),w.drawElements(s,i,a,n*o)}drawInstanced(t,e,r,n,i,s){const a=E(t),o=F(r),u=M(r),h=this.buffers.get(e);w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,h.glId),w.instancedArrays?w.instancedArrays.drawElementsInstancedANGLE(a,i,o,n*u,s):w.drawElementsInstanced(a,i,o,n*u,s)}drawNonIndexed(t,e,r){const n=E(t);w.drawArrays(n,e,r)}setDepthStencilState(t){const e=this.depthStencilStates.get(t),r=this.current.depthStencil;r&&e.depthWriteEnabled==r.depthWriteEnabled||w.depthMask(e.depthWriteEnabled),r&&e.depthCompareFunc==r.depthCompareFunc||w.depthFunc(e.depthCompareFunc),r&&e.depthTestEnabled==r.depthTestEnabled||(e.depthTestEnabled?w.enable(w.DEPTH_TEST):w.disable(w.DEPTH_TEST)),this.current.depthStencil=e}setCullMode(t){this.current.cullMode!=t&&(this.current.cullMode=t,t==_.None?w.disable(w.CULL_FACE):(w.enable(w.CULL_FACE),w.cullFace(function(t){switch(t){case _.None:return w.NONE;case _.Back:return w.BACK;case _.Front:return w.FRONT;default:return L(`Unsupported culling mode: ${t}`)}}(t))))}createDepthStencilState(t){const e=function(t){switch(t){case m.Never:return w.NEVER;case m.Less:return w.LESS;case m.Equal:return w.EQUAL;case m.LessEqual:return w.LEQUAL;case m.Greater:return w.GREATER;case m.NotEqual:return w.NOTEQUAL;case m.GreaterEqual:return w.GEQUAL;case m.Always:return w.ALWAYS;default:return L(`Unsupported compare func: ${t}`)}}(D(t.depthCompareFunc,m.Less));return this.depthStencilStates.create({depthTestEnabled:t.depthTestEnabled,depthWriteEnabled:t.depthWriteEnabled,depthCompareFunc:e})}createVertexTable(t){const e=this.renderPipelines.get(t);let r=null;return this.isGfxFeatureSupported(h.VertexArrayObject)&&(r=w.createVertexArray()),this.vertexTables.create({pipeline:e,vao:r,buffers:[]})}removeVertexTable(t){if(this.isGfxFeatureSupported(h.VertexArrayObject)){const e=this.vertexTables.get(t);w.deleteVertexArray(e.vao)}this.vertexTables.delete(t)}createResourceTable(t){return this.resourceTables.create({layout:t,buffers:[],textures:[]})}removeResourceTable(t){this.resourceTables.delete(t)}bindVertices(t){const e=this.vertexTables.get(t);if(this.isGfxFeatureSupported(h.VertexArrayObject))w.bindVertexArray(e.vao);else for(let t=0;t<e.buffers.length;t++)G(e.pipeline,e.buffers[t],t)}bindResources(t){const e=this.resourceTables.get(t),r=this.pipeline.uniformLayout,n=this.pipeline.shader.reflection,i=this.pipeline.shader.name;for(let t=0;t<n.uniforms.length;t++){const i=n.uniforms[t],s=r[i.name],a=e.buffers[s.index].buffer.cpuBuffer;z(P(a));const o=new Float32Array(a.buffer,s.offset,i.size/4),u=this.pipeline.shader.uniformVals[i.name];if(!o.every((t,e)=>t===u[e]))switch(this.pipeline.shader.uniformVals[i.name].set(o),i.type){case c.Float:w.uniform1fv(i.location,o);break;case c.Float2:w.uniform2fv(i.location,o);break;case c.Float3:w.uniform3fv(i.location,o);break;case c.Float4:w.uniform4fv(i.location,o);break;case c.Float3x3:w.uniformMatrix3fv(i.location,!1,o);break;case c.Float4x4:w.uniformMatrix4fv(i.location,!1,o);break;default:L("Unknown shader uniform type")}}for(let t=0;t<n.textureArray.length;t++){const s=n.textureArray[t],a=r[s.name].index;void 0===e.textures[a]&&console.warn(`Shader ${i} expects texture "${s.name}" (index ${a}) to be bound`);for(let t=0;t<s.count;t++){const r=e.textures[a+t]||this.defaultTexture,n=s.location+t;w.activeTexture(w.TEXTURE0+n),w.bindTexture(r.target,r.glId)}}}setVertexBuffer(t,e,r){const n=this.vertexTables.get(t),i={buffer:this.buffers.get(r.buffer),offset:r.byteOffset||0};z(e<16),n.buffers[e]=i,this.isGfxFeatureSupported(h.VertexArrayObject)&&(w.bindVertexArray(n.vao),G(n.pipeline,i,e))}setBuffer(t,e,r){const n=this.resourceTables.get(t),i=this.buffers.get(r.buffer);n.buffers[e]={buffer:i,offset:r.byteOffset||0}}setTexture(t,e,r){const n=this.resourceTables.get(t),i=r?this.textures.get(r):null;n.textures[e]=i}setTextures(t,e,r){const n=this.resourceTables.get(t);for(let t=0;t<r.length;t++){const i=r[t]?this.textures.get(r[t]):null;n.textures[e+t]=i}}writeBufferData(t,e,r){const n=this.buffers.get(t);if(n.type===g.Uniform){const t=ArrayBuffer.isView(r)?r.buffer:r,i=new Uint8Array(t);P(n.cpuBuffer)?n.cpuBuffer.set(i,e):L("No CPU buffer assigned to uniform buffer")}else w.bindBuffer(n.target,n.glId),w.bufferSubData(n.target,e,r)}createRenderPipeline(t,e,r,n){const i=this.shaders.get(t);if(!P(i.reflection)){performance.mark("reflectStart");const t=function(t){const e={},r=[],n=[],i={};let s=0;const a=w.getProgramParameter(t,w.ACTIVE_ATTRIBUTES);z(a<16);for(let e=0;e<a;e++){const r=w.getActiveAttrib(t,e),n=T(r.type);i[r.name]={location:e,count:r.size,components:A(n),glType:S(n),type:n}}const o=w.getProgramParameter(t,w.ACTIVE_UNIFORMS);z(o<64);for(let i=0;i<o;i++){const a=w.getActiveUniform(t,i),o=T(a.type),u=a.name.replace("[0]","");if(o>=l.Texture2D&&o<=l.TextureCube){const n={name:u,count:a.size,type:o,location:s,locationGl:w.getUniformLocation(t,a.name)};s+=a.size,e[u]=n,r.push(n)}else{const e={name:u,count:a.size,type:o,size:M(o)*a.size,location:w.getUniformLocation(t,a.name)};n.push(e)}}return{attributes:i,uniforms:n,textures:e,textureArray:r,textureCount:s}}(i.glProgram),e={};for(let r=0;r<t.uniforms.length;r++){const n=t.uniforms[r];e[n.name]=new Float32Array(n.size/4)}w.useProgram(i.glProgram);const r=Object.keys(t.textures);for(let e=0;e<r.length;e++){const n=t.textures[r[e]],i=Array.from(Array(n.count).keys()).map((t,e)=>n.location+e);w.uniform1iv(n.locationGl,i)}this.current.shader=void 0,i.reflection=t,i.uniformVals=e,performance.mark("reflectEnd"),performance.measure("reflect","reflectStart","reflectEnd"),console.log(performance.getEntriesByName("reflect"))}const s=Object.keys(n),a=s.map(t=>n[t]),o=i.reflection;if(this.debugEnabled){for(const t of s){const e=n[t];e.type===v.UniformBuffer&&z(void 0!==e.layout,`A BufferLayout must be provided for UniformBuffer "${t}" in the ResourceLayout passed to createRenderPipeline()`+"to define uniform binding locations. In WebGL2/GLSL300 it may be possible to define binding locations completely within the shader")}for(let t=0;t<o.uniforms.length;t++){const e=o.uniforms[t],r=a.find(t=>!q(t)&&t.layout&&t.layout[e.name]);z(void 0!==r,`Shader '${name}' expects uniform '${e.name}' to be set in a uniform buffer`);const n=r.layout[e.name].type;if(z(n===e.type,`Shader '${name}' expects uniform '${e.name}' to be type ${e.type} but the ShaderResourceLayout specifies type ${n}`),e.count>1){const t=r.layout[e.name].count;z(void 0!==t,`Shader '${name}' expects uniform '${e.name}' to be an array but the ShaderResourceLayout specifies a scalar value`),z(t>=e.count,`Shader '${name}' expects uniform '${e.name}' to be an array of length ${e.count} but the ShaderResourceLayout specifies a length of ${t}`)}}for(let t=0;t<o.textureArray.length;t++){const e=o.textureArray[t],r=a.find((t,r)=>q(t)&&s[r]===e.name);z(void 0!==r,`Shader '${name}' expects texture '${e.name}', but it is not defined in the ShaderResourceLayout`),z((r.count||1)===e.count,`Shader '${name}' expects texture '${e.name}' to be an array of length ${e.count}, but the ResourceLayout specifies length ${r.count}`)}Object.keys(o.attributes).forEach(t=>{z(void 0!==r.buffers.find(e=>e&&void 0!==e.layout[t]),`VertexLayout does not supply attribute ${t} required by Shader '${i.name}'`)}),this.isGfxFeatureSupported(h.Instancing)||r.buffers.forEach(t=>{z(t.stepMode!==b.Instance,"Instancing is not supported by this WebGL context")})}const u={};for(let t=0;t<o.uniforms.length;t++){const e=o.uniforms[t],r=a.find(t=>!q(t)&&t.layout&&t.layout[e.name]);u[e.name]={offset:r.layout[e.name].offset,index:r.index}}for(let t=0;t<o.textureArray.length;t++){const e=o.textureArray[t],r=n[e.name];u[e.name]={offset:0,index:r.index}}return this.renderPipelines.create({shader:i,renderFormat:e,vertexLayout:r,resourceLayout:n,uniformLayout:u})}removeRenderPipeline(t){this.renderPipelines.delete(t)}createShader(t){return this._createShader(t.name,t.vertSource,t.fragSource)}_createShader(t,e,r){const n=function(t,e,r){const n=j(0,w.VERTEX_SHADER,e),i=j(0,w.FRAGMENT_SHADER,r),s=w.createProgram();return w.attachShader(s,n),w.attachShader(s,i),w.linkProgram(s),w.deleteShader(n),w.deleteShader(i),s}(0,e instanceof Array?e.join("\n#line 0\n"):e,r instanceof Array?r.join("\n#line 0\n"):r);return this.shaders.create({name:t,glProgram:n})}removeShader(t){const e=this.shaders.get(t);w.deleteProgram(e.glProgram),this.shaders.delete(t)}createTexture(t,e,r){const n=!r||r.buffer instanceof ArrayBuffer&&void 0!==r.byteLength,i=1===this.webGlVersion?C:N,s={target:U(e.type),format:i(e.format),internalFormat:this.webGlVersion>1?R(e.format):i(e.format),type:O(e.format),usage:e.usage,width:n?D(e.width,1):r.width,height:n?D(e.height,1):r.height,depth:e.depth||1,minFilter:k(void 0!==e.defaultMinFilter?e.defaultMinFilter:d.Linear),magFilter:k(void 0!==e.defaultMagFilter?e.defaultMagFilter:d.Linear),glId:w.createTexture()};if(w.bindTexture(s.target,s.glId),w.texParameteri(s.target,w.TEXTURE_MIN_FILTER,s.minFilter),w.texParameteri(s.target,w.TEXTURE_MAG_FILTER,s.magFilter),w.texParameteri(s.target,w.TEXTURE_WRAP_S,w.CLAMP_TO_EDGE),w.texParameteri(s.target,w.TEXTURE_WRAP_T,w.CLAMP_TO_EDGE),P(e.maxAnistropy)&&e.maxAnistropy>1&&this.isGfxFeatureSupported(h.AnistropicFiltering)){const t=Math.min(this.maxAnisotropy,e.maxAnistropy);w.texParameterf(w.TEXTURE_2D,w.TEXTURE_MAX_ANISOTROPY_EXT,t)}const a=this.webGlVersion>1?s.internalFormat:s.format;if(e.type===l.Texture3D)w.texImage3D(s.target,0,a,s.width,s.height,s.depth,0,s.format,s.type,r);else if(n)r instanceof ArrayBuffer&&(r=new Uint8Array(r)),w.texImage2D(s.target,0,a,s.width,s.height,0,s.format,s.type,r);else if(void 0!==r)w.texImage2D(s.target,0,a,s.format,s.type,r);else{z(void 0!==s.width&&void 0!==s.height,"Image is null. If attempting to create an empty texture, width and height must be specified"),w.texImage2D(s.target,0,a,e.width,e.height,0,s.format,s.type,null)}return this.textures.create(s)}writeTextureData(t,e){const r=this.textures.get(t);z(r.target===w.TEXTURE_2D,"Currently only 2D textures may be written to"),w.bindTexture(r.target,r.glId);const n=V(e)?e.width!==r.width:!!V(e)&&e.height!==r.height;this.isGfxFeatureSupported(h.TextureWrite)&&!n?V(e)?w.texSubImage2D(r.target,0,0,0,r.format,r.type,e):w.texSubImage2D(r.target,0,0,0,r.width,r.height,r.format,r.type,e):w.texImage2D(r.target,0,r.internalFormat,r.format,r.type,e)}removeTexture(t){const e=this.textures.get(t);w.deleteTexture(e.glId),this.textures.delete(t)}createBuffer(t,e,r,n){let i,s;z(r!=y.None);const a=function(t){switch(t){case g.Undefined:return 0;case g.Uniform:return w.UNIFORM_BUFFER;case g.Vertex:return w.ARRAY_BUFFER;case g.Index:return w.ELEMENT_ARRAY_BUFFER;case g.Readback:return w.TRANSFORM_FEEDBACK_BUFFER}}(e),o=t=>Number.isInteger(t),u=t=>t instanceof ArrayBuffer,h=o(n)?null:n,c=o(n)?n:n.byteLength;if(z(c>0||null!==h,"Either an ArrayBuffer or size must be provided"),e!=g.Uniform)s=w.createBuffer(),w.bindBuffer(a,s),w.bufferData(a,n,r==y.Dynamic?w.DYNAMIC_DRAW:w.STATIC_DRAW);else if(h){const t=u(h)?h:h.buffer,e=u(h)?0:h.byteOffset;i=new Uint8Array(t,e,c)}else i=new Uint8Array(c);return this.buffers.create({name:t,type:e,target:a,usage:r,size:c,glId:s,cpuBuffer:i})}removeBuffer(t){const e=this.buffers.get(t);e.type!=g.Uniform&&w.deleteBuffer(e.glId),this.buffers.delete(t)}readPixels(t,e,r,n,i){w.readPixels(t,e,r,n,w.RGBA,w.UNSIGNED_BYTE,i)}}var X=1e-6,Y="undefined"!=typeof Float32Array?Float32Array:Array,$=Math.random;Math.PI;function Z(){var t=new Y(16);return Y!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function J(t){var e=new Y(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function K(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Q(t,e,r,n,i,s,a,o,u,h,c,l,f,d,m,p){var g=new Y(16);return g[0]=t,g[1]=e,g[2]=r,g[3]=n,g[4]=i,g[5]=s,g[6]=a,g[7]=o,g[8]=u,g[9]=h,g[10]=c,g[11]=l,g[12]=f,g[13]=d,g[14]=m,g[15]=p,g}function tt(t,e,r,n,i,s,a,o,u,h,c,l,f,d,m,p,g){return t[0]=e,t[1]=r,t[2]=n,t[3]=i,t[4]=s,t[5]=a,t[6]=o,t[7]=u,t[8]=h,t[9]=c,t[10]=l,t[11]=f,t[12]=d,t[13]=m,t[14]=p,t[15]=g,t}function et(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function rt(t,e){if(t===e){var r=e[1],n=e[2],i=e[3],s=e[6],a=e[7],o=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=n,t[9]=s,t[11]=e[14],t[12]=i,t[13]=a,t[14]=o}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function nt(t,e){var r=e[0],n=e[1],i=e[2],s=e[3],a=e[4],o=e[5],u=e[6],h=e[7],c=e[8],l=e[9],f=e[10],d=e[11],m=e[12],p=e[13],g=e[14],v=e[15],y=r*o-n*a,_=r*u-i*a,x=r*h-s*a,b=n*u-i*o,M=n*h-s*o,w=i*h-s*u,T=c*p-l*m,A=c*g-f*m,S=c*v-d*m,E=l*g-f*p,I=l*v-d*p,F=f*v-d*g,U=y*F-_*I+x*E+b*S-M*A+w*T;return U?(U=1/U,t[0]=(o*F-u*I+h*E)*U,t[1]=(i*I-n*F-s*E)*U,t[2]=(p*w-g*M+v*b)*U,t[3]=(f*M-l*w-d*b)*U,t[4]=(u*S-a*F-h*A)*U,t[5]=(r*F-i*S+s*A)*U,t[6]=(g*x-m*w-v*_)*U,t[7]=(c*w-f*x+d*_)*U,t[8]=(a*I-o*S+h*T)*U,t[9]=(n*S-r*I-s*T)*U,t[10]=(m*M-p*x+v*y)*U,t[11]=(l*x-c*M-d*y)*U,t[12]=(o*A-a*E-u*T)*U,t[13]=(r*E-n*A+i*T)*U,t[14]=(p*_-m*b-g*y)*U,t[15]=(c*b-l*_+f*y)*U,t):null}function it(t,e){var r=e[0],n=e[1],i=e[2],s=e[3],a=e[4],o=e[5],u=e[6],h=e[7],c=e[8],l=e[9],f=e[10],d=e[11],m=e[12],p=e[13],g=e[14],v=e[15];return t[0]=o*(f*v-d*g)-l*(u*v-h*g)+p*(u*d-h*f),t[1]=-(n*(f*v-d*g)-l*(i*v-s*g)+p*(i*d-s*f)),t[2]=n*(u*v-h*g)-o*(i*v-s*g)+p*(i*h-s*u),t[3]=-(n*(u*d-h*f)-o*(i*d-s*f)+l*(i*h-s*u)),t[4]=-(a*(f*v-d*g)-c*(u*v-h*g)+m*(u*d-h*f)),t[5]=r*(f*v-d*g)-c*(i*v-s*g)+m*(i*d-s*f),t[6]=-(r*(u*v-h*g)-a*(i*v-s*g)+m*(i*h-s*u)),t[7]=r*(u*d-h*f)-a*(i*d-s*f)+c*(i*h-s*u),t[8]=a*(l*v-d*p)-c*(o*v-h*p)+m*(o*d-h*l),t[9]=-(r*(l*v-d*p)-c*(n*v-s*p)+m*(n*d-s*l)),t[10]=r*(o*v-h*p)-a*(n*v-s*p)+m*(n*h-s*o),t[11]=-(r*(o*d-h*l)-a*(n*d-s*l)+c*(n*h-s*o)),t[12]=-(a*(l*g-f*p)-c*(o*g-u*p)+m*(o*f-u*l)),t[13]=r*(l*g-f*p)-c*(n*g-i*p)+m*(n*f-i*l),t[14]=-(r*(o*g-u*p)-a*(n*g-i*p)+m*(n*u-i*o)),t[15]=r*(o*f-u*l)-a*(n*f-i*l)+c*(n*u-i*o),t}function st(t){var e=t[0],r=t[1],n=t[2],i=t[3],s=t[4],a=t[5],o=t[6],u=t[7],h=t[8],c=t[9],l=t[10],f=t[11],d=t[12],m=t[13],p=t[14],g=t[15];return(e*a-r*s)*(l*g-f*p)-(e*o-n*s)*(c*g-f*m)+(e*u-i*s)*(c*p-l*m)+(r*o-n*a)*(h*g-f*d)-(r*u-i*a)*(h*p-l*d)+(n*u-i*o)*(h*m-c*d)}function at(t,e,r){var n=e[0],i=e[1],s=e[2],a=e[3],o=e[4],u=e[5],h=e[6],c=e[7],l=e[8],f=e[9],d=e[10],m=e[11],p=e[12],g=e[13],v=e[14],y=e[15],_=r[0],x=r[1],b=r[2],M=r[3];return t[0]=_*n+x*o+b*l+M*p,t[1]=_*i+x*u+b*f+M*g,t[2]=_*s+x*h+b*d+M*v,t[3]=_*a+x*c+b*m+M*y,_=r[4],x=r[5],b=r[6],M=r[7],t[4]=_*n+x*o+b*l+M*p,t[5]=_*i+x*u+b*f+M*g,t[6]=_*s+x*h+b*d+M*v,t[7]=_*a+x*c+b*m+M*y,_=r[8],x=r[9],b=r[10],M=r[11],t[8]=_*n+x*o+b*l+M*p,t[9]=_*i+x*u+b*f+M*g,t[10]=_*s+x*h+b*d+M*v,t[11]=_*a+x*c+b*m+M*y,_=r[12],x=r[13],b=r[14],M=r[15],t[12]=_*n+x*o+b*l+M*p,t[13]=_*i+x*u+b*f+M*g,t[14]=_*s+x*h+b*d+M*v,t[15]=_*a+x*c+b*m+M*y,t}function ot(t,e,r){var n,i,s,a,o,u,h,c,l,f,d,m,p=r[0],g=r[1],v=r[2];return e===t?(t[12]=e[0]*p+e[4]*g+e[8]*v+e[12],t[13]=e[1]*p+e[5]*g+e[9]*v+e[13],t[14]=e[2]*p+e[6]*g+e[10]*v+e[14],t[15]=e[3]*p+e[7]*g+e[11]*v+e[15]):(n=e[0],i=e[1],s=e[2],a=e[3],o=e[4],u=e[5],h=e[6],c=e[7],l=e[8],f=e[9],d=e[10],m=e[11],t[0]=n,t[1]=i,t[2]=s,t[3]=a,t[4]=o,t[5]=u,t[6]=h,t[7]=c,t[8]=l,t[9]=f,t[10]=d,t[11]=m,t[12]=n*p+o*g+l*v+e[12],t[13]=i*p+u*g+f*v+e[13],t[14]=s*p+h*g+d*v+e[14],t[15]=a*p+c*g+m*v+e[15]),t}function ut(t,e,r){var n=r[0],i=r[1],s=r[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*s,t[9]=e[9]*s,t[10]=e[10]*s,t[11]=e[11]*s,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function ht(t,e,r,n){var i,s,a,o,u,h,c,l,f,d,m,p,g,v,y,_,x,b,M,w,T,A,S,E,I=n[0],F=n[1],U=n[2],C=Math.hypot(I,F,U);return C<X?null:(I*=C=1/C,F*=C,U*=C,i=Math.sin(r),a=1-(s=Math.cos(r)),o=e[0],u=e[1],h=e[2],c=e[3],l=e[4],f=e[5],d=e[6],m=e[7],p=e[8],g=e[9],v=e[10],y=e[11],_=I*I*a+s,x=F*I*a+U*i,b=U*I*a-F*i,M=I*F*a-U*i,w=F*F*a+s,T=U*F*a+I*i,A=I*U*a+F*i,S=F*U*a-I*i,E=U*U*a+s,t[0]=o*_+l*x+p*b,t[1]=u*_+f*x+g*b,t[2]=h*_+d*x+v*b,t[3]=c*_+m*x+y*b,t[4]=o*M+l*w+p*T,t[5]=u*M+f*w+g*T,t[6]=h*M+d*w+v*T,t[7]=c*M+m*w+y*T,t[8]=o*A+l*S+p*E,t[9]=u*A+f*S+g*E,t[10]=h*A+d*S+v*E,t[11]=c*A+m*S+y*E,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function ct(t,e,r){var n=Math.sin(r),i=Math.cos(r),s=e[4],a=e[5],o=e[6],u=e[7],h=e[8],c=e[9],l=e[10],f=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=s*i+h*n,t[5]=a*i+c*n,t[6]=o*i+l*n,t[7]=u*i+f*n,t[8]=h*i-s*n,t[9]=c*i-a*n,t[10]=l*i-o*n,t[11]=f*i-u*n,t}function lt(t,e,r){var n=Math.sin(r),i=Math.cos(r),s=e[0],a=e[1],o=e[2],u=e[3],h=e[8],c=e[9],l=e[10],f=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*i-h*n,t[1]=a*i-c*n,t[2]=o*i-l*n,t[3]=u*i-f*n,t[8]=s*n+h*i,t[9]=a*n+c*i,t[10]=o*n+l*i,t[11]=u*n+f*i,t}function ft(t,e,r){var n=Math.sin(r),i=Math.cos(r),s=e[0],a=e[1],o=e[2],u=e[3],h=e[4],c=e[5],l=e[6],f=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*i+h*n,t[1]=a*i+c*n,t[2]=o*i+l*n,t[3]=u*i+f*n,t[4]=h*i-s*n,t[5]=c*i-a*n,t[6]=l*i-o*n,t[7]=f*i-u*n,t}function dt(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function mt(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function pt(t,e,r){var n,i,s,a=r[0],o=r[1],u=r[2],h=Math.hypot(a,o,u);return h<X?null:(a*=h=1/h,o*=h,u*=h,n=Math.sin(e),s=1-(i=Math.cos(e)),t[0]=a*a*s+i,t[1]=o*a*s+u*n,t[2]=u*a*s-o*n,t[3]=0,t[4]=a*o*s-u*n,t[5]=o*o*s+i,t[6]=u*o*s+a*n,t[7]=0,t[8]=a*u*s+o*n,t[9]=o*u*s-a*n,t[10]=u*u*s+i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function gt(t,e){var r=Math.sin(e),n=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=r,t[7]=0,t[8]=0,t[9]=-r,t[10]=n,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function vt(t,e){var r=Math.sin(e),n=Math.cos(e);return t[0]=n,t[1]=0,t[2]=-r,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=r,t[9]=0,t[10]=n,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function yt(t,e){var r=Math.sin(e),n=Math.cos(e);return t[0]=n,t[1]=r,t[2]=0,t[3]=0,t[4]=-r,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function _t(t,e,r){var n=e[0],i=e[1],s=e[2],a=e[3],o=n+n,u=i+i,h=s+s,c=n*o,l=n*u,f=n*h,d=i*u,m=i*h,p=s*h,g=a*o,v=a*u,y=a*h;return t[0]=1-(d+p),t[1]=l+y,t[2]=f-v,t[3]=0,t[4]=l-y,t[5]=1-(c+p),t[6]=m+g,t[7]=0,t[8]=f+v,t[9]=m-g,t[10]=1-(c+d),t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function xt(t,e){var r=new Y(3),n=-e[0],i=-e[1],s=-e[2],a=e[3],o=e[4],u=e[5],h=e[6],c=e[7],l=n*n+i*i+s*s+a*a;return l>0?(r[0]=2*(o*a+c*n+u*s-h*i)/l,r[1]=2*(u*a+c*i+h*n-o*s)/l,r[2]=2*(h*a+c*s+o*i-u*n)/l):(r[0]=2*(o*a+c*n+u*s-h*i),r[1]=2*(u*a+c*i+h*n-o*s),r[2]=2*(h*a+c*s+o*i-u*n)),_t(t,e,r),t}function bt(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function Mt(t,e){var r=e[0],n=e[1],i=e[2],s=e[4],a=e[5],o=e[6],u=e[8],h=e[9],c=e[10];return t[0]=Math.hypot(r,n,i),t[1]=Math.hypot(s,a,o),t[2]=Math.hypot(u,h,c),t}function wt(t,e){var r=new Y(3);Mt(r,e);var n=1/r[0],i=1/r[1],s=1/r[2],a=e[0]*n,o=e[1]*i,u=e[2]*s,h=e[4]*n,c=e[5]*i,l=e[6]*s,f=e[8]*n,d=e[9]*i,m=e[10]*s,p=a+c+m,g=0;return p>0?(g=2*Math.sqrt(p+1),t[3]=.25*g,t[0]=(l-d)/g,t[1]=(f-u)/g,t[2]=(o-h)/g):a>c&&a>m?(g=2*Math.sqrt(1+a-c-m),t[3]=(l-d)/g,t[0]=.25*g,t[1]=(o+h)/g,t[2]=(f+u)/g):c>m?(g=2*Math.sqrt(1+c-a-m),t[3]=(f-u)/g,t[0]=(o+h)/g,t[1]=.25*g,t[2]=(l+d)/g):(g=2*Math.sqrt(1+m-a-c),t[3]=(o-h)/g,t[0]=(f+u)/g,t[1]=(l+d)/g,t[2]=.25*g),t}function Tt(t,e,r,n){var i=e[0],s=e[1],a=e[2],o=e[3],u=i+i,h=s+s,c=a+a,l=i*u,f=i*h,d=i*c,m=s*h,p=s*c,g=a*c,v=o*u,y=o*h,_=o*c,x=n[0],b=n[1],M=n[2];return t[0]=(1-(m+g))*x,t[1]=(f+_)*x,t[2]=(d-y)*x,t[3]=0,t[4]=(f-_)*b,t[5]=(1-(l+g))*b,t[6]=(p+v)*b,t[7]=0,t[8]=(d+y)*M,t[9]=(p-v)*M,t[10]=(1-(l+m))*M,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function At(t,e,r,n,i){var s=e[0],a=e[1],o=e[2],u=e[3],h=s+s,c=a+a,l=o+o,f=s*h,d=s*c,m=s*l,p=a*c,g=a*l,v=o*l,y=u*h,_=u*c,x=u*l,b=n[0],M=n[1],w=n[2],T=i[0],A=i[1],S=i[2],E=(1-(p+v))*b,I=(d+x)*b,F=(m-_)*b,U=(d-x)*M,C=(1-(f+v))*M,N=(g+y)*M,R=(m+_)*w,O=(g-y)*w,k=(1-(f+p))*w;return t[0]=E,t[1]=I,t[2]=F,t[3]=0,t[4]=U,t[5]=C,t[6]=N,t[7]=0,t[8]=R,t[9]=O,t[10]=k,t[11]=0,t[12]=r[0]+T-(E*T+U*A+R*S),t[13]=r[1]+A-(I*T+C*A+O*S),t[14]=r[2]+S-(F*T+N*A+k*S),t[15]=1,t}function St(t,e){var r=e[0],n=e[1],i=e[2],s=e[3],a=r+r,o=n+n,u=i+i,h=r*a,c=n*a,l=n*o,f=i*a,d=i*o,m=i*u,p=s*a,g=s*o,v=s*u;return t[0]=1-l-m,t[1]=c+v,t[2]=f-g,t[3]=0,t[4]=c-v,t[5]=1-h-m,t[6]=d+p,t[7]=0,t[8]=f+g,t[9]=d-p,t[10]=1-h-l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Et(t,e,r,n,i,s,a){var o=1/(r-e),u=1/(i-n),h=1/(s-a);return t[0]=2*s*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*s*u,t[6]=0,t[7]=0,t[8]=(r+e)*o,t[9]=(i+n)*u,t[10]=(a+s)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*s*2*h,t[15]=0,t}function It(t,e,r,n,i){var s,a=1/Math.tan(e/2);return t[0]=a/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=i&&i!==1/0?(s=1/(n-i),t[10]=(i+n)*s,t[14]=2*i*n*s):(t[10]=-1,t[14]=-2*n),t}function Ft(t,e,r,n){var i=Math.tan(e.upDegrees*Math.PI/180),s=Math.tan(e.downDegrees*Math.PI/180),a=Math.tan(e.leftDegrees*Math.PI/180),o=Math.tan(e.rightDegrees*Math.PI/180),u=2/(a+o),h=2/(i+s);return t[0]=u,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=h,t[6]=0,t[7]=0,t[8]=-(a-o)*u*.5,t[9]=(i-s)*h*.5,t[10]=n/(r-n),t[11]=-1,t[12]=0,t[13]=0,t[14]=n*r/(r-n),t[15]=0,t}function Ut(t,e,r,n,i,s,a){var o=1/(e-r),u=1/(n-i),h=1/(s-a);return t[0]=-2*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+r)*o,t[13]=(i+n)*u,t[14]=(a+s)*h,t[15]=1,t}function Ct(t,e,r,n){var i,s,a,o,u,h,c,l,f,d,m=e[0],p=e[1],g=e[2],v=n[0],y=n[1],_=n[2],x=r[0],b=r[1],M=r[2];return Math.abs(m-x)<X&&Math.abs(p-b)<X&&Math.abs(g-M)<X?et(t):(c=m-x,l=p-b,f=g-M,i=y*(f*=d=1/Math.hypot(c,l,f))-_*(l*=d),s=_*(c*=d)-v*f,a=v*l-y*c,(d=Math.hypot(i,s,a))?(i*=d=1/d,s*=d,a*=d):(i=0,s=0,a=0),o=l*a-f*s,u=f*i-c*a,h=c*s-l*i,(d=Math.hypot(o,u,h))?(o*=d=1/d,u*=d,h*=d):(o=0,u=0,h=0),t[0]=i,t[1]=o,t[2]=c,t[3]=0,t[4]=s,t[5]=u,t[6]=l,t[7]=0,t[8]=a,t[9]=h,t[10]=f,t[11]=0,t[12]=-(i*m+s*p+a*g),t[13]=-(o*m+u*p+h*g),t[14]=-(c*m+l*p+f*g),t[15]=1,t)}function Nt(t,e,r,n){var i=e[0],s=e[1],a=e[2],o=n[0],u=n[1],h=n[2],c=i-r[0],l=s-r[1],f=a-r[2],d=c*c+l*l+f*f;d>0&&(c*=d=1/Math.sqrt(d),l*=d,f*=d);var m=u*f-h*l,p=h*c-o*f,g=o*l-u*c;return(d=m*m+p*p+g*g)>0&&(m*=d=1/Math.sqrt(d),p*=d,g*=d),t[0]=m,t[1]=p,t[2]=g,t[3]=0,t[4]=l*g-f*p,t[5]=f*m-c*g,t[6]=c*p-l*m,t[7]=0,t[8]=c,t[9]=l,t[10]=f,t[11]=0,t[12]=i,t[13]=s,t[14]=a,t[15]=1,t}function Rt(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"}function Ot(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}function kt(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t[9]=e[9]+r[9],t[10]=e[10]+r[10],t[11]=e[11]+r[11],t[12]=e[12]+r[12],t[13]=e[13]+r[13],t[14]=e[14]+r[14],t[15]=e[15]+r[15],t}function Bt(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t[9]=e[9]-r[9],t[10]=e[10]-r[10],t[11]=e[11]-r[11],t[12]=e[12]-r[12],t[13]=e[13]-r[13],t[14]=e[14]-r[14],t[15]=e[15]-r[15],t}function zt(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t[9]=e[9]*r,t[10]=e[10]*r,t[11]=e[11]*r,t[12]=e[12]*r,t[13]=e[13]*r,t[14]=e[14]*r,t[15]=e[15]*r,t}function Lt(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t[3]=e[3]+r[3]*n,t[4]=e[4]+r[4]*n,t[5]=e[5]+r[5]*n,t[6]=e[6]+r[6]*n,t[7]=e[7]+r[7]*n,t[8]=e[8]+r[8]*n,t[9]=e[9]+r[9]*n,t[10]=e[10]+r[10]*n,t[11]=e[11]+r[11]*n,t[12]=e[12]+r[12]*n,t[13]=e[13]+r[13]*n,t[14]=e[14]+r[14]*n,t[15]=e[15]+r[15]*n,t}function Dt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function Pt(t,e){var r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],o=t[5],u=t[6],h=t[7],c=t[8],l=t[9],f=t[10],d=t[11],m=t[12],p=t[13],g=t[14],v=t[15],y=e[0],_=e[1],x=e[2],b=e[3],M=e[4],w=e[5],T=e[6],A=e[7],S=e[8],E=e[9],I=e[10],F=e[11],U=e[12],C=e[13],N=e[14],R=e[15];return Math.abs(r-y)<=X*Math.max(1,Math.abs(r),Math.abs(y))&&Math.abs(n-_)<=X*Math.max(1,Math.abs(n),Math.abs(_))&&Math.abs(i-x)<=X*Math.max(1,Math.abs(i),Math.abs(x))&&Math.abs(s-b)<=X*Math.max(1,Math.abs(s),Math.abs(b))&&Math.abs(a-M)<=X*Math.max(1,Math.abs(a),Math.abs(M))&&Math.abs(o-w)<=X*Math.max(1,Math.abs(o),Math.abs(w))&&Math.abs(u-T)<=X*Math.max(1,Math.abs(u),Math.abs(T))&&Math.abs(h-A)<=X*Math.max(1,Math.abs(h),Math.abs(A))&&Math.abs(c-S)<=X*Math.max(1,Math.abs(c),Math.abs(S))&&Math.abs(l-E)<=X*Math.max(1,Math.abs(l),Math.abs(E))&&Math.abs(f-I)<=X*Math.max(1,Math.abs(f),Math.abs(I))&&Math.abs(d-F)<=X*Math.max(1,Math.abs(d),Math.abs(F))&&Math.abs(m-U)<=X*Math.max(1,Math.abs(m),Math.abs(U))&&Math.abs(p-C)<=X*Math.max(1,Math.abs(p),Math.abs(C))&&Math.abs(g-N)<=X*Math.max(1,Math.abs(g),Math.abs(N))&&Math.abs(v-R)<=X*Math.max(1,Math.abs(v),Math.abs(R))}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var Vt=at,jt=Bt;function Gt(){var t=new Y(3);return Y!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function qt(t){var e=new Y(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function Wt(t){var e=t[0],r=t[1],n=t[2];return Math.hypot(e,r,n)}function Ht(t,e,r){var n=new Y(3);return n[0]=t,n[1]=e,n[2]=r,n}function Xt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function Yt(t,e,r,n){return t[0]=e,t[1]=r,t[2]=n,t}function $t(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t}function Zt(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function Jt(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t}function Kt(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t}function Qt(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t}function te(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t}function ee(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t}function re(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t}function ne(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t}function ie(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function se(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t}function ae(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2];return Math.hypot(r,n,i)}function oe(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2];return r*r+n*n+i*i}function ue(t){var e=t[0],r=t[1],n=t[2];return e*e+r*r+n*n}function he(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function ce(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t}function le(t,e){var r=e[0],n=e[1],i=e[2],s=r*r+n*n+i*i;return s>0&&(s=1/Math.sqrt(s)),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t}function fe(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function de(t,e,r){var n=e[0],i=e[1],s=e[2],a=r[0],o=r[1],u=r[2];return t[0]=i*u-s*o,t[1]=s*a-n*u,t[2]=n*o-i*a,t}function me(t,e,r,n){var i=e[0],s=e[1],a=e[2];return t[0]=i+n*(r[0]-i),t[1]=s+n*(r[1]-s),t[2]=a+n*(r[2]-a),t}function pe(t,e,r,n,i,s){var a=s*s,o=a*(2*s-3)+1,u=a*(s-2)+s,h=a*(s-1),c=a*(3-2*s);return t[0]=e[0]*o+r[0]*u+n[0]*h+i[0]*c,t[1]=e[1]*o+r[1]*u+n[1]*h+i[1]*c,t[2]=e[2]*o+r[2]*u+n[2]*h+i[2]*c,t}function ge(t,e,r,n,i,s){var a=1-s,o=a*a,u=s*s,h=o*a,c=3*s*o,l=3*u*a,f=u*s;return t[0]=e[0]*h+r[0]*c+n[0]*l+i[0]*f,t[1]=e[1]*h+r[1]*c+n[1]*l+i[1]*f,t[2]=e[2]*h+r[2]*c+n[2]*l+i[2]*f,t}function ve(t,e){e=e||1;var r=2*$()*Math.PI,n=2*$()-1,i=Math.sqrt(1-n*n)*e;return t[0]=Math.cos(r)*i,t[1]=Math.sin(r)*i,t[2]=n*e,t}function ye(t,e,r){var n=e[0],i=e[1],s=e[2],a=r[3]*n+r[7]*i+r[11]*s+r[15];return a=a||1,t[0]=(r[0]*n+r[4]*i+r[8]*s+r[12])/a,t[1]=(r[1]*n+r[5]*i+r[9]*s+r[13])/a,t[2]=(r[2]*n+r[6]*i+r[10]*s+r[14])/a,t}function _e(t,e,r){var n=e[0],i=e[1],s=e[2];return t[0]=n*r[0]+i*r[3]+s*r[6],t[1]=n*r[1]+i*r[4]+s*r[7],t[2]=n*r[2]+i*r[5]+s*r[8],t}function xe(t,e,r){var n=r[0],i=r[1],s=r[2],a=r[3],o=e[0],u=e[1],h=e[2],c=i*h-s*u,l=s*o-n*h,f=n*u-i*o,d=i*f-s*l,m=s*c-n*f,p=n*l-i*c,g=2*a;return c*=g,l*=g,f*=g,d*=2,m*=2,p*=2,t[0]=o+c+d,t[1]=u+l+m,t[2]=h+f+p,t}function be(t,e,r,n){var i=[],s=[];return i[0]=e[0]-r[0],i[1]=e[1]-r[1],i[2]=e[2]-r[2],s[0]=i[0],s[1]=i[1]*Math.cos(n)-i[2]*Math.sin(n),s[2]=i[1]*Math.sin(n)+i[2]*Math.cos(n),t[0]=s[0]+r[0],t[1]=s[1]+r[1],t[2]=s[2]+r[2],t}function Me(t,e,r,n){var i=[],s=[];return i[0]=e[0]-r[0],i[1]=e[1]-r[1],i[2]=e[2]-r[2],s[0]=i[2]*Math.sin(n)+i[0]*Math.cos(n),s[1]=i[1],s[2]=i[2]*Math.cos(n)-i[0]*Math.sin(n),t[0]=s[0]+r[0],t[1]=s[1]+r[1],t[2]=s[2]+r[2],t}function we(t,e,r,n){var i=[],s=[];return i[0]=e[0]-r[0],i[1]=e[1]-r[1],i[2]=e[2]-r[2],s[0]=i[0]*Math.cos(n)-i[1]*Math.sin(n),s[1]=i[0]*Math.sin(n)+i[1]*Math.cos(n),s[2]=i[2],t[0]=s[0]+r[0],t[1]=s[1]+r[1],t[2]=s[2]+r[2],t}function Te(t,e){var r=t[0],n=t[1],i=t[2],s=e[0],a=e[1],o=e[2],u=Math.sqrt(r*r+n*n+i*i)*Math.sqrt(s*s+a*a+o*o),h=u&&fe(t,e)/u;return Math.acos(Math.min(Math.max(h,-1),1))}function Ae(t){return t[0]=0,t[1]=0,t[2]=0,t}function Se(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"}function Ee(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function Ie(t,e){var r=t[0],n=t[1],i=t[2],s=e[0],a=e[1],o=e[2];return Math.abs(r-s)<=X*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(n-a)<=X*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(i-o)<=X*Math.max(1,Math.abs(i),Math.abs(o))}var Fe,Ue=Zt,Ce=Jt,Ne=Kt,Re=ae,Oe=oe,ke=Wt,Be=ue,ze=(Fe=Gt(),function(t,e,r,n,i,s){var a,o;for(e||(e=3),r||(r=0),o=n?Math.min(n*e+r,t.length):t.length,a=r;a<o;a+=e)Fe[0]=t[a],Fe[1]=t[a+1],Fe[2]=t[a+2],i(Fe,Fe,s),t[a]=Fe[0],t[a+1]=Fe[1],t[a+2]=Fe[2];return t});function Le(){var t=new Y(4);return Y!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function De(t){var e=new Y(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function Pe(t,e,r,n){var i=new Y(4);return i[0]=t,i[1]=e,i[2]=r,i[3]=n,i}function Ve(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function je(t,e,r,n,i){return t[0]=e,t[1]=r,t[2]=n,t[3]=i,t}function Ge(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t}function qe(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}function We(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t[3]=e[3]*r[3],t}function He(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t[3]=e[3]/r[3],t}function Xe(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t}function Ye(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t}function $e(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t[3]=Math.min(e[3],r[3]),t}function Ze(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t[3]=Math.max(e[3],r[3]),t}function Je(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t}function Ke(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t}function Qe(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t[3]=e[3]+r[3]*n,t}function tr(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2],s=e[3]-t[3];return Math.hypot(r,n,i,s)}function er(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2],s=e[3]-t[3];return r*r+n*n+i*i+s*s}function rr(t){var e=t[0],r=t[1],n=t[2],i=t[3];return Math.hypot(e,r,n,i)}function nr(t){var e=t[0],r=t[1],n=t[2],i=t[3];return e*e+r*r+n*n+i*i}function ir(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function sr(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t}function ar(t,e){var r=e[0],n=e[1],i=e[2],s=e[3],a=r*r+n*n+i*i+s*s;return a>0&&(a=1/Math.sqrt(a)),t[0]=r*a,t[1]=n*a,t[2]=i*a,t[3]=s*a,t}function or(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function ur(t,e,r,n){var i=r[0]*n[1]-r[1]*n[0],s=r[0]*n[2]-r[2]*n[0],a=r[0]*n[3]-r[3]*n[0],o=r[1]*n[2]-r[2]*n[1],u=r[1]*n[3]-r[3]*n[1],h=r[2]*n[3]-r[3]*n[2],c=e[0],l=e[1],f=e[2],d=e[3];return t[0]=l*h-f*u+d*o,t[1]=-c*h+f*a-d*s,t[2]=c*u-l*a+d*i,t[3]=-c*o+l*s-f*i,t}function hr(t,e,r,n){var i=e[0],s=e[1],a=e[2],o=e[3];return t[0]=i+n*(r[0]-i),t[1]=s+n*(r[1]-s),t[2]=a+n*(r[2]-a),t[3]=o+n*(r[3]-o),t}function cr(t,e){var r,n,i,s,a,o;e=e||1;do{a=(r=2*$()-1)*r+(n=2*$()-1)*n}while(a>=1);do{o=(i=2*$()-1)*i+(s=2*$()-1)*s}while(o>=1);var u=Math.sqrt((1-a)/o);return t[0]=e*r,t[1]=e*n,t[2]=e*i*u,t[3]=e*s*u,t}function lr(t,e,r){var n=e[0],i=e[1],s=e[2],a=e[3];return t[0]=r[0]*n+r[4]*i+r[8]*s+r[12]*a,t[1]=r[1]*n+r[5]*i+r[9]*s+r[13]*a,t[2]=r[2]*n+r[6]*i+r[10]*s+r[14]*a,t[3]=r[3]*n+r[7]*i+r[11]*s+r[15]*a,t}function fr(t,e,r){var n=e[0],i=e[1],s=e[2],a=r[0],o=r[1],u=r[2],h=r[3],c=h*n+o*s-u*i,l=h*i+u*n-a*s,f=h*s+a*i-o*n,d=-a*n-o*i-u*s;return t[0]=c*h+d*-a+l*-u-f*-o,t[1]=l*h+d*-o+f*-a-c*-u,t[2]=f*h+d*-u+c*-o-l*-a,t[3]=e[3],t}function dr(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t}function mr(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function pr(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function gr(t,e){var r=t[0],n=t[1],i=t[2],s=t[3],a=e[0],o=e[1],u=e[2],h=e[3];return Math.abs(r-a)<=X*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(n-o)<=X*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(i-u)<=X*Math.max(1,Math.abs(i),Math.abs(u))&&Math.abs(s-h)<=X*Math.max(1,Math.abs(s),Math.abs(h))}var vr=qe,yr=We,_r=He,xr=tr,br=er,Mr=rr,wr=nr,Tr=function(){var t=Le();return function(e,r,n,i,s,a){var o,u;for(r||(r=4),n||(n=0),u=i?Math.min(i*r+n,e.length):e.length,o=n;o<u;o+=r)t[0]=e[o],t[1]=e[o+1],t[2]=e[o+2],t[3]=e[o+3],s(t,t,a),e[o]=t[0],e[o+1]=t[1],e[o+2]=t[2],e[o+3]=t[3];return e}}();function Ar(){var t=new Y(4);return Y!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function Sr(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function Er(t,e,r){r*=.5;var n=Math.sin(r);return t[0]=n*e[0],t[1]=n*e[1],t[2]=n*e[2],t[3]=Math.cos(r),t}function Ir(t,e){var r=2*Math.acos(e[3]),n=Math.sin(r/2);return n>X?(t[0]=e[0]/n,t[1]=e[1]/n,t[2]=e[2]/n):(t[0]=1,t[1]=0,t[2]=0),r}function Fr(t,e){var r=an(t,e);return Math.acos(2*r*r-1)}function Ur(t,e,r){var n=e[0],i=e[1],s=e[2],a=e[3],o=r[0],u=r[1],h=r[2],c=r[3];return t[0]=n*c+a*o+i*h-s*u,t[1]=i*c+a*u+s*o-n*h,t[2]=s*c+a*h+n*u-i*o,t[3]=a*c-n*o-i*u-s*h,t}function Cr(t,e,r){r*=.5;var n=e[0],i=e[1],s=e[2],a=e[3],o=Math.sin(r),u=Math.cos(r);return t[0]=n*u+a*o,t[1]=i*u+s*o,t[2]=s*u-i*o,t[3]=a*u-n*o,t}function Nr(t,e,r){r*=.5;var n=e[0],i=e[1],s=e[2],a=e[3],o=Math.sin(r),u=Math.cos(r);return t[0]=n*u-s*o,t[1]=i*u+a*o,t[2]=s*u+n*o,t[3]=a*u-i*o,t}function Rr(t,e,r){r*=.5;var n=e[0],i=e[1],s=e[2],a=e[3],o=Math.sin(r),u=Math.cos(r);return t[0]=n*u+i*o,t[1]=i*u-n*o,t[2]=s*u+a*o,t[3]=a*u-s*o,t}function Or(t,e){var r=e[0],n=e[1],i=e[2];return t[0]=r,t[1]=n,t[2]=i,t[3]=Math.sqrt(Math.abs(1-r*r-n*n-i*i)),t}function kr(t,e){var r=e[0],n=e[1],i=e[2],s=e[3],a=Math.sqrt(r*r+n*n+i*i),o=Math.exp(s),u=a>0?o*Math.sin(a)/a:0;return t[0]=r*u,t[1]=n*u,t[2]=i*u,t[3]=o*Math.cos(a),t}function Br(t,e){var r=e[0],n=e[1],i=e[2],s=e[3],a=Math.sqrt(r*r+n*n+i*i),o=a>0?Math.atan2(a,s)/a:0;return t[0]=r*o,t[1]=n*o,t[2]=i*o,t[3]=.5*Math.log(r*r+n*n+i*i+s*s),t}function zr(t,e,r){return Br(t,e),sn(t,t,r),kr(t,t),t}function Lr(t,e,r,n){var i,s,a,o,u,h=e[0],c=e[1],l=e[2],f=e[3],d=r[0],m=r[1],p=r[2],g=r[3];return(s=h*d+c*m+l*p+f*g)<0&&(s=-s,d=-d,m=-m,p=-p,g=-g),1-s>X?(i=Math.acos(s),a=Math.sin(i),o=Math.sin((1-n)*i)/a,u=Math.sin(n*i)/a):(o=1-n,u=n),t[0]=o*h+u*d,t[1]=o*c+u*m,t[2]=o*l+u*p,t[3]=o*f+u*g,t}function Dr(t){var e=$(),r=$(),n=$(),i=Math.sqrt(1-e),s=Math.sqrt(e);return t[0]=i*Math.sin(2*Math.PI*r),t[1]=i*Math.cos(2*Math.PI*r),t[2]=s*Math.sin(2*Math.PI*n),t[3]=s*Math.cos(2*Math.PI*n),t}function Pr(t,e){var r=e[0],n=e[1],i=e[2],s=e[3],a=r*r+n*n+i*i+s*s,o=a?1/a:0;return t[0]=-r*o,t[1]=-n*o,t[2]=-i*o,t[3]=s*o,t}function Vr(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t}function jr(t,e){var r,n=e[0]+e[4]+e[8];if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);var s=(i+1)%3,a=(i+2)%3;r=Math.sqrt(e[3*i+i]-e[3*s+s]-e[3*a+a]+1),t[i]=.5*r,r=.5/r,t[3]=(e[3*s+a]-e[3*a+s])*r,t[s]=(e[3*s+i]+e[3*i+s])*r,t[a]=(e[3*a+i]+e[3*i+a])*r}return t}function Gr(t,e,r,n){var i=.5*Math.PI/180;e*=i,r*=i,n*=i;var s=Math.sin(e),a=Math.cos(e),o=Math.sin(r),u=Math.cos(r),h=Math.sin(n),c=Math.cos(n);return t[0]=s*u*c-a*o*h,t[1]=a*o*c+s*u*h,t[2]=a*u*h-s*o*c,t[3]=a*u*c+s*o*h,t}function qr(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}var Wr,Hr,Xr,Yr,$r,Zr,Jr,Kr=De,Qr=Pe,tn=Ve,en=je,rn=Ge,nn=Ur,sn=Ke,an=or,on=hr,un=rr,hn=un,cn=nr,ln=cn,fn=ar,dn=pr,mn=gr,pn=(Wr=Gt(),Hr=Ht(1,0,0),Xr=Ht(0,1,0),function(t,e,r){var n=fe(e,r);return n<-.999999?(de(Wr,Hr,e),ke(Wr)<1e-6&&de(Wr,Xr,e),le(Wr,Wr),Er(t,Wr,Math.PI),t):n>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(de(Wr,e,r),t[0]=Wr[0],t[1]=Wr[1],t[2]=Wr[2],t[3]=1+n,fn(t,t))}),gn=(Yr=Ar(),$r=Ar(),function(t,e,r,n,i,s){return Lr(Yr,e,i,s),Lr($r,r,n,s),Lr(t,Yr,$r,2*s*(1-s)),t}),vn=(Zr=new Y(9),Y!=Float32Array&&(Zr[1]=0,Zr[2]=0,Zr[3]=0,Zr[5]=0,Zr[6]=0,Zr[7]=0),Zr[0]=1,Zr[4]=1,Zr[8]=1,Jr=Zr,function(t,e,r,n){return Jr[0]=r[0],Jr[3]=r[1],Jr[6]=r[2],Jr[1]=n[0],Jr[4]=n[1],Jr[7]=n[2],Jr[2]=-e[0],Jr[5]=-e[1],Jr[8]=-e[2],fn(t,jr(t,Jr))});function yn(t,e=""){if(!t){const t=new Error(`Assert fail: ${e}`);throw console.error(t.stack),t}}function _n(t,e){if(null!=t)return t;throw new Error(bn(e,"Missing object"))}function xn(t){return null!=t}function bn(t,e){return null!=t?t:e}class Mn{constructor(t,e,r=1,s=2e4){this.cameraMatrix=n.create(),this.viewMatrix=n.create(),this.projectionMatrix=n.create(),this.projectionMatrixInverse=n.create(),this.viewProjMatrix=n.create(),this.viewProjMatrixInverse=n.create(),this.forward=i.create(),this.up=i.create(),this.right=i.create(),t=bn(t,60/180*Math.PI),r=bn(r,1),s=bn(s,2e3),e=bn(e,1),this.setPerspective(t,e,r,s)}copy(t){this.fov=t.fov,this.near=t.near,this.far=t.far,this.aspect=t.aspect,n.copy(this.cameraMatrix,t.cameraMatrix),n.copy(this.viewMatrix,t.viewMatrix),n.copy(this.projectionMatrix,t.projectionMatrix),n.copy(this.projectionMatrixInverse,t.projectionMatrixInverse),n.copy(this.viewProjMatrix,t.viewProjMatrix),n.copy(this.viewProjMatrixInverse,t.viewProjMatrixInverse),i.copy(this.forward,t.forward),i.copy(this.up,t.up),i.copy(this.right,t.right)}getPos(t){return n.getTranslation(t,this.cameraMatrix)}viewMatrixUpdated(){n.invert(this.cameraMatrix,this.viewMatrix),i.set(this.right,this.cameraMatrix[0],this.cameraMatrix[1],this.cameraMatrix[2]),i.set(this.up,this.cameraMatrix[4],this.cameraMatrix[5],this.cameraMatrix[6]),i.set(this.forward,-this.cameraMatrix[8],-this.cameraMatrix[9],-this.cameraMatrix[10]),n.multiply(this.viewProjMatrix,this.projectionMatrix,this.viewMatrix),n.multiply(this.viewProjMatrixInverse,this.cameraMatrix,this.projectionMatrixInverse)}setPerspective(t,e,r,i=1/0){this.fov=t,this.aspect=e,this.near=r,this.far=i,n.perspective(this.projectionMatrix,t,e,r,i),n.invert(this.projectionMatrixInverse,this.projectionMatrix),n.multiply(this.viewProjMatrix,this.projectionMatrix,this.viewMatrix),n.multiply(this.viewProjMatrixInverse,this.cameraMatrix,this.projectionMatrixInverse)}}class wn{constructor(){this._add=[],this._folders={}}add(t,e,r,n,i){this._add.push(arguments)}addFolder(t){return this._folders[t]=new wn,this._folders[t]}async show(){var t;if(void 0===this._gui){const t=await r.e(2).then(r.bind(null,12));this._gui=new t.GUI({load:this._saveObject})}(null===(t=this._saveObject)||void 0===t?void 0:t.closed)&&this._gui.close();for(const t of this._add)this._gui.getRoot().remember(t[0]),this._gui.add.apply(this._gui,t);for(const t in this._folders)this._folders[t]._gui=this._gui.addFolder(t),this._folders[t].show();this.add=this._gui.add.bind(this._gui),this.addFolder=this._gui.addFolder.bind(this._gui),this.show=this._gui.show.bind(this._gui),this.hide=this._gui.hide.bind(this._gui)}hide(){}update(){if(this._gui&&!this._gui.closed)for(var t in this._gui.__controllers)this._gui.__controllers[t].updateDisplay()}toJSON(){return this._gui?this._gui.getSaveObject():void 0}fromJSON(t){yn(!xn(this._gui),"State must be loaded before the DebugMenu is shown"),this._saveObject=t}}window.onkeyup=t=>{"KeyT"===t.code&&Tn.show()};let Tn=new wn;for(var An=[],Sn=0;Sn<256;Sn++)An[Sn]=(Sn<16?"0":"")+Sn.toString(16);var En={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){var t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,r=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(An[255&t]+An[t>>8&255]+An[t>>16&255]+An[t>>24&255]+"-"+An[255&e]+An[e>>8&255]+"-"+An[e>>16&15|64]+An[e>>24&255]+"-"+An[63&r|128]+An[r>>8&255]+"-"+An[r>>16&255]+An[r>>24&255]+An[255&n]+An[n>>8&255]+An[n>>16&255]+An[n>>24&255]).toUpperCase()},clamp:function(t,e,r){return Math.max(e,Math.min(r,t))},euclideanModulo:function(t,e){return(t%e+e)%e},mapLinear:function(t,e,r,n,i){return n+(t-e)*(i-n)/(r-e)},lerp:function(t,e,r){return(1-r)*t+r*e},smoothstep:function(t,e,r){return t<=e?0:t>=r?1:(t=(t-e)/(r-e))*t*(3-2*t)},smootherstep:function(t,e,r){return t<=e?0:t>=r?1:(t=(t-e)/(r-e))*t*t*(t*(6*t-15)+10)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},degToRad:function(t){return t*En.DEG2RAD},radToDeg:function(t){return t*En.RAD2DEG},isPowerOfTwo:function(t){return 0==(t&t-1)&&0!==t},ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:function(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},setQuaternionFromProperEuler:function(t,e,r,n,i){var s=Math.cos,a=Math.sin,o=s(r/2),u=a(r/2),h=s((e+n)/2),c=a((e+n)/2),l=s((e-n)/2),f=a((e-n)/2),d=s((n-e)/2),m=a((n-e)/2);"XYX"===i?t.set(o*c,u*l,u*f,o*h):"YZY"===i?t.set(u*f,o*c,u*l,o*h):"ZXZ"===i?t.set(u*l,u*f,o*c,o*h):"XZX"===i?t.set(o*c,u*m,u*d,o*h):"YXY"===i?t.set(u*d,o*c,u*m,o*h):"ZYZ"===i?t.set(u*m,u*d,o*c,o*h):console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order.")}};function In(t,e,r,n){this._x=t||0,this._y=e||0,this._z=r||0,this._w=void 0!==n?n:1}Object.assign(In,{slerp:function(t,e,r,n){return r.copy(t).slerp(e,n)},slerpFlat:function(t,e,r,n,i,s,a){var o=r[n+0],u=r[n+1],h=r[n+2],c=r[n+3],l=i[s+0],f=i[s+1],d=i[s+2],m=i[s+3];if(c!==m||o!==l||u!==f||h!==d){var p=1-a,g=o*l+u*f+h*d+c*m,v=g>=0?1:-1,y=1-g*g;if(y>Number.EPSILON){var _=Math.sqrt(y),x=Math.atan2(_,g*v);p=Math.sin(p*x)/_,a=Math.sin(a*x)/_}var b=a*v;if(o=o*p+l*b,u=u*p+f*b,h=h*p+d*b,c=c*p+m*b,p===1-a){var M=1/Math.sqrt(o*o+u*u+h*h+c*c);o*=M,u*=M,h*=M,c*=M}}t[e]=o,t[e+1]=u,t[e+2]=h,t[e+3]=c}}),Object.defineProperties(In.prototype,{x:{get:function(){return this._x},set:function(t){this._x=t,this._onChangeCallback()}},y:{get:function(){return this._y},set:function(t){this._y=t,this._onChangeCallback()}},z:{get:function(){return this._z},set:function(t){this._z=t,this._onChangeCallback()}},w:{get:function(){return this._w},set:function(t){this._w=t,this._onChangeCallback()}}}),Object.assign(In.prototype,{isQuaternion:!0,set:function(t,e,r,n){return this._x=t,this._y=e,this._z=r,this._w=n,this._onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this},setFromEuler:function(t,e){if(!t||!t.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var r=t._x,n=t._y,i=t._z,s=t.order,a=Math.cos,o=Math.sin,u=a(r/2),h=a(n/2),c=a(i/2),l=o(r/2),f=o(n/2),d=o(i/2);return"XYZ"===s?(this._x=l*h*c+u*f*d,this._y=u*f*c-l*h*d,this._z=u*h*d+l*f*c,this._w=u*h*c-l*f*d):"YXZ"===s?(this._x=l*h*c+u*f*d,this._y=u*f*c-l*h*d,this._z=u*h*d-l*f*c,this._w=u*h*c+l*f*d):"ZXY"===s?(this._x=l*h*c-u*f*d,this._y=u*f*c+l*h*d,this._z=u*h*d+l*f*c,this._w=u*h*c-l*f*d):"ZYX"===s?(this._x=l*h*c-u*f*d,this._y=u*f*c+l*h*d,this._z=u*h*d-l*f*c,this._w=u*h*c+l*f*d):"YZX"===s?(this._x=l*h*c+u*f*d,this._y=u*f*c+l*h*d,this._z=u*h*d-l*f*c,this._w=u*h*c-l*f*d):"XZY"===s&&(this._x=l*h*c-u*f*d,this._y=u*f*c-l*h*d,this._z=u*h*d+l*f*c,this._w=u*h*c+l*f*d),!1!==e&&this._onChangeCallback(),this},setFromAxisAngle:function(t,e){var r=e/2,n=Math.sin(r);return this._x=t.x*n,this._y=t.y*n,this._z=t.z*n,this._w=Math.cos(r),this._onChangeCallback(),this},setFromRotationMatrix:function(t){var e,r=t.elements,n=r[0],i=r[4],s=r[8],a=r[1],o=r[5],u=r[9],h=r[2],c=r[6],l=r[10],f=n+o+l;return f>0?(e=.5/Math.sqrt(f+1),this._w=.25/e,this._x=(c-u)*e,this._y=(s-h)*e,this._z=(a-i)*e):n>o&&n>l?(e=2*Math.sqrt(1+n-o-l),this._w=(c-u)/e,this._x=.25*e,this._y=(i+a)/e,this._z=(s+h)/e):o>l?(e=2*Math.sqrt(1+o-n-l),this._w=(s-h)/e,this._x=(i+a)/e,this._y=.25*e,this._z=(u+c)/e):(e=2*Math.sqrt(1+l-n-o),this._w=(a-i)/e,this._x=(s+h)/e,this._y=(u+c)/e,this._z=.25*e),this._onChangeCallback(),this},setFromUnitVectors:function(t,e){var r=t.dot(e)+1;return r<1e-6?(r=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=r):(this._x=0,this._y=-t.z,this._z=t.y,this._w=r)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=r),this.normalize()},angleTo:function(t){return 2*Math.acos(Math.abs(En.clamp(this.dot(t),-1,1)))},rotateTowards:function(t,e){var r=this.angleTo(t);if(0===r)return this;var n=Math.min(1,e/r);return this.slerp(t,n),this},inverse:function(){return this.conjugate()},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this},dot:function(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this},multiply:function(t,e){return void 0!==e?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(t,e)):this.multiplyQuaternions(this,t)},premultiply:function(t){return this.multiplyQuaternions(t,this)},multiplyQuaternions:function(t,e){var r=t._x,n=t._y,i=t._z,s=t._w,a=e._x,o=e._y,u=e._z,h=e._w;return this._x=r*h+s*a+n*u-i*o,this._y=n*h+s*o+i*a-r*u,this._z=i*h+s*u+r*o-n*a,this._w=s*h-r*a-n*o-i*u,this._onChangeCallback(),this},slerp:function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var r=this._x,n=this._y,i=this._z,s=this._w,a=s*t._w+r*t._x+n*t._y+i*t._z;if(a<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,a=-a):this.copy(t),a>=1)return this._w=s,this._x=r,this._y=n,this._z=i,this;var o=1-a*a;if(o<=Number.EPSILON){var u=1-e;return this._w=u*s+e*this._w,this._x=u*r+e*this._x,this._y=u*n+e*this._y,this._z=u*i+e*this._z,this.normalize(),this._onChangeCallback(),this}var h=Math.sqrt(o),c=Math.atan2(h,a),l=Math.sin((1-e)*c)/h,f=Math.sin(e*c)/h;return this._w=s*l+this._w*f,this._x=r*l+this._x*f,this._y=n*l+this._y*f,this._z=i*l+this._z*f,this._onChangeCallback(),this},equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w},fromArray:function(t,e){return void 0===e&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t},fromBufferAttribute:function(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this},_onChange:function(t){return this._onChangeCallback=t,this},_onChangeCallback:function(){}});var Fn=new Cn,Un=new In;function Cn(t,e,r){this.x=t||0,this.y=e||0,this.z=r||0}Object.assign(Cn.prototype,{isVector3:!0,set:function(t,e,r){return this.x=t,this.y=e,this.z=r,this},setScalar:function(t){return this.x=t,this.y=t,this.z=t,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setZ:function(t){return this.z=t,this},setComponent:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this},getComponent:function(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},add:function(t,e){return void 0!==e?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)},addScalar:function(t){return this.x+=t,this.y+=t,this.z+=t,this},addVectors:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},addScaledVector:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this},sub:function(t,e){return void 0!==e?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)},subScalar:function(t){return this.x-=t,this.y-=t,this.z-=t,this},subVectors:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},multiply:function(t,e){return void 0!==e?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(t,e)):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this)},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this},multiplyVectors:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},applyEuler:function(t){return t&&t.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(Un.setFromEuler(t))},applyAxisAngle:function(t,e){return this.applyQuaternion(Un.setFromAxisAngle(t,e))},applyMatrix3:function(t){var e=this.x,r=this.y,n=this.z,i=t.elements;return this.x=i[0]*e+i[3]*r+i[6]*n,this.y=i[1]*e+i[4]*r+i[7]*n,this.z=i[2]*e+i[5]*r+i[8]*n,this},applyNormalMatrix:function(t){return this.applyMatrix3(t).normalize()},applyMatrix4:function(t){var e=this.x,r=this.y,n=this.z,i=t.elements,s=1/(i[3]*e+i[7]*r+i[11]*n+i[15]);return this.x=(i[0]*e+i[4]*r+i[8]*n+i[12])*s,this.y=(i[1]*e+i[5]*r+i[9]*n+i[13])*s,this.z=(i[2]*e+i[6]*r+i[10]*n+i[14])*s,this},applyQuaternion:function(t){var e=this.x,r=this.y,n=this.z,i=t.x,s=t.y,a=t.z,o=t.w,u=o*e+s*n-a*r,h=o*r+a*e-i*n,c=o*n+i*r-s*e,l=-i*e-s*r-a*n;return this.x=u*o+l*-i+h*-a-c*-s,this.y=h*o+l*-s+c*-i-u*-a,this.z=c*o+l*-a+u*-s-h*-i,this},project:function(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)},unproject:function(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)},transformDirection:function(t){var e=this.x,r=this.y,n=this.z,i=t.elements;return this.x=i[0]*e+i[4]*r+i[8]*n,this.y=i[1]*e+i[5]*r+i[9]*n,this.z=i[2]*e+i[6]*r+i[10]*n,this.normalize()},divide:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},divideScalar:function(t){return this.multiplyScalar(1/t)},min:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this},max:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this},clamp:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this},clampScalar:function(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this},clampLength:function(t,e){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(t,Math.min(e,r)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(t){return this.normalize().multiplyScalar(t)},lerp:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this},lerpVectors:function(t,e,r){return this.subVectors(e,t).multiplyScalar(r).add(t)},cross:function(t,e){return void 0!==e?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e)):this.crossVectors(this,t)},crossVectors:function(t,e){var r=t.x,n=t.y,i=t.z,s=e.x,a=e.y,o=e.z;return this.x=n*o-i*a,this.y=i*s-r*o,this.z=r*a-n*s,this},projectOnVector:function(t){var e=t.lengthSq();if(0===e)return this.set(0,0,0);var r=t.dot(this)/e;return this.copy(t).multiplyScalar(r)},projectOnPlane:function(t){return Fn.copy(this).projectOnVector(t),this.sub(Fn)},reflect:function(t){return this.sub(Fn.copy(t).multiplyScalar(2*this.dot(t)))},angleTo:function(t){var e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;var r=this.dot(t)/e;return Math.acos(En.clamp(r,-1,1))},distanceTo:function(t){return Math.sqrt(this.distanceToSquared(t))},distanceToSquared:function(t){var e=this.x-t.x,r=this.y-t.y,n=this.z-t.z;return e*e+r*r+n*n},manhattanDistanceTo:function(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)},setFromSpherical:function(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)},setFromSphericalCoords:function(t,e,r){var n=Math.sin(e)*t;return this.x=n*Math.sin(r),this.y=Math.cos(e)*t,this.z=n*Math.cos(r),this},setFromCylindrical:function(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)},setFromCylindricalCoords:function(t,e,r){return this.x=t*Math.sin(e),this.y=r,this.z=t*Math.cos(e),this},setFromMatrixPosition:function(t){var e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this},setFromMatrixScale:function(t){var e=this.setFromMatrixColumn(t,0).length(),r=this.setFromMatrixColumn(t,1).length(),n=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=r,this.z=n,this},setFromMatrixColumn:function(t,e){return this.fromArray(t.elements,4*e)},setFromMatrix3Column:function(t,e){return this.fromArray(t.elements,3*e)},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},fromArray:function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t},fromBufferAttribute:function(t,e,r){return void 0!==r&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}});var Nn=new Cn,Rn=new Dn,On=new Cn(0,0,0),kn=new Cn(1,1,1),Bn=new Cn,zn=new Cn,Ln=new Cn;function Dn(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}function Pn(){}Object.assign(Dn.prototype,{isMatrix4:!0,set:function(t,e,r,n,i,s,a,o,u,h,c,l,f,d,m,p){var g=this.elements;return g[0]=t,g[4]=e,g[8]=r,g[12]=n,g[1]=i,g[5]=s,g[9]=a,g[13]=o,g[2]=u,g[6]=h,g[10]=c,g[14]=l,g[3]=f,g[7]=d,g[11]=m,g[15]=p,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new Dn).fromArray(this.elements)},copy:function(t){var e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],this},copyPosition:function(t){var e=this.elements,r=t.elements;return e[12]=r[12],e[13]=r[13],e[14]=r[14],this},extractBasis:function(t,e,r){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this},makeBasis:function(t,e,r){return this.set(t.x,e.x,r.x,0,t.y,e.y,r.y,0,t.z,e.z,r.z,0,0,0,0,1),this},extractRotation:function(t){var e=this.elements,r=t.elements,n=1/Nn.setFromMatrixColumn(t,0).length(),i=1/Nn.setFromMatrixColumn(t,1).length(),s=1/Nn.setFromMatrixColumn(t,2).length();return e[0]=r[0]*n,e[1]=r[1]*n,e[2]=r[2]*n,e[3]=0,e[4]=r[4]*i,e[5]=r[5]*i,e[6]=r[6]*i,e[7]=0,e[8]=r[8]*s,e[9]=r[9]*s,e[10]=r[10]*s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},makeRotationFromEuler:function(t){t&&t.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var e=this.elements,r=t.x,n=t.y,i=t.z,s=Math.cos(r),a=Math.sin(r),o=Math.cos(n),u=Math.sin(n),h=Math.cos(i),c=Math.sin(i);if("XYZ"===t.order){var l=s*h,f=s*c,d=a*h,m=a*c;e[0]=o*h,e[4]=-o*c,e[8]=u,e[1]=f+d*u,e[5]=l-m*u,e[9]=-a*o,e[2]=m-l*u,e[6]=d+f*u,e[10]=s*o}else if("YXZ"===t.order){var p=o*h,g=o*c,v=u*h,y=u*c;e[0]=p+y*a,e[4]=v*a-g,e[8]=s*u,e[1]=s*c,e[5]=s*h,e[9]=-a,e[2]=g*a-v,e[6]=y+p*a,e[10]=s*o}else if("ZXY"===t.order){p=o*h,g=o*c,v=u*h,y=u*c;e[0]=p-y*a,e[4]=-s*c,e[8]=v+g*a,e[1]=g+v*a,e[5]=s*h,e[9]=y-p*a,e[2]=-s*u,e[6]=a,e[10]=s*o}else if("ZYX"===t.order){l=s*h,f=s*c,d=a*h,m=a*c;e[0]=o*h,e[4]=d*u-f,e[8]=l*u+m,e[1]=o*c,e[5]=m*u+l,e[9]=f*u-d,e[2]=-u,e[6]=a*o,e[10]=s*o}else if("YZX"===t.order){var _=s*o,x=s*u,b=a*o,M=a*u;e[0]=o*h,e[4]=M-_*c,e[8]=b*c+x,e[1]=c,e[5]=s*h,e[9]=-a*h,e[2]=-u*h,e[6]=x*c+b,e[10]=_-M*c}else if("XZY"===t.order){_=s*o,x=s*u,b=a*o,M=a*u;e[0]=o*h,e[4]=-c,e[8]=u*h,e[1]=_*c+M,e[5]=s*h,e[9]=x*c-b,e[2]=b*c-x,e[6]=a*h,e[10]=M*c+_}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},makeRotationFromQuaternion:function(t){return this.compose(On,t,kn)},lookAt:function(t,e,r){var n=this.elements;return Ln.subVectors(t,e),0===Ln.lengthSq()&&(Ln.z=1),Ln.normalize(),Bn.crossVectors(r,Ln),0===Bn.lengthSq()&&(1===Math.abs(r.z)?Ln.x+=1e-4:Ln.z+=1e-4,Ln.normalize(),Bn.crossVectors(r,Ln)),Bn.normalize(),zn.crossVectors(Ln,Bn),n[0]=Bn.x,n[4]=zn.x,n[8]=Ln.x,n[1]=Bn.y,n[5]=zn.y,n[9]=Ln.y,n[2]=Bn.z,n[6]=zn.z,n[10]=Ln.z,this},multiply:function(t,e){return void 0!==e?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(t,e)):this.multiplyMatrices(this,t)},premultiply:function(t){return this.multiplyMatrices(t,this)},multiplyMatrices:function(t,e){var r=t.elements,n=e.elements,i=this.elements,s=r[0],a=r[4],o=r[8],u=r[12],h=r[1],c=r[5],l=r[9],f=r[13],d=r[2],m=r[6],p=r[10],g=r[14],v=r[3],y=r[7],_=r[11],x=r[15],b=n[0],M=n[4],w=n[8],T=n[12],A=n[1],S=n[5],E=n[9],I=n[13],F=n[2],U=n[6],C=n[10],N=n[14],R=n[3],O=n[7],k=n[11],B=n[15];return i[0]=s*b+a*A+o*F+u*R,i[4]=s*M+a*S+o*U+u*O,i[8]=s*w+a*E+o*C+u*k,i[12]=s*T+a*I+o*N+u*B,i[1]=h*b+c*A+l*F+f*R,i[5]=h*M+c*S+l*U+f*O,i[9]=h*w+c*E+l*C+f*k,i[13]=h*T+c*I+l*N+f*B,i[2]=d*b+m*A+p*F+g*R,i[6]=d*M+m*S+p*U+g*O,i[10]=d*w+m*E+p*C+g*k,i[14]=d*T+m*I+p*N+g*B,i[3]=v*b+y*A+_*F+x*R,i[7]=v*M+y*S+_*U+x*O,i[11]=v*w+y*E+_*C+x*k,i[15]=v*T+y*I+_*N+x*B,this},multiplyScalar:function(t){var e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this},determinant:function(){var t=this.elements,e=t[0],r=t[4],n=t[8],i=t[12],s=t[1],a=t[5],o=t[9],u=t[13],h=t[2],c=t[6],l=t[10],f=t[14];return t[3]*(+i*o*c-n*u*c-i*a*l+r*u*l+n*a*f-r*o*f)+t[7]*(+e*o*f-e*u*l+i*s*l-n*s*f+n*u*h-i*o*h)+t[11]*(+e*u*c-e*a*f-i*s*c+r*s*f+i*a*h-r*u*h)+t[15]*(-n*a*h-e*o*c+e*a*l+n*s*c-r*s*l+r*o*h)},transpose:function(){var t,e=this.elements;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},setPosition:function(t,e,r){var n=this.elements;return t.isVector3?(n[12]=t.x,n[13]=t.y,n[14]=t.z):(n[12]=t,n[13]=e,n[14]=r),this},getInverse:function(t,e){void 0!==e&&console.warn("THREE.Matrix4: .getInverse() can no longer be configured to throw on degenerate.");var r=this.elements,n=t.elements,i=n[0],s=n[1],a=n[2],o=n[3],u=n[4],h=n[5],c=n[6],l=n[7],f=n[8],d=n[9],m=n[10],p=n[11],g=n[12],v=n[13],y=n[14],_=n[15],x=d*y*l-v*m*l+v*c*p-h*y*p-d*c*_+h*m*_,b=g*m*l-f*y*l-g*c*p+u*y*p+f*c*_-u*m*_,M=f*v*l-g*d*l+g*h*p-u*v*p-f*h*_+u*d*_,w=g*d*c-f*v*c-g*h*m+u*v*m+f*h*y-u*d*y,T=i*x+s*b+a*M+o*w;if(0===T)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var A=1/T;return r[0]=x*A,r[1]=(v*m*o-d*y*o-v*a*p+s*y*p+d*a*_-s*m*_)*A,r[2]=(h*y*o-v*c*o+v*a*l-s*y*l-h*a*_+s*c*_)*A,r[3]=(d*c*o-h*m*o-d*a*l+s*m*l+h*a*p-s*c*p)*A,r[4]=b*A,r[5]=(f*y*o-g*m*o+g*a*p-i*y*p-f*a*_+i*m*_)*A,r[6]=(g*c*o-u*y*o-g*a*l+i*y*l+u*a*_-i*c*_)*A,r[7]=(u*m*o-f*c*o+f*a*l-i*m*l-u*a*p+i*c*p)*A,r[8]=M*A,r[9]=(g*d*o-f*v*o-g*s*p+i*v*p+f*s*_-i*d*_)*A,r[10]=(u*v*o-g*h*o+g*s*l-i*v*l-u*s*_+i*h*_)*A,r[11]=(f*h*o-u*d*o-f*s*l+i*d*l+u*s*p-i*h*p)*A,r[12]=w*A,r[13]=(f*v*a-g*d*a+g*s*m-i*v*m-f*s*y+i*d*y)*A,r[14]=(g*h*a-u*v*a-g*s*c+i*v*c+u*s*y-i*h*y)*A,r[15]=(u*d*a-f*h*a+f*s*c-i*d*c-u*s*m+i*h*m)*A,this},scale:function(t){var e=this.elements,r=t.x,n=t.y,i=t.z;return e[0]*=r,e[4]*=n,e[8]*=i,e[1]*=r,e[5]*=n,e[9]*=i,e[2]*=r,e[6]*=n,e[10]*=i,e[3]*=r,e[7]*=n,e[11]*=i,this},getMaxScaleOnAxis:function(){var t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],r=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],n=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,r,n))},makeTranslation:function(t,e,r){return this.set(1,0,0,t,0,1,0,e,0,0,1,r,0,0,0,1),this},makeRotationX:function(t){var e=Math.cos(t),r=Math.sin(t);return this.set(1,0,0,0,0,e,-r,0,0,r,e,0,0,0,0,1),this},makeRotationY:function(t){var e=Math.cos(t),r=Math.sin(t);return this.set(e,0,r,0,0,1,0,0,-r,0,e,0,0,0,0,1),this},makeRotationZ:function(t){var e=Math.cos(t),r=Math.sin(t);return this.set(e,-r,0,0,r,e,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(t,e){var r=Math.cos(e),n=Math.sin(e),i=1-r,s=t.x,a=t.y,o=t.z,u=i*s,h=i*a;return this.set(u*s+r,u*a-n*o,u*o+n*a,0,u*a+n*o,h*a+r,h*o-n*s,0,u*o-n*a,h*o+n*s,i*o*o+r,0,0,0,0,1),this},makeScale:function(t,e,r){return this.set(t,0,0,0,0,e,0,0,0,0,r,0,0,0,0,1),this},makeShear:function(t,e,r){return this.set(1,e,r,0,t,1,r,0,t,e,1,0,0,0,0,1),this},compose:function(t,e,r){var n=this.elements,i=e._x,s=e._y,a=e._z,o=e._w,u=i+i,h=s+s,c=a+a,l=i*u,f=i*h,d=i*c,m=s*h,p=s*c,g=a*c,v=o*u,y=o*h,_=o*c,x=r.x,b=r.y,M=r.z;return n[0]=(1-(m+g))*x,n[1]=(f+_)*x,n[2]=(d-y)*x,n[3]=0,n[4]=(f-_)*b,n[5]=(1-(l+g))*b,n[6]=(p+v)*b,n[7]=0,n[8]=(d+y)*M,n[9]=(p-v)*M,n[10]=(1-(l+m))*M,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,this},decompose:function(t,e,r){var n=this.elements,i=Nn.set(n[0],n[1],n[2]).length(),s=Nn.set(n[4],n[5],n[6]).length(),a=Nn.set(n[8],n[9],n[10]).length();this.determinant()<0&&(i=-i),t.x=n[12],t.y=n[13],t.z=n[14],Rn.copy(this);var o=1/i,u=1/s,h=1/a;return Rn.elements[0]*=o,Rn.elements[1]*=o,Rn.elements[2]*=o,Rn.elements[4]*=u,Rn.elements[5]*=u,Rn.elements[6]*=u,Rn.elements[8]*=h,Rn.elements[9]*=h,Rn.elements[10]*=h,e.setFromRotationMatrix(Rn),r.x=i,r.y=s,r.z=a,this},makePerspective:function(t,e,r,n,i,s){void 0===s&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");var a=this.elements,o=2*i/(e-t),u=2*i/(r-n),h=(e+t)/(e-t),c=(r+n)/(r-n),l=-(s+i)/(s-i),f=-2*s*i/(s-i);return a[0]=o,a[4]=0,a[8]=h,a[12]=0,a[1]=0,a[5]=u,a[9]=c,a[13]=0,a[2]=0,a[6]=0,a[10]=l,a[14]=f,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this},makeOrthographic:function(t,e,r,n,i,s){var a=this.elements,o=1/(e-t),u=1/(r-n),h=1/(s-i),c=(e+t)*o,l=(r+n)*u,f=(s+i)*h;return a[0]=2*o,a[4]=0,a[8]=0,a[12]=-c,a[1]=0,a[5]=2*u,a[9]=0,a[13]=-l,a[2]=0,a[6]=0,a[10]=-2*h,a[14]=-f,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this},equals:function(t){for(var e=this.elements,r=t.elements,n=0;n<16;n++)if(e[n]!==r[n])return!1;return!0},fromArray:function(t,e){void 0===e&&(e=0);for(var r=0;r<16;r++)this.elements[r]=t[r+e];return this},toArray:function(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);var r=this.elements;return t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t[e+9]=r[9],t[e+10]=r[10],t[e+11]=r[11],t[e+12]=r[12],t[e+13]=r[13],t[e+14]=r[14],t[e+15]=r[15],t}}),Object.assign(Pn.prototype,{addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});var r=this._listeners;void 0===r[t]&&(r[t]=[]),-1===r[t].indexOf(e)&&r[t].push(e)},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;var r=this._listeners;return void 0!==r[t]&&-1!==r[t].indexOf(e)},removeEventListener:function(t,e){if(void 0!==this._listeners){var r=this._listeners[t];if(void 0!==r){var n=r.indexOf(e);-1!==n&&r.splice(n,1)}}},dispatchEvent:function(t){if(void 0!==this._listeners){var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var r=e.slice(0),n=0,i=r.length;n<i;n++)r[n].call(this,t)}}}});var Vn=new Dn,jn=new In;function Gn(t,e,r,n){this._x=t||0,this._y=e||0,this._z=r||0,this._order=n||Gn.DefaultOrder}function qn(){this.mask=1}function Wn(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}Gn.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],Gn.DefaultOrder="XYZ",Object.defineProperties(Gn.prototype,{x:{get:function(){return this._x},set:function(t){this._x=t,this._onChangeCallback()}},y:{get:function(){return this._y},set:function(t){this._y=t,this._onChangeCallback()}},z:{get:function(){return this._z},set:function(t){this._z=t,this._onChangeCallback()}},order:{get:function(){return this._order},set:function(t){this._order=t,this._onChangeCallback()}}}),Object.assign(Gn.prototype,{isEuler:!0,set:function(t,e,r,n){return this._x=t,this._y=e,this._z=r,this._order=n||this._order,this._onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._order)},copy:function(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this},setFromRotationMatrix:function(t,e,r){var n=En.clamp,i=t.elements,s=i[0],a=i[4],o=i[8],u=i[1],h=i[5],c=i[9],l=i[2],f=i[6],d=i[10];return"XYZ"===(e=e||this._order)?(this._y=Math.asin(n(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-c,d),this._z=Math.atan2(-a,s)):(this._x=Math.atan2(f,h),this._z=0)):"YXZ"===e?(this._x=Math.asin(-n(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(o,d),this._z=Math.atan2(u,h)):(this._y=Math.atan2(-l,s),this._z=0)):"ZXY"===e?(this._x=Math.asin(n(f,-1,1)),Math.abs(f)<.9999999?(this._y=Math.atan2(-l,d),this._z=Math.atan2(-a,h)):(this._y=0,this._z=Math.atan2(u,s))):"ZYX"===e?(this._y=Math.asin(-n(l,-1,1)),Math.abs(l)<.9999999?(this._x=Math.atan2(f,d),this._z=Math.atan2(u,s)):(this._x=0,this._z=Math.atan2(-a,h))):"YZX"===e?(this._z=Math.asin(n(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(-c,h),this._y=Math.atan2(-l,s)):(this._x=0,this._y=Math.atan2(o,d))):"XZY"===e?(this._z=Math.asin(-n(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(f,h),this._y=Math.atan2(o,s)):(this._x=Math.atan2(-c,d),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+e),this._order=e,!1!==r&&this._onChangeCallback(),this},setFromQuaternion:function(t,e,r){return Vn.makeRotationFromQuaternion(t),this.setFromRotationMatrix(Vn,e,r)},setFromVector3:function(t,e){return this.set(t.x,t.y,t.z,e||this._order)},reorder:function(t){return jn.setFromEuler(this),this.setFromQuaternion(jn,t)},equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order},fromArray:function(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t},toVector3:function(t){return t?t.set(this._x,this._y,this._z):new Cn(this._x,this._y,this._z)},_onChange:function(t){return this._onChangeCallback=t,this},_onChangeCallback:function(){}}),Object.assign(qn.prototype,{set:function(t){this.mask=1<<t|0},enable:function(t){this.mask|=1<<t|0},enableAll:function(){this.mask=-1},toggle:function(t){this.mask^=1<<t|0},disable:function(t){this.mask&=~(1<<t|0)},disableAll:function(){this.mask=0},test:function(t){return 0!=(this.mask&t.mask)}}),Object.assign(Wn.prototype,{isMatrix3:!0,set:function(t,e,r,n,i,s,a,o,u){var h=this.elements;return h[0]=t,h[1]=n,h[2]=a,h[3]=e,h[4]=i,h[5]=o,h[6]=r,h[7]=s,h[8]=u,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t){var e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],this},extractBasis:function(t,e,r){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),r.setFromMatrix3Column(this,2),this},setFromMatrix4:function(t){var e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this},multiply:function(t){return this.multiplyMatrices(this,t)},premultiply:function(t){return this.multiplyMatrices(t,this)},multiplyMatrices:function(t,e){var r=t.elements,n=e.elements,i=this.elements,s=r[0],a=r[3],o=r[6],u=r[1],h=r[4],c=r[7],l=r[2],f=r[5],d=r[8],m=n[0],p=n[3],g=n[6],v=n[1],y=n[4],_=n[7],x=n[2],b=n[5],M=n[8];return i[0]=s*m+a*v+o*x,i[3]=s*p+a*y+o*b,i[6]=s*g+a*_+o*M,i[1]=u*m+h*v+c*x,i[4]=u*p+h*y+c*b,i[7]=u*g+h*_+c*M,i[2]=l*m+f*v+d*x,i[5]=l*p+f*y+d*b,i[8]=l*g+f*_+d*M,this},multiplyScalar:function(t){var e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this},determinant:function(){var t=this.elements,e=t[0],r=t[1],n=t[2],i=t[3],s=t[4],a=t[5],o=t[6],u=t[7],h=t[8];return e*s*h-e*a*u-r*i*h+r*a*o+n*i*u-n*s*o},getInverse:function(t,e){void 0!==e&&console.warn("THREE.Matrix3: .getInverse() can no longer be configured to throw on degenerate.");var r=t.elements,n=this.elements,i=r[0],s=r[1],a=r[2],o=r[3],u=r[4],h=r[5],c=r[6],l=r[7],f=r[8],d=f*u-h*l,m=h*c-f*o,p=l*o-u*c,g=i*d+s*m+a*p;if(0===g)return this.set(0,0,0,0,0,0,0,0,0);var v=1/g;return n[0]=d*v,n[1]=(a*l-f*s)*v,n[2]=(h*s-a*u)*v,n[3]=m*v,n[4]=(f*i-a*c)*v,n[5]=(a*o-h*i)*v,n[6]=p*v,n[7]=(s*c-l*i)*v,n[8]=(u*i-s*o)*v,this},transpose:function(){var t,e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this},getNormalMatrix:function(t){return this.setFromMatrix4(t).getInverse(this).transpose()},transposeIntoArray:function(t){var e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this},setUvTransform:function(t,e,r,n,i,s,a){var o=Math.cos(i),u=Math.sin(i);this.set(r*o,r*u,-r*(o*s+u*a)+s+t,-n*u,n*o,-n*(-u*s+o*a)+a+e,0,0,1)},scale:function(t,e){var r=this.elements;return r[0]*=t,r[3]*=t,r[6]*=t,r[1]*=e,r[4]*=e,r[7]*=e,this},rotate:function(t){var e=Math.cos(t),r=Math.sin(t),n=this.elements,i=n[0],s=n[3],a=n[6],o=n[1],u=n[4],h=n[7];return n[0]=e*i+r*o,n[3]=e*s+r*u,n[6]=e*a+r*h,n[1]=-r*i+e*o,n[4]=-r*s+e*u,n[7]=-r*a+e*h,this},translate:function(t,e){var r=this.elements;return r[0]+=t*r[2],r[3]+=t*r[5],r[6]+=t*r[8],r[1]+=e*r[2],r[4]+=e*r[5],r[7]+=e*r[8],this},equals:function(t){for(var e=this.elements,r=t.elements,n=0;n<9;n++)if(e[n]!==r[n])return!1;return!0},fromArray:function(t,e){void 0===e&&(e=0);for(var r=0;r<9;r++)this.elements[r]=t[r+e];return this},toArray:function(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);var r=this.elements;return t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t}});var Hn=0,Xn=new Cn,Yn=new In,$n=new Dn,Zn=new Cn,Jn=new Cn,Kn=new Cn,Qn=new In,ti=new Cn(1,0,0),ei=new Cn(0,1,0),ri=new Cn(0,0,1),ni={type:"added"},ii={type:"removed"};function si(){Object.defineProperty(this,"id",{value:Hn++}),this.uuid=En.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=si.DefaultUp.clone();var t=new Cn,e=new Gn,r=new In,n=new Cn(1,1,1);e._onChange((function(){r.setFromEuler(e,!1)})),r._onChange((function(){e.setFromQuaternion(r,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:r},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new Dn},normalMatrix:{value:new Wn}}),this.matrix=new Dn,this.matrixWorld=new Dn,this.matrixAutoUpdate=si.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new qn,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={}}si.DefaultUp=new Cn(0,1,0),si.DefaultMatrixAutoUpdate=!0,si.prototype=Object.assign(Object.create(Pn.prototype),{constructor:si,isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix4:function(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(t){return this.quaternion.premultiply(t),this},setRotationFromAxisAngle:function(t,e){this.quaternion.setFromAxisAngle(t,e)},setRotationFromEuler:function(t){this.quaternion.setFromEuler(t,!0)},setRotationFromMatrix:function(t){this.quaternion.setFromRotationMatrix(t)},setRotationFromQuaternion:function(t){this.quaternion.copy(t)},rotateOnAxis:function(t,e){return Yn.setFromAxisAngle(t,e),this.quaternion.multiply(Yn),this},rotateOnWorldAxis:function(t,e){return Yn.setFromAxisAngle(t,e),this.quaternion.premultiply(Yn),this},rotateX:function(t){return this.rotateOnAxis(ti,t)},rotateY:function(t){return this.rotateOnAxis(ei,t)},rotateZ:function(t){return this.rotateOnAxis(ri,t)},translateOnAxis:function(t,e){return Xn.copy(t).applyQuaternion(this.quaternion),this.position.add(Xn.multiplyScalar(e)),this},translateX:function(t){return this.translateOnAxis(ti,t)},translateY:function(t){return this.translateOnAxis(ei,t)},translateZ:function(t){return this.translateOnAxis(ri,t)},localToWorld:function(t){return t.applyMatrix4(this.matrixWorld)},worldToLocal:function(t){return t.applyMatrix4($n.getInverse(this.matrixWorld))},lookAt:function(t,e,r){t.isVector3?Zn.copy(t):Zn.set(t,e,r);var n=this.parent;this.updateWorldMatrix(!0,!1),Jn.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?$n.lookAt(Jn,Zn,this.up):$n.lookAt(Zn,Jn,this.up),this.quaternion.setFromRotationMatrix($n),n&&($n.extractRotation(n.matrixWorld),Yn.setFromRotationMatrix($n),this.quaternion.premultiply(Yn.inverse()))},add:function(t){if(arguments.length>1){for(var e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(null!==t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t),t.dispatchEvent(ni)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)},remove:function(t){if(arguments.length>1){for(var e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}var r=this.children.indexOf(t);return-1!==r&&(t.parent=null,this.children.splice(r,1),t.dispatchEvent(ii)),this},attach:function(t){return this.updateWorldMatrix(!0,!1),$n.getInverse(this.matrixWorld),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),$n.multiply(t.parent.matrixWorld)),t.applyMatrix4($n),t.updateWorldMatrix(!1,!1),this.add(t),this},getObjectById:function(t){return this.getObjectByProperty("id",t)},getObjectByName:function(t){return this.getObjectByProperty("name",t)},getObjectByProperty:function(t,e){if(this[t]===e)return this;for(var r=0,n=this.children.length;r<n;r++){var i=this.children[r].getObjectByProperty(t,e);if(void 0!==i)return i}},getWorldPosition:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldPosition() target is now required"),t=new Cn),this.updateMatrixWorld(!0),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldQuaternion() target is now required"),t=new In),this.updateMatrixWorld(!0),this.matrixWorld.decompose(Jn,t,Kn),t},getWorldScale:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldScale() target is now required"),t=new Cn),this.updateMatrixWorld(!0),this.matrixWorld.decompose(Jn,Qn,t),t},getWorldDirection:function(t){void 0===t&&(console.warn("THREE.Object3D: .getWorldDirection() target is now required"),t=new Cn),this.updateMatrixWorld(!0);var e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()},raycast:function(){},traverse:function(t){t(this);for(var e=this.children,r=0,n=e.length;r<n;r++)e[r].traverse(t)},traverseVisible:function(t){if(!1!==this.visible){t(this);for(var e=this.children,r=0,n=e.length;r<n;r++)e[r].traverseVisible(t)}},traverseAncestors:function(t){var e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);for(var e=this.children,r=0,n=e.length;r<n;r++)e[r].updateMatrixWorld(t)},updateWorldMatrix:function(t,e){var r=this.parent;if(!0===t&&null!==r&&r.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===e)for(var n=this.children,i=0,s=n.length;i<s;i++)n[i].updateWorldMatrix(!1,!0)},toJSON:function(t){var e=void 0===t||"string"==typeof t,r={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{}},r.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var n={};function i(e,r){return void 0===e[r.uuid]&&(e[r.uuid]=r.toJSON(t)),r.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON()),this.isMesh||this.isLine||this.isPoints){n.geometry=i(t.geometries,this.geometry);var s=this.geometry.parameters;if(void 0!==s&&void 0!==s.shapes){var a=s.shapes;if(Array.isArray(a))for(var o=0,u=a.length;o<u;o++){var h=a[o];i(t.shapes,h)}else i(t.shapes,a)}}if(void 0!==this.material)if(Array.isArray(this.material)){var c=[];for(o=0,u=this.material.length;o<u;o++)c.push(i(t.materials,this.material[o]));n.material=c}else n.material=i(t.materials,this.material);if(this.children.length>0){n.children=[];for(o=0;o<this.children.length;o++)n.children.push(this.children[o].toJSON(t).object)}if(e){var l=p(t.geometries),f=p(t.materials),d=p(t.textures),m=p(t.images);a=p(t.shapes);l.length>0&&(r.geometries=l),f.length>0&&(r.materials=f),d.length>0&&(r.textures=d),m.length>0&&(r.images=m),a.length>0&&(r.shapes=a)}return r.object=n,r;function p(t){var e=[];for(var r in t){var n=t[r];delete n.metadata,e.push(n)}return e}},clone:function(t){return(new this.constructor).copy(this,t)},copy:function(t,e){if(void 0===e&&(e=!0),this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(var r=0;r<t.children.length;r++){var n=t.children[r];this.add(n.clone())}return this}});class ai extends Cn{constructor(t){super(),this.buffer=t}setBuffer(t){return this.buffer=t,this}set x(t){this.buffer&&(this.buffer[0]=t)}set y(t){this.buffer&&(this.buffer[1]=t)}set z(t){this.buffer&&(this.buffer[2]=t)}get x(){return this.buffer[0]}get y(){return this.buffer[1]}get z(){return this.buffer[2]}}const oi=i.create(),ui=new ai(oi);class hi{constructor(){this.ready=!1,this.localController=new ci}initialize(t){this.avatars=t,this.local=t[0],this.localController.initialize(this.local)}onResourcesLoaded(t){this.animations=t.animations,function(t,e){const r=Tn.addFolder("Animation"),n={};for(const i of t)n[i.name]=()=>{e.animationMixer.stopAllAction(),e.animationMixer.clipAction(i).play()},r.add(n,i.name)}(this.animations,this.avatars[0]);const e=_n(this.animations[12]);for(const t of this.avatars){t.animationMixer.clipAction(e).play()}this.ready=!0}update({clock:t,input:e,camera:r}){if(this.ready){this.localController.update(t,e,r);for(const e of this.avatars)e.animationMixer.update(t.dt/1e3),e.updateMatrixWorld(),e.skeleton.update()}}}class ci{constructor(){this.velocity=i.create(),this.velocityTarget=i.create(),this.orientation=i.create(),this.orientationTarget=i.create()}initialize(t){this.avatar=t}update(t,e,r){this.getCameraRelativeMovementDirection(e,r,this.velocityTarget),this.velocityTarget=i.scale(this.velocityTarget,this.velocityTarget,100),i.copy(this.velocity,this.velocityTarget);const n=t.dt/1e3;this.avatar.position.addScaledVector(ui.setBuffer(this.velocity),n)}getWorldRelativeMovementDirection(t,e){const r=t.getAxis("Horizontal"),n=t.getAxis("Vertical");return i.normalize(e,i.set(e,r,0,n))}getCameraRelativeMovementDirection(t,e,r){const n=this.getWorldRelativeMovementDirection(t,r),s=i.normalize(oi,i.set(oi,e.forward[0],0,e.forward[2]));return i.set(r,n[0]*-s[2]+n[2]*s[0],0,n[0]*s[0]+n[2]*s[2])}}class li{constructor(t,e,r,n){this.shader=r,this.name=e,this.layout=n,this.resources=t.createResourceTable(this.layout),this.bindings={}}destroy(t){t.removeResourceTable(this.resources)}assertReady(){for(const t of Object.keys(this.layout))_n(this.bindings[t],`Material expects a binding for ${t}`)}getUniformBuffer(t){const e=this.bindings[t];return _n(e,`Uniform buffer "${t}" is not bound to material "${this.name}"`),e}setUniformBuffer(t,e,r){const n=_n(this.layout[e],"Invalid resource name");yn(n.type===v.UniformBuffer,"Mismatching resource type"),this.bindings[e]=r,t.setBuffer(this.resources,n.index,r.getBufferView())}setTexture(t,e,r){const n=_n(this.layout[e],"Invalid resource name");yn(n.type===v.Texture,"Mismatching resource type"),yn(!xn(n.count),"Use Material.setTextureArray"),this.bindings[e]=r,t.setTexture(this.resources,n.index,r)}setTextureArray(t,e,r){const n=_n(this.layout[e],"Invalid resource name");yn(n.type===v.Texture,"Mismatching resource type"),yn(xn(n.count),"Use Material.setTextureArray"),this.bindings[e]=r,t.setTextures(this.resources,n.index,r)}}class fi extends si{constructor(t,e,r,n){super(),this.renderList=e,this.mesh=r,this.material=n,this.pipeline=t.createRenderPipeline(n.shader,e.renderFormat,r.vertexLayout,n.layout),this.vertexTable=t.createVertexTable(this.pipeline),r.vertexBuffers.forEach((e,r)=>{t.setVertexBuffer(this.vertexTable,r,e)}),this._primitive={renderPipeline:this.pipeline,resourceTable:this.material.resources,vertexTable:this.vertexTable,elementCount:this.mesh.elementCount,type:this.mesh.primitiveType,indexBuffer:this.mesh.indexBuffer,indexType:this.mesh.indexType}}get primitive(){return this.material.assertReady(),this._primitive}destroy(t){t.removeVertexTable(this.vertexTable),t.removeRenderPipeline(this.pipeline)}}class di extends fi{constructor(t,e,r,n){super(t,e,r,n)}bindSkeleton(t){this.skeleton=t}}const mi={opaque:new class{constructor(t,e,r){this.defaultCullMode=t,this.defaultDepthState=e,this.renderFormat=r,this.primitives=[]}push(t){this.primitives.push(t)}}(_.Back,{depthWriteEnabled:!0,depthTestEnabled:!0},{blendingEnabled:!1})};function pi(t){const e={};let r=0;const n=Object.keys(t);for(let i=0;i<n.length;i++){const s=t[n[i]];e[n[i]]=Object.assign(Object.assign({},s),{offset:r}),r+=M(s.type)*bn(s.count,1)}return e}class gi{constructor(t,e,r){this.bufferSize=0,this.bufferLayout=r;const n=Object.keys(this.bufferLayout);let i=this.bufferLayout[n[0]];for(let t=1;t<n.length;t++){const e=this.bufferLayout[n[t]];e.offset>i.offset&&(i=e)}this.bufferSize=i.offset+vi(i),this.bufferData=new ArrayBuffer(this.bufferSize),this.bufferBytes=new Uint8Array(this.bufferData),this.bufferFloats=new Float32Array(this.bufferData),this.buffer=e.createBuffer(t,g.Uniform,y.Dynamic,this.bufferSize)}getBufferView(){return{buffer:this.buffer,byteOffset:0}}getBufferLayout(){return this.bufferLayout}setFloat(t,e){const r=_n(this.bufferLayout[t],`Attempted to set unknown uniform ${t}`);this.bufferFloats[r.offset/4]=e}setVec2(t,e){const r=_n(this.bufferLayout[t],`Attempted to set unknown uniform ${t}`);this.bufferFloats.set(e,r.offset/4)}setVec3(t,e){const r=_n(this.bufferLayout[t],`Attempted to set unknown uniform ${t}`);this.bufferFloats.set(e,r.offset/4)}setVec4(t,e){const r=_n(this.bufferLayout[t],`Attempted to set unknown uniform ${t}`);this.bufferFloats.set(e,r.offset/4)}setMat4(t,e){const r=_n(this.bufferLayout[t],`Attempted to set unknown uniform ${t}`);this.bufferFloats.set(e,r.offset/4)}setBytes(t,e){const r=_n(this.bufferLayout[t],`Attempted to set unknown uniform ${t}`);if(e.length!==vi(r))throw new Error("Invalid size");this.bufferBytes.set(e,r.offset)}setFloats(t,e){const r=_n(this.bufferLayout[t],`Attempted to set unknown uniform ${t}`);if(e.length!==vi(r)/4)throw new Error("Invalid size");this.bufferFloats.set(e,r.offset/4)}getFloatArray(t){const e=this.bufferLayout[t];if(!e)throw new Error(`Attempted to set unknown uniform ${t}`);return new Float32Array(this.bufferData,e.offset,vi(e)/4)}write(t){t.writeBufferData(this.buffer,0,this.bufferBytes)}terminate(t){t.removeBuffer(this.buffer)}}function vi(t){return M(t.type)*bn(t.count,1)}class yi{constructor(){this.models=[],this.skinnedModels=[]}initialize(t){this.avatars=t}onResourcesLoaded(t,{gfxDevice:e}){for(const r of this.avatars)for(let n=0;n<r.nodes.length;n++){const i=r.nodes[n];if(xn(i.skinId)){const n=_n(i.meshId);yn(0===i.skinId),this.loadSkinnedModel(e,t,i,n,r.skeleton)}else xn(i.meshId)&&this.loadModel(e,t,i,i.meshId)}}createMaterial(t,e,r){const n=r.materials[e.materialIndex],i=_n(n.technique),a=i.shaderId,o=function(t){const e={},r=[];for(const n of Object.keys(t.uniforms)){const i=t.uniforms[n];i.type===c.Texture2D?r.push(n):e[n]=i}const n=pi(e),i={uniforms:{index:0,type:v.UniformBuffer,layout:n}};for(let t=0;t<r.length;t++){i[r[t]]={index:t,type:v.Texture}}return i}(i),u=new li(t,n.name,a,o),h=o.uniforms.layout,l=new gi(n.name,t,h);if(u.setUniformBuffer(t,"uniforms",l),i){const e=_n(n.values);for(const n of Object.keys(i.uniforms)){const s=i.uniforms[n],a=bn(e[n],s.value);if(xn(a))if(s.type===c.Texture2D){const e=r.textures[a.index].id;u.setTexture(t,n,e)}else l.setFloats(n,a)}l.setVec4("u_Color0",s.fromValues(.4266,.4171,.5057,1))}else l.setVec4("u_color",s.fromValues(0,1,0,1));return u}loadSkinnedModel(t,e,r,n,i){const s=e.meshes[n];for(let n of s.primitives){const s=this.createMaterial(t,n,e),a=new di(t,mi.opaque,n.mesh,s);a.bindSkeleton(i),this.skinnedModels.push(a),r.add(a)}}loadModel(t,e,r,n){const i=e.meshes[n];for(let n of i.primitives){const i=this.createMaterial(t,n,e),s=new fi(t,mi.opaque,n.mesh,i);this.models.push(s),r.add(s)}}render({gfxDevice:t,camera:e}){for(let r=0;r<this.skinnedModels.length;r++){const i=this.skinnedModels[r],s=i.material.getUniformBuffer("uniforms");s.getFloatArray("u_joints").set(i.skeleton.boneMatrices);const a=new Float32Array(i.matrixWorld.elements);xn(s.getBufferLayout().u_modelViewProjection)&&s.setMat4("u_modelViewProjection",n.multiply(n.create(),e.viewProjMatrix,a)),xn(s.getBufferLayout().u_modelViewProjection)&&s.setMat4("u_model",a),s.write(t),i.renderList.push(i.primitive)}for(let r=0;r<this.models.length;r++){const i=this.models[r],s=new Float32Array(i.matrixWorld.elements),a=i.material.getUniformBuffer("uniforms");a.setMat4("u_modelViewProjection",n.multiply(n.create(),e.viewProjMatrix,s)),a.write(t),i.renderList.push(i.primitive)}}}function _i(t,e,r,n){this.parameterPositions=t,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new e.constructor(r),this.sampleValues=e,this.valueSize=r}function xi(t,e,r,n){_i.call(this,t,e,r,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}function bi(t,e,r,n){_i.call(this,t,e,r,n)}function Mi(t,e,r,n){_i.call(this,t,e,r,n)}Object.assign(_i.prototype,{evaluate:function(t){var e=this.parameterPositions,r=this._cachedIndex,n=e[r],i=e[r-1];t:{e:{var s;r:{n:if(!(t<n)){for(var a=r+2;;){if(void 0===n){if(t<i)break n;return r=e.length,this._cachedIndex=r,this.afterEnd_(r-1,t,i)}if(r===a)break;if(i=n,t<(n=e[++r]))break e}s=e.length;break r}if(t>=i)break t;var o=e[1];t<o&&(r=2,i=o);for(a=r-2;;){if(void 0===i)return this._cachedIndex=0,this.beforeStart_(0,t,n);if(r===a)break;if(n=i,t>=(i=e[--r-1]))break e}s=r,r=0}for(;r<s;){var u=r+s>>>1;t<e[u]?s=u:r=u+1}if(n=e[r],void 0===(i=e[r-1]))return this._cachedIndex=0,this.beforeStart_(0,t,n);if(void 0===n)return r=e.length,this._cachedIndex=r,this.afterEnd_(r-1,i,t)}this._cachedIndex=r,this.intervalChanged_(r,i,n)}return this.interpolate_(r,i,t,n)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(t){for(var e=this.resultBuffer,r=this.sampleValues,n=this.valueSize,i=t*n,s=0;s!==n;++s)e[s]=r[i+s];return e},interpolate_:function(){throw new Error("call to abstract method")},intervalChanged_:function(){}}),Object.assign(_i.prototype,{beforeStart_:_i.prototype.copySampleValue_,afterEnd_:_i.prototype.copySampleValue_}),xi.prototype=Object.assign(Object.create(_i.prototype),{constructor:xi,DefaultSettings_:{endingStart:2400,endingEnd:2400},intervalChanged_:function(t,e,r){var n=this.parameterPositions,i=t-2,s=t+1,a=n[i],o=n[s];if(void 0===a)switch(this.getSettings_().endingStart){case 2401:i=t,a=2*e-r;break;case 2402:a=e+n[i=n.length-2]-n[i+1];break;default:i=t,a=r}if(void 0===o)switch(this.getSettings_().endingEnd){case 2401:s=t,o=2*r-e;break;case 2402:s=1,o=r+n[1]-n[0];break;default:s=t-1,o=e}var u=.5*(r-e),h=this.valueSize;this._weightPrev=u/(e-a),this._weightNext=u/(o-r),this._offsetPrev=i*h,this._offsetNext=s*h},interpolate_:function(t,e,r,n){for(var i=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=t*a,u=o-a,h=this._offsetPrev,c=this._offsetNext,l=this._weightPrev,f=this._weightNext,d=(r-e)/(n-e),m=d*d,p=m*d,g=-l*p+2*l*m-l*d,v=(1+l)*p+(-1.5-2*l)*m+(-.5+l)*d+1,y=(-1-f)*p+(1.5+f)*m+.5*d,_=f*p-f*m,x=0;x!==a;++x)i[x]=g*s[h+x]+v*s[u+x]+y*s[o+x]+_*s[c+x];return i}}),bi.prototype=Object.assign(Object.create(_i.prototype),{constructor:bi,interpolate_:function(t,e,r,n){for(var i=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=t*a,u=o-a,h=(r-e)/(n-e),c=1-h,l=0;l!==a;++l)i[l]=s[u+l]*c+s[o+l]*h;return i}}),Mi.prototype=Object.assign(Object.create(_i.prototype),{constructor:Mi,interpolate_:function(t){return this.copySampleValue_(t-1)}});var wi={arraySlice:function(t,e,r){return wi.isTypedArray(t)?new t.constructor(t.subarray(e,void 0!==r?r:t.length)):t.slice(e,r)},convertArray:function(t,e,r){return!t||!r&&t.constructor===e?t:"number"==typeof e.BYTES_PER_ELEMENT?new e(t):Array.prototype.slice.call(t)},isTypedArray:function(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)},getKeyframeOrder:function(t){for(var e=t.length,r=new Array(e),n=0;n!==e;++n)r[n]=n;return r.sort((function(e,r){return t[e]-t[r]})),r},sortedArray:function(t,e,r){for(var n=t.length,i=new t.constructor(n),s=0,a=0;a!==n;++s)for(var o=r[s]*e,u=0;u!==e;++u)i[a++]=t[o+u];return i},flattenJSON:function(t,e,r,n){for(var i=1,s=t[0];void 0!==s&&void 0===s[n];)s=t[i++];if(void 0!==s){var a=s[n];if(void 0!==a)if(Array.isArray(a))do{void 0!==(a=s[n])&&(e.push(s.time),r.push.apply(r,a)),s=t[i++]}while(void 0!==s);else if(void 0!==a.toArray)do{void 0!==(a=s[n])&&(e.push(s.time),a.toArray(r,r.length)),s=t[i++]}while(void 0!==s);else do{void 0!==(a=s[n])&&(e.push(s.time),r.push(a)),s=t[i++]}while(void 0!==s)}},subclip:function(t,e,r,n,i){i=i||30;var s=t.clone();s.name=e;for(var a=[],o=0;o<s.tracks.length;++o){for(var u=s.tracks[o],h=u.getValueSize(),c=[],l=[],f=0;f<u.times.length;++f){var d=u.times[f]*i;if(!(d<r||d>=n)){c.push(u.times[f]);for(var m=0;m<h;++m)l.push(u.values[f*h+m])}}0!==c.length&&(u.times=wi.convertArray(c,u.times.constructor),u.values=wi.convertArray(l,u.values.constructor),a.push(u))}s.tracks=a;var p=1/0;for(o=0;o<s.tracks.length;++o)p>s.tracks[o].times[0]&&(p=s.tracks[o].times[0]);for(o=0;o<s.tracks.length;++o)s.tracks[o].shift(-1*p);return s.resetDuration(),s}};function Ti(t,e,r,n){if(void 0===t)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===e||0===e.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+t);this.name=t,this.times=wi.convertArray(e,this.TimeBufferType),this.values=wi.convertArray(r,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation)}function Ai(t,e,r,n){_i.call(this,t,e,r,n)}function Si(t,e,r,n){Ti.call(this,t,e,r,n)}function Ei(t,e,r,n){Ti.call(this,t,e,r,n)}function Ii(t,e,r){Ti.call(this,t,e,r)}function Fi(t,e,r,n){Ti.call(this,t,e,r,n)}function Ui(t,e,r,n){Ti.call(this,t,e,r,n)}function Ci(t,e,r,n){Ti.call(this,t,e,r,n)}function Ni(t,e,r){this.name=t,this.tracks=r,this.duration=void 0!==e?e:-1,this.uuid=En.generateUUID(),this.duration<0&&this.resetDuration()}function Ri(t){if(void 0===t.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");var e=function(t){switch(t.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return Ui;case"vector":case"vector2":case"vector3":case"vector4":return Ei;case"color":return Fi;case"quaternion":return Si;case"bool":case"boolean":return Ii;case"string":return Ci}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+t)}(t.type);if(void 0===t.times){var r=[],n=[];wi.flattenJSON(t.keys,r,n,"value"),t.times=r,t.values=n}return void 0!==e.parse?e.parse(t):new e(t.name,t.times,t.values,t.interpolation)}function Oi(t,e,r){this._mixer=t,this._clip=e,this._localRoot=r||null;for(var n=e.tracks,i=n.length,s=new Array(i),a={endingStart:2400,endingEnd:2400},o=0;o!==i;++o){var u=n[o].createInterpolant(null);s[o]=u,u.settings=a}this._interpolantSettings=a,this._interpolants=s,this._propertyBindings=new Array(i),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=2201,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}Object.assign(Ti,{toJSON:function(t){var e,r=t.constructor;if(void 0!==r.toJSON)e=r.toJSON(t);else{e={name:t.name,times:wi.convertArray(t.times,Array),values:wi.convertArray(t.values,Array)};var n=t.getInterpolation();n!==t.DefaultInterpolation&&(e.interpolation=n)}return e.type=t.ValueTypeName,e}}),Object.assign(Ti.prototype,{constructor:Ti,TimeBufferType:Float32Array,ValueBufferType:Float32Array,DefaultInterpolation:2301,InterpolantFactoryMethodDiscrete:function(t){return new Mi(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodLinear:function(t){return new bi(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodSmooth:function(t){return new xi(this.times,this.values,this.getValueSize(),t)},setInterpolation:function(t){var e;switch(t){case 2300:e=this.InterpolantFactoryMethodDiscrete;break;case 2301:e=this.InterpolantFactoryMethodLinear;break;case 2302:e=this.InterpolantFactoryMethodSmooth}if(void 0===e){var r="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(t===this.DefaultInterpolation)throw new Error(r);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",r),this}return this.createInterpolant=e,this},getInterpolation:function(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return 2300;case this.InterpolantFactoryMethodLinear:return 2301;case this.InterpolantFactoryMethodSmooth:return 2302}},getValueSize:function(){return this.values.length/this.times.length},shift:function(t){if(0!==t)for(var e=this.times,r=0,n=e.length;r!==n;++r)e[r]+=t;return this},scale:function(t){if(1!==t)for(var e=this.times,r=0,n=e.length;r!==n;++r)e[r]*=t;return this},trim:function(t,e){for(var r=this.times,n=r.length,i=0,s=n-1;i!==n&&r[i]<t;)++i;for(;-1!==s&&r[s]>e;)--s;if(++s,0!==i||s!==n){i>=s&&(i=(s=Math.max(s,1))-1);var a=this.getValueSize();this.times=wi.arraySlice(r,i,s),this.values=wi.arraySlice(this.values,i*a,s*a)}return this},validate:function(){var t=!0,e=this.getValueSize();e-Math.floor(e)!=0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),t=!1);var r=this.times,n=this.values,i=r.length;0===i&&(console.error("THREE.KeyframeTrack: Track is empty.",this),t=!1);for(var s=null,a=0;a!==i;a++){var o=r[a];if("number"==typeof o&&isNaN(o)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,a,o),t=!1;break}if(null!==s&&s>o){console.error("THREE.KeyframeTrack: Out of order keys.",this,a,o,s),t=!1;break}s=o}if(void 0!==n&&wi.isTypedArray(n)){a=0;for(var u=n.length;a!==u;++a){var h=n[a];if(isNaN(h)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,a,h),t=!1;break}}}return t},optimize:function(){for(var t=wi.arraySlice(this.times),e=wi.arraySlice(this.values),r=this.getValueSize(),n=2302===this.getInterpolation(),i=1,s=t.length-1,a=1;a<s;++a){var o=!1,u=t[a];if(u!==t[a+1]&&(1!==a||u!==u[0]))if(n)o=!0;else for(var h=a*r,c=h-r,l=h+r,f=0;f!==r;++f){var d=e[h+f];if(d!==e[c+f]||d!==e[l+f]){o=!0;break}}if(o){if(a!==i){t[i]=t[a];var m=a*r,p=i*r;for(f=0;f!==r;++f)e[p+f]=e[m+f]}++i}}if(s>0){t[i]=t[s];for(m=s*r,p=i*r,f=0;f!==r;++f)e[p+f]=e[m+f];++i}return i!==t.length?(this.times=wi.arraySlice(t,0,i),this.values=wi.arraySlice(e,0,i*r)):(this.times=t,this.values=e),this},clone:function(){var t=wi.arraySlice(this.times,0),e=wi.arraySlice(this.values,0),r=new(0,this.constructor)(this.name,t,e);return r.createInterpolant=this.createInterpolant,r}}),Ai.prototype=Object.assign(Object.create(_i.prototype),{constructor:Ai,interpolate_:function(t,e,r,n){for(var i=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=t*a,u=(r-e)/(n-e),h=o+a;o!==h;o+=4)In.slerpFlat(i,0,s,o-a,s,o,u);return i}}),Si.prototype=Object.assign(Object.create(Ti.prototype),{constructor:Si,ValueTypeName:"quaternion",DefaultInterpolation:2301,InterpolantFactoryMethodLinear:function(t){return new Ai(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodSmooth:void 0}),Ei.prototype=Object.assign(Object.create(Ti.prototype),{constructor:Ei,ValueTypeName:"vector"}),Ii.prototype=Object.assign(Object.create(Ti.prototype),{constructor:Ii,ValueTypeName:"bool",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),Fi.prototype=Object.assign(Object.create(Ti.prototype),{constructor:Fi,ValueTypeName:"color"}),Ui.prototype=Object.assign(Object.create(Ti.prototype),{constructor:Ui,ValueTypeName:"number"}),Ci.prototype=Object.assign(Object.create(Ti.prototype),{constructor:Ci,ValueTypeName:"string",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),Object.assign(Ni,{parse:function(t){for(var e=[],r=t.tracks,n=1/(t.fps||1),i=0,s=r.length;i!==s;++i)e.push(Ri(r[i]).scale(n));return new Ni(t.name,t.duration,e)},toJSON:function(t){for(var e=[],r=t.tracks,n={name:t.name,duration:t.duration,tracks:e,uuid:t.uuid},i=0,s=r.length;i!==s;++i)e.push(Ti.toJSON(r[i]));return n},CreateFromMorphTargetSequence:function(t,e,r,n){for(var i=e.length,s=[],a=0;a<i;a++){var o=[],u=[];o.push((a+i-1)%i,a,(a+1)%i),u.push(0,1,0);var h=wi.getKeyframeOrder(o);o=wi.sortedArray(o,1,h),u=wi.sortedArray(u,1,h),n||0!==o[0]||(o.push(i),u.push(u[0])),s.push(new Ui(".morphTargetInfluences["+e[a].name+"]",o,u).scale(1/r))}return new Ni(t,-1,s)},findByName:function(t,e){var r=t;if(!Array.isArray(t)){var n=t;r=n.geometry&&n.geometry.animations||n.animations}for(var i=0;i<r.length;i++)if(r[i].name===e)return r[i];return null},CreateClipsFromMorphTargetSequences:function(t,e,r){for(var n={},i=/^([\w-]*?)([\d]+)$/,s=0,a=t.length;s<a;s++){var o=t[s],u=o.name.match(i);if(u&&u.length>1){var h=n[l=u[1]];h||(n[l]=h=[]),h.push(o)}}var c=[];for(var l in n)c.push(Ni.CreateFromMorphTargetSequence(l,n[l],e,r));return c},parseAnimation:function(t,e){if(!t)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;for(var r=function(t,e,r,n,i){if(0!==r.length){var s=[],a=[];wi.flattenJSON(r,s,a,n),0!==s.length&&i.push(new t(e,s,a))}},n=[],i=t.name||"default",s=t.length||-1,a=t.fps||30,o=t.hierarchy||[],u=0;u<o.length;u++){var h=o[u].keys;if(h&&0!==h.length)if(h[0].morphTargets){for(var c={},l=0;l<h.length;l++)if(h[l].morphTargets)for(var f=0;f<h[l].morphTargets.length;f++)c[h[l].morphTargets[f]]=-1;for(var d in c){var m=[],p=[];for(f=0;f!==h[l].morphTargets.length;++f){var g=h[l];m.push(g.time),p.push(g.morphTarget===d?1:0)}n.push(new Ui(".morphTargetInfluence["+d+"]",m,p))}s=c.length*(a||1)}else{var v=".bones["+e[u].name+"]";r(Ei,v+".position",h,"pos",n),r(Si,v+".quaternion",h,"rot",n),r(Ei,v+".scale",h,"scl",n)}}return 0===n.length?null:new Ni(i,s,n)}}),Object.assign(Ni.prototype,{resetDuration:function(){for(var t=0,e=0,r=this.tracks.length;e!==r;++e){var n=this.tracks[e];t=Math.max(t,n.times[n.times.length-1])}return this.duration=t,this},trim:function(){for(var t=0;t<this.tracks.length;t++)this.tracks[t].trim(0,this.duration);return this},validate:function(){for(var t=!0,e=0;e<this.tracks.length;e++)t=t&&this.tracks[e].validate();return t},optimize:function(){for(var t=0;t<this.tracks.length;t++)this.tracks[t].optimize();return this},clone:function(){for(var t=[],e=0;e<this.tracks.length;e++)t.push(this.tracks[e].clone());return new Ni(this.name,this.duration,t)}}),Object.assign(Oi.prototype,{play:function(){return this._mixer._activateAction(this),this},stop:function(){return this._mixer._deactivateAction(this),this.reset()},reset:function(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()},isRunning:function(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)},isScheduled:function(){return this._mixer._isActiveAction(this)},startAt:function(t){return this._startTime=t,this},setLoop:function(t,e){return this.loop=t,this.repetitions=e,this},setEffectiveWeight:function(t){return this.weight=t,this._effectiveWeight=this.enabled?t:0,this.stopFading()},getEffectiveWeight:function(){return this._effectiveWeight},fadeIn:function(t){return this._scheduleFading(t,0,1)},fadeOut:function(t){return this._scheduleFading(t,1,0)},crossFadeFrom:function(t,e,r){if(t.fadeOut(e),this.fadeIn(e),r){var n=this._clip.duration,i=t._clip.duration,s=i/n,a=n/i;t.warp(1,s,e),this.warp(a,1,e)}return this},crossFadeTo:function(t,e,r){return t.crossFadeFrom(this,e,r)},stopFading:function(){var t=this._weightInterpolant;return null!==t&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this},setEffectiveTimeScale:function(t){return this.timeScale=t,this._effectiveTimeScale=this.paused?0:t,this.stopWarping()},getEffectiveTimeScale:function(){return this._effectiveTimeScale},setDuration:function(t){return this.timeScale=this._clip.duration/t,this.stopWarping()},syncWith:function(t){return this.time=t.time,this.timeScale=t.timeScale,this.stopWarping()},halt:function(t){return this.warp(this._effectiveTimeScale,0,t)},warp:function(t,e,r){var n=this._mixer,i=n.time,s=this._timeScaleInterpolant,a=this.timeScale;null===s&&(s=n._lendControlInterpolant(),this._timeScaleInterpolant=s);var o=s.parameterPositions,u=s.sampleValues;return o[0]=i,o[1]=i+r,u[0]=t/a,u[1]=e/a,this},stopWarping:function(){var t=this._timeScaleInterpolant;return null!==t&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this},getMixer:function(){return this._mixer},getClip:function(){return this._clip},getRoot:function(){return this._localRoot||this._mixer._root},_update:function(t,e,r,n){if(this.enabled){var i=this._startTime;if(null!==i){var s=(t-i)*r;if(s<0||0===r)return;this._startTime=null,e=r*s}e*=this._updateTimeScale(t);var a=this._updateTime(e),o=this._updateWeight(t);if(o>0)for(var u=this._interpolants,h=this._propertyBindings,c=0,l=u.length;c!==l;++c)u[c].evaluate(a),h[c].accumulate(n,o)}else this._updateWeight(t)},_updateWeight:function(t){var e=0;if(this.enabled){e=this.weight;var r=this._weightInterpolant;if(null!==r){var n=r.evaluate(t)[0];e*=n,t>r.parameterPositions[1]&&(this.stopFading(),0===n&&(this.enabled=!1))}}return this._effectiveWeight=e,e},_updateTimeScale:function(t){var e=0;if(!this.paused){e=this.timeScale;var r=this._timeScaleInterpolant;if(null!==r)e*=r.evaluate(t)[0],t>r.parameterPositions[1]&&(this.stopWarping(),0===e?this.paused=!0:this.timeScale=e)}return this._effectiveTimeScale=e,e},_updateTime:function(t){var e=this.time+t,r=this._clip.duration,n=this.loop,i=this._loopCount,s=2202===n;if(0===t)return-1===i?e:s&&1==(1&i)?r-e:e;if(2200===n){-1===i&&(this._loopCount=0,this._setEndings(!0,!0,!1));t:{if(e>=r)e=r;else{if(!(e<0)){this.time=e;break t}e=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=e,this._mixer.dispatchEvent({type:"finished",action:this,direction:t<0?-1:1})}}else{if(-1===i&&(t>=0?(i=0,this._setEndings(!0,0===this.repetitions,s)):this._setEndings(0===this.repetitions,!0,s)),e>=r||e<0){var a=Math.floor(e/r);e-=r*a,i+=Math.abs(a);var o=this.repetitions-i;if(o<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,e=t>0?r:0,this.time=e,this._mixer.dispatchEvent({type:"finished",action:this,direction:t>0?1:-1});else{if(1===o){var u=t<0;this._setEndings(u,!u,s)}else this._setEndings(!1,!1,s);this._loopCount=i,this.time=e,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:a})}}else this.time=e;if(s&&1==(1&i))return r-e}return e},_setEndings:function(t,e,r){var n=this._interpolantSettings;r?(n.endingStart=2401,n.endingEnd=2401):(n.endingStart=t?this.zeroSlopeAtStart?2401:2400:2402,n.endingEnd=e?this.zeroSlopeAtEnd?2401:2400:2402)},_scheduleFading:function(t,e,r){var n=this._mixer,i=n.time,s=this._weightInterpolant;null===s&&(s=n._lendControlInterpolant(),this._weightInterpolant=s);var a=s.parameterPositions,o=s.sampleValues;return a[0]=i,o[0]=e,a[1]=i+t,o[1]=r,this}});var ki=new RegExp("[\\[\\]\\.:\\/]","g"),Bi="[^"+"\\[\\]\\.:\\/".replace("\\.","")+"]",zi=/((?:WC+[\/:])*)/.source.replace("WC","[^\\[\\]\\.:\\/]"),Li=/(WCOD+)?/.source.replace("WCOD",Bi),Di=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC","[^\\[\\]\\.:\\/]"),Pi=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC","[^\\[\\]\\.:\\/]"),Vi=new RegExp("^"+zi+Li+Di+Pi+"$"),ji=["material","materials","bones"];function Gi(t,e,r){var n=r||qi.parseTrackName(e);this._targetGroup=t,this._bindings=t.subscribe_(e,n)}function qi(t,e,r){this.path=e,this.parsedPath=r||qi.parseTrackName(e),this.node=qi.findNode(t,this.parsedPath.nodeName)||t,this.rootNode=t}function Wi(t,e,r){this.binding=t,this.valueSize=r;var n,i=Float64Array;switch(e){case"quaternion":n=this._slerp;break;case"string":case"bool":i=Array,n=this._select;break;default:n=this._lerp}this.buffer=new i(4*r),this._mixBufferRegion=n,this.cumulativeWeight=0,this.useCount=0,this.referenceCount=0}function Hi(t){this._root=t,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}function Xi(){si.call(this),this.type="Bone"}Object.assign(Gi.prototype,{getValue:function(t,e){this.bind();var r=this._targetGroup.nCachedObjects_,n=this._bindings[r];void 0!==n&&n.getValue(t,e)},setValue:function(t,e){for(var r=this._bindings,n=this._targetGroup.nCachedObjects_,i=r.length;n!==i;++n)r[n].setValue(t,e)},bind:function(){for(var t=this._bindings,e=this._targetGroup.nCachedObjects_,r=t.length;e!==r;++e)t[e].bind()},unbind:function(){for(var t=this._bindings,e=this._targetGroup.nCachedObjects_,r=t.length;e!==r;++e)t[e].unbind()}}),Object.assign(qi,{Composite:Gi,create:function(t,e,r){return t&&t.isAnimationObjectGroup?new qi.Composite(t,e,r):new qi(t,e,r)},sanitizeNodeName:function(t){return t.replace(/\s/g,"_").replace(ki,"")},parseTrackName:function(t){var e=Vi.exec(t);if(!e)throw new Error("PropertyBinding: Cannot parse trackName: "+t);var r={nodeName:e[2],objectName:e[3],objectIndex:e[4],propertyName:e[5],propertyIndex:e[6]},n=r.nodeName&&r.nodeName.lastIndexOf(".");if(void 0!==n&&-1!==n){var i=r.nodeName.substring(n+1);-1!==ji.indexOf(i)&&(r.nodeName=r.nodeName.substring(0,n),r.objectName=i)}if(null===r.propertyName||0===r.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+t);return r},findNode:function(t,e){if(!e||""===e||"."===e||-1===e||e===t.name||e===t.uuid)return t;if(t.skeleton){var r=t.skeleton.getBoneByName(e);if(void 0!==r)return r}if(t.children){var n=function(t){for(var r=0;r<t.length;r++){var i=t[r];if(i.name===e||i.uuid===e)return i;var s=n(i.children);if(s)return s}return null},i=n(t.children);if(i)return i}return null}}),Object.assign(qi.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function(t,e){t[e]=this.node[this.propertyName]},function(t,e){for(var r=this.resolvedProperty,n=0,i=r.length;n!==i;++n)t[e++]=r[n]},function(t,e){t[e]=this.resolvedProperty[this.propertyIndex]},function(t,e){this.resolvedProperty.toArray(t,e)}],SetterByBindingTypeAndVersioning:[[function(t,e){this.targetObject[this.propertyName]=t[e]},function(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.needsUpdate=!0},function(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){for(var r=this.resolvedProperty,n=0,i=r.length;n!==i;++n)r[n]=t[e++]},function(t,e){for(var r=this.resolvedProperty,n=0,i=r.length;n!==i;++n)r[n]=t[e++];this.targetObject.needsUpdate=!0},function(t,e){for(var r=this.resolvedProperty,n=0,i=r.length;n!==i;++n)r[n]=t[e++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){this.resolvedProperty[this.propertyIndex]=t[e]},function(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.needsUpdate=!0},function(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){this.resolvedProperty.fromArray(t,e)},function(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.needsUpdate=!0},function(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function(t,e){this.bind(),this.getValue(t,e)},setValue:function(t,e){this.bind(),this.setValue(t,e)},bind:function(){var t=this.node,e=this.parsedPath,r=e.objectName,n=e.propertyName,i=e.propertyIndex;if(t||(t=qi.findNode(this.rootNode,e.nodeName)||this.rootNode,this.node=t),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,t){if(r){var s=e.objectIndex;switch(r){case"materials":if(!t.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!t.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);t=t.material.materials;break;case"bones":if(!t.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);t=t.skeleton.bones;for(var a=0;a<t.length;a++)if(t[a].name===s){s=a;break}break;default:if(void 0===t[r])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);t=t[r]}if(void 0!==s){if(void 0===t[s])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,t);t=t[s]}}var o=t[n];if(void 0!==o){var u=this.Versioning.None;this.targetObject=t,void 0!==t.needsUpdate?u=this.Versioning.NeedsUpdate:void 0!==t.matrixWorldNeedsUpdate&&(u=this.Versioning.MatrixWorldNeedsUpdate);var h=this.BindingType.Direct;if(void 0!==i){if("morphTargetInfluences"===n){if(!t.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(t.geometry.isBufferGeometry){if(!t.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);for(a=0;a<this.node.geometry.morphAttributes.position.length;a++)if(t.geometry.morphAttributes.position[a].name===i){i=a;break}}else{if(!t.geometry.morphTargets)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphTargets.",this);for(a=0;a<this.node.geometry.morphTargets.length;a++)if(t.geometry.morphTargets[a].name===i){i=a;break}}}h=this.BindingType.ArrayElement,this.resolvedProperty=o,this.propertyIndex=i}else void 0!==o.fromArray&&void 0!==o.toArray?(h=this.BindingType.HasFromToArray,this.resolvedProperty=o):Array.isArray(o)?(h=this.BindingType.EntireArray,this.resolvedProperty=o):this.propertyName=n;this.getValue=this.GetterByBindingType[h],this.setValue=this.SetterByBindingTypeAndVersioning[h][u]}else{var c=e.nodeName;console.error("THREE.PropertyBinding: Trying to update property for track: "+c+"."+n+" but it wasn't found.",t)}}else console.error("THREE.PropertyBinding: Trying to update node for track: "+this.path+" but it wasn't found.")},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}),Object.assign(qi.prototype,{_getValue_unbound:qi.prototype.getValue,_setValue_unbound:qi.prototype.setValue}),Object.assign(Wi.prototype,{accumulate:function(t,e){var r=this.buffer,n=this.valueSize,i=t*n+n,s=this.cumulativeWeight;if(0===s){for(var a=0;a!==n;++a)r[i+a]=r[a];s=e}else{var o=e/(s+=e);this._mixBufferRegion(r,i,0,o,n)}this.cumulativeWeight=s},apply:function(t){var e=this.valueSize,r=this.buffer,n=t*e+e,i=this.cumulativeWeight,s=this.binding;if(this.cumulativeWeight=0,i<1){var a=3*e;this._mixBufferRegion(r,n,a,1-i,e)}for(var o=e,u=e+e;o!==u;++o)if(r[o]!==r[o+e]){s.setValue(r,n);break}},saveOriginalState:function(){var t=this.binding,e=this.buffer,r=this.valueSize,n=3*r;t.getValue(e,n);for(var i=r,s=n;i!==s;++i)e[i]=e[n+i%r];this.cumulativeWeight=0},restoreOriginalState:function(){var t=3*this.valueSize;this.binding.setValue(this.buffer,t)},_select:function(t,e,r,n,i){if(n>=.5)for(var s=0;s!==i;++s)t[e+s]=t[r+s]},_slerp:function(t,e,r,n){In.slerpFlat(t,e,t,e,t,r,n)},_lerp:function(t,e,r,n,i){for(var s=1-n,a=0;a!==i;++a){var o=e+a;t[o]=t[o]*s+t[r+a]*n}}}),Hi.prototype=Object.assign(Object.create(Pn.prototype),{constructor:Hi,_bindAction:function(t,e){var r=t._localRoot||this._root,n=t._clip.tracks,i=n.length,s=t._propertyBindings,a=t._interpolants,o=r.uuid,u=this._bindingsByRootAndName,h=u[o];void 0===h&&(h={},u[o]=h);for(var c=0;c!==i;++c){var l=n[c],f=l.name,d=h[f];if(void 0!==d)s[c]=d;else{if(void 0!==(d=s[c])){null===d._cacheIndex&&(++d.referenceCount,this._addInactiveBinding(d,o,f));continue}var m=e&&e._propertyBindings[c].binding.parsedPath;++(d=new Wi(qi.create(r,f,m),l.ValueTypeName,l.getValueSize())).referenceCount,this._addInactiveBinding(d,o,f),s[c]=d}a[c].resultBuffer=d.buffer}},_activateAction:function(t){if(!this._isActiveAction(t)){if(null===t._cacheIndex){var e=(t._localRoot||this._root).uuid,r=t._clip.uuid,n=this._actionsByClip[r];this._bindAction(t,n&&n.knownActions[0]),this._addInactiveAction(t,r,e)}for(var i=t._propertyBindings,s=0,a=i.length;s!==a;++s){var o=i[s];0==o.useCount++&&(this._lendBinding(o),o.saveOriginalState())}this._lendAction(t)}},_deactivateAction:function(t){if(this._isActiveAction(t)){for(var e=t._propertyBindings,r=0,n=e.length;r!==n;++r){var i=e[r];0==--i.useCount&&(i.restoreOriginalState(),this._takeBackBinding(i))}this._takeBackAction(t)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;var t=this;this.stats={actions:{get total(){return t._actions.length},get inUse(){return t._nActiveActions}},bindings:{get total(){return t._bindings.length},get inUse(){return t._nActiveBindings}},controlInterpolants:{get total(){return t._controlInterpolants.length},get inUse(){return t._nActiveControlInterpolants}}}},_isActiveAction:function(t){var e=t._cacheIndex;return null!==e&&e<this._nActiveActions},_addInactiveAction:function(t,e,r){var n=this._actions,i=this._actionsByClip,s=i[e];if(void 0===s)s={knownActions:[t],actionByRoot:{}},t._byClipCacheIndex=0,i[e]=s;else{var a=s.knownActions;t._byClipCacheIndex=a.length,a.push(t)}t._cacheIndex=n.length,n.push(t),s.actionByRoot[r]=t},_removeInactiveAction:function(t){var e=this._actions,r=e[e.length-1],n=t._cacheIndex;r._cacheIndex=n,e[n]=r,e.pop(),t._cacheIndex=null;var i=t._clip.uuid,s=this._actionsByClip,a=s[i],o=a.knownActions,u=o[o.length-1],h=t._byClipCacheIndex;u._byClipCacheIndex=h,o[h]=u,o.pop(),t._byClipCacheIndex=null,delete a.actionByRoot[(t._localRoot||this._root).uuid],0===o.length&&delete s[i],this._removeInactiveBindingsForAction(t)},_removeInactiveBindingsForAction:function(t){for(var e=t._propertyBindings,r=0,n=e.length;r!==n;++r){var i=e[r];0==--i.referenceCount&&this._removeInactiveBinding(i)}},_lendAction:function(t){var e=this._actions,r=t._cacheIndex,n=this._nActiveActions++,i=e[n];t._cacheIndex=n,e[n]=t,i._cacheIndex=r,e[r]=i},_takeBackAction:function(t){var e=this._actions,r=t._cacheIndex,n=--this._nActiveActions,i=e[n];t._cacheIndex=n,e[n]=t,i._cacheIndex=r,e[r]=i},_addInactiveBinding:function(t,e,r){var n=this._bindingsByRootAndName,i=n[e],s=this._bindings;void 0===i&&(i={},n[e]=i),i[r]=t,t._cacheIndex=s.length,s.push(t)},_removeInactiveBinding:function(t){var e=this._bindings,r=t.binding,n=r.rootNode.uuid,i=r.path,s=this._bindingsByRootAndName,a=s[n],o=e[e.length-1],u=t._cacheIndex;o._cacheIndex=u,e[u]=o,e.pop(),delete a[i],0===Object.keys(a).length&&delete s[n]},_lendBinding:function(t){var e=this._bindings,r=t._cacheIndex,n=this._nActiveBindings++,i=e[n];t._cacheIndex=n,e[n]=t,i._cacheIndex=r,e[r]=i},_takeBackBinding:function(t){var e=this._bindings,r=t._cacheIndex,n=--this._nActiveBindings,i=e[n];t._cacheIndex=n,e[n]=t,i._cacheIndex=r,e[r]=i},_lendControlInterpolant:function(){var t=this._controlInterpolants,e=this._nActiveControlInterpolants++,r=t[e];return void 0===r&&((r=new bi(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer)).__cacheIndex=e,t[e]=r),r},_takeBackControlInterpolant:function(t){var e=this._controlInterpolants,r=t.__cacheIndex,n=--this._nActiveControlInterpolants,i=e[n];t.__cacheIndex=n,e[n]=t,i.__cacheIndex=r,e[r]=i},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(t,e){var r=e||this._root,n=r.uuid,i="string"==typeof t?Ni.findByName(r,t):t,s=null!==i?i.uuid:t,a=this._actionsByClip[s],o=null;if(void 0!==a){var u=a.actionByRoot[n];if(void 0!==u)return u;o=a.knownActions[0],null===i&&(i=o._clip)}if(null===i)return null;var h=new Oi(this,i,e);return this._bindAction(h,o),this._addInactiveAction(h,s,n),h},existingAction:function(t,e){var r=e||this._root,n=r.uuid,i="string"==typeof t?Ni.findByName(r,t):t,s=i?i.uuid:t,a=this._actionsByClip[s];return void 0!==a&&a.actionByRoot[n]||null},stopAllAction:function(){var t=this._actions,e=this._nActiveActions,r=this._bindings,n=this._nActiveBindings;this._nActiveActions=0,this._nActiveBindings=0;for(var i=0;i!==e;++i)t[i].reset();for(i=0;i!==n;++i)r[i].useCount=0;return this},update:function(t){t*=this.timeScale;for(var e=this._actions,r=this._nActiveActions,n=this.time+=t,i=Math.sign(t),s=this._accuIndex^=1,a=0;a!==r;++a){e[a]._update(n,t,i,s)}var o=this._bindings,u=this._nActiveBindings;for(a=0;a!==u;++a)o[a].apply(s);return this},setTime:function(t){this.time=0;for(var e=0;e<this._actions.length;e++)this._actions[e].time=0;return this.update(t)},getRoot:function(){return this._root},uncacheClip:function(t){var e=this._actions,r=t.uuid,n=this._actionsByClip,i=n[r];if(void 0!==i){for(var s=i.knownActions,a=0,o=s.length;a!==o;++a){var u=s[a];this._deactivateAction(u);var h=u._cacheIndex,c=e[e.length-1];u._cacheIndex=null,u._byClipCacheIndex=null,c._cacheIndex=h,e[h]=c,e.pop(),this._removeInactiveBindingsForAction(u)}delete n[r]}},uncacheRoot:function(t){var e=t.uuid,r=this._actionsByClip;for(var n in r){var i=r[n].actionByRoot[e];void 0!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}var s=this._bindingsByRootAndName[e];if(void 0!==s)for(var a in s){var o=s[a];o.restoreOriginalState(),this._removeInactiveBinding(o)}},uncacheAction:function(t,e){var r=this.existingAction(t,e);null!==r&&(this._deactivateAction(r),this._removeInactiveAction(r))}}),Xi.prototype=Object.assign(Object.create(si.prototype),{constructor:Xi,isBone:!0});var Yi=new Dn,$i=new Dn;function Zi(t,e){if(t=t||[],this.bones=t.slice(0),this.boneMatrices=new Float32Array(16*this.bones.length),this.frame=-1,void 0===e)this.calculateInverses();else if(this.bones.length===e.length)this.boneInverses=e.slice(0);else{console.warn("THREE.Skeleton boneInverses is the wrong length."),this.boneInverses=[];for(var r=0,n=this.bones.length;r<n;r++)this.boneInverses.push(new Dn)}}Object.assign(Zi.prototype,{calculateInverses:function(){this.boneInverses=[];for(var t=0,e=this.bones.length;t<e;t++){var r=new Dn;this.bones[t]&&r.getInverse(this.bones[t].matrixWorld),this.boneInverses.push(r)}},pose:function(){var t,e,r;for(e=0,r=this.bones.length;e<r;e++)(t=this.bones[e])&&t.matrixWorld.getInverse(this.boneInverses[e]);for(e=0,r=this.bones.length;e<r;e++)(t=this.bones[e])&&(t.parent&&t.parent.isBone?(t.matrix.getInverse(t.parent.matrixWorld),t.matrix.multiply(t.matrixWorld)):t.matrix.copy(t.matrixWorld),t.matrix.decompose(t.position,t.quaternion,t.scale))},update:function(){for(var t=this.bones,e=this.boneInverses,r=this.boneMatrices,n=this.boneTexture,i=0,s=t.length;i<s;i++){var a=t[i]?t[i].matrixWorld:$i;Yi.multiplyMatrices(a,e[i]),Yi.toArray(r,16*i)}void 0!==n&&(n.needsUpdate=!0)},clone:function(){return new Zi(this.bones,this.boneInverses)},getBoneByName:function(t){for(var e=0,r=this.bones.length;e<r;e++){var n=this.bones[e];if(n.name===t)return n}},dispose:function(){this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=void 0)}});class Ji extends si{}class Ki{constructor(){this.localAvatar=new Ji,this.avatars=[this.localAvatar],this.controller=new hi,this.renderer=new yi}initialize(t){t.resources.load("data/Tn.glb","gltf",(e,r)=>{if(e)return console.error("Failed to load resource",e);this.gltf=r,this.onResourcesLoaded(t)}),this.controller.initialize(this.avatars),this.renderer.initialize(this.avatars)}onResourcesLoaded(t){setTimeout(()=>{var e;for(const t of this.avatars){t.nodes=this.gltf.nodes.map(t=>t.clone(!1));for(let e=0;e<t.nodes.length;e++){const r=this.gltf.nodes[e],n=t.nodes[e];for(const e of r.children){const r=this.gltf.nodes.indexOf(e);n.add(t.nodes[r])}}for(const e of this.gltf.rootNodeIds.slice(0,1))t.add(t.nodes[e]);const r=_n(this.gltf.skins[0]),n=r.joints.map(e=>t.nodes[e]),i=null===(e=r.inverseBindMatrices)||void 0===e?void 0:e.map(t=>(new Dn).fromArray(t));t.skeleton=new Zi(n,i),t.animationMixer=new Hi(t)}this.controller.onResourcesLoaded(this.gltf),this.renderer.onResourcesLoaded(this.gltf,t)},3e3)}update(t){this.controller.update(t)}render(t){this.renderer.render(t)}}n.create();function Qi(t,e,r){return Math.max(Math.min(t,r),e)}const ts=i.create(),es=new ai(i.create());class rs{constructor(t){this.camera=t,this.camPos=i.create()}initialize(t){this.resize(window.innerWidth,window.innerHeight),this.controller=new is,this.controller.initialize(t),this.controller.camera=this.camera}resize(t,e){const r=t/e;this.camera.setPerspective(this.camera.fov,r,this.camera.near,this.camera.far)}update({globalUniforms:t,input:e,clock:r}){this.controller.update(e,r.dt);const n=this.camera.getPos(this.camPos);t.buffer.setVec3("g_camPos",n),t.buffer.setMat4("g_proj",this.camera.projectionMatrix),t.buffer.setMat4("g_viewProj",this.camera.viewProjMatrix)}toJSON(){return this.controller.toJSON()}fromJSON(t){return this.controller.fromJSON(t)}}const ns=i.fromValues(0,1,0);class is{constructor(){this.x=-Math.PI/2,this.y=2,this.z=-1e3,this.orbitSpeed=-.05,this.xVel=0,this.yVel=0,this.zVel=0,this.cursor=new si,this.target=this.cursor,this.shouldOrbit=!0}initialize(t){this.target=t.avatar.localAvatar;const e=Tn.addFolder("OrbitCamera");e.add(this,"orbitSpeed",-1,1),e.add(this,"shouldOrbit",-1,1)}update(t,e){const r=this.shouldOrbit,s=t.invertX?-1:1,a=t.invertY?-1:1;t.isDragging()?(this.xVel+=t.dx/-200*s,this.yVel+=t.dy/-200*a):r&&Math.abs(this.xVel)<Math.abs(this.orbitSpeed)&&(this.xVel+=1*this.orbitSpeed/50),this.zVel+=t.dz;const o=t.isKeyDown("ShiftLeft")||t.isKeyDown("ShiftRight");if(o&&(this.xVel+=-0,this.yVel+=-0),this.xVel=ss(this.xVel,2),this.yVel=ss(this.yVel,2),0!==this.xVel||0!==this.yVel||0!==this.zVel){const e=t.isDragging()||o?.92:.96;this.x+=-this.xVel/10,this.xVel*=e,this.y+=-this.yVel/10,this.yVel*=e,this.z+=4*Math.max(Math.log(Math.abs(this.zVel)),0)*Math.sign(this.zVel),0===t.dz&&(this.zVel*=.85),this.z>-10&&(this.z=-10,this.zVel=0),this.y=Qi(this.y,.5*Math.PI,.99*Math.PI),this.target.getWorldPosition(es);const r=es.buffer,s=ts;!function(t,e,r){const n=Math.sin(r);t[0]=n*Math.cos(e),t[1]=Math.cos(r),t[2]=n*Math.sin(e)}(s,this.x,this.y),i.scale(s,s,this.z),i.add(s,s,r),n.lookAt(this.camera.viewMatrix,s,r,ns),n.invert(this.camera.cameraMatrix,this.camera.viewMatrix),this.camera.viewMatrixUpdated()}return!1}toJSON(){this.cursor.getWorldPosition(es);const t=es.buffer,e=new Float32Array([this.x,this.y,this.z,t[0],t[1],t[2]]);return btoa(String.fromCharCode.apply(null,new Uint8Array(e.buffer)))}fromJSON(t){const e=atob(t),r=new Uint8Array(24);for(let t=0,n=e.length;t<n;t++)r[t]=e.charCodeAt(t);const n=new Float32Array(r.buffer);this.x=n[0],this.y=n[1],this.z=n[2],this.cursor.position.set(n[3],n[4],n[5])}}function ss(t,e){return Math.max(-e,Math.min(t,e))}class as{constructor(){this.dt=0,this.time=0,this.realDt=0,this.realTime=0,this.startTime=performance.now(),this.paused=!1,this.speed=1,this.stepDt=0}initialize(){Tn.add(this,"paused"),Tn.add(this,"speed",.05,2,.05),Tn.add(this,"step")}update(t){this.realDt=t-this.realTime,this.realTime=t,this.dt=this.paused?this.stepDt:this.realDt*this.speed,this.time=this.time+this.dt,this.stepDt=0}step(t=1e3/60){this.paused=!0,this.stepDt=t*this.speed}}class os{constructor(t,e){this.canvas=t,this.gfxDevice=e}initialize(){for(let t in mi)mi[t].defaultDepthStateId=this.gfxDevice.createDepthStencilState(mi[t].defaultDepthState)}render(){this.gfxDevice.beginFrame(),this.gfxDevice.bindRenderPass(0),function(t,e){const r=e.primitives.length;for(let n=0;n<r;n++){const r=e.primitives[n];if(t.bindPipeline(r.renderPipeline),t.bindVertices(r.vertexTable),t.bindResources(r.resourceTable),t.setCullMode(e.defaultCullMode),t.setDepthStencilState(e.defaultDepthStateId),xn(r.indexBuffer)){const e=r.indexType===c.Ushort?2:4,n=bn(r.indexBuffer.byteOffset,0)/e;t.draw(r.type,r.indexBuffer.buffer,_n(r.indexType),n,r.elementCount)}else t.drawNonIndexed(r.type,0,r.elementCount)}}(this.gfxDevice,mi.opaque),this.gfxDevice.endFrame();for(let t in mi)mi[t].primitives.length=0}resize(t,e,r){this.canvas.setAttribute("style",`width: ${t}px; height: ${e}px;`),this.canvas.width=t*r,this.canvas.height=e*r,this.gfxDevice&&this.gfxDevice.resize(this.canvas.width,this.canvas.height)}}var us=r(1),hs=r.n(us),cs=r(2),ls=r.n(cs);class fs{constructor(t){this.renderer=t}initialize(){this.buffer=new gi("GlobalUniforms",this.renderer,fs.bufferLayout),this.bufferView=this.buffer.getBufferView()}update(){this.buffer.write(this.renderer)}}fs.bufferLayout=pi({g_camPos:{type:c.Float3},g_proj:{type:c.Float4x4},g_viewProj:{type:c.Float4x4}});class ds{constructor(t,e,r){this.resourceTable=r,this.vertexTable=e,this.renderPipeline=t,this.elementCount=0,this.type=p.Triangles}}class ms{constructor(){this.name="GridShader",this.vertSource=ms.vert.sourceCode,this.fragSource=ms.frag.sourceCode}}ms.vert=hs.a,ms.frag=ls.a,ms.UniformLayout=pi({u_baseColor:{type:c.Float4},u_lineColor:{type:c.Float4},u_gridUnit:{type:c.Float},u_gridRadius:{type:c.Float}}),ms.resourceLayout={globalUniforms:{index:0,type:v.UniformBuffer,layout:fs.bufferLayout},uniforms:{index:1,type:v.UniformBuffer,layout:ms.UniformLayout}};class ps{constructor(){this.baseColor=s.fromValues(.3,.3,.3,1),this.lineColor=s.fromValues(1,1,1,1),this.gridUnit=100,this.gridRadius=1e3,this.enabled=!0}initialize({gfxDevice:t,globalUniforms:e}){if(!t.isGfxFeatureSupported(h.ShaderGlsl300))return console.warn("GLSL version 300 not supported, disabling DebugGrid"),void(this.enabled=!1);const r=t.createShader(new ms),n=ms.resourceLayout,i={buffers:[{stride:2,layout:{a_pos:{type:c.Char2,offset:0}}}]},s=t.createRenderPipeline(r,{blendingEnabled:!1},i,n),a=t.createBuffer("GridVertices",g.Vertex,y.Static,new Int8Array([-1,-1,1,-1,-1,1,1,1])),o=t.createBuffer("GridIndices",g.Index,y.Static,new Uint16Array([0,2,1,1,2,3])),u=t.createResourceTable(n);this.uniforms=new gi("GridUniforms",t,ms.UniformLayout),t.setBuffer(u,0,e.bufferView),t.setBuffer(u,1,this.uniforms.getBufferView());const l=t.createVertexTable(s);t.setVertexBuffer(l,0,{buffer:a}),this.primitive=new ds(s,l,u),this.primitive.indexBuffer={buffer:o},this.primitive.indexType=c.Ushort,this.primitive.elementCount=6;const f=Tn.addFolder("DebugGrid");f.add(this,"enabled"),f.add(this,"gridUnit",1,100,10),f.add(this,"gridRadius")}render({gfxDevice:t}){this.enabled&&(this.uniforms.setVec4("u_baseColor",this.baseColor),this.uniforms.setVec4("u_lineColor",this.lineColor),this.uniforms.setFloat("u_gridUnit",this.gridUnit),this.uniforms.setFloat("u_gridRadius",this.gridRadius),this.uniforms.write(t),mi.opaque.push(this.primitive))}}var gs=r(3),vs=r.n(gs),ys=r(4),_s=r.n(ys),xs=r(0),bs=r.n(xs);a.create(),i.create();class Ms{constructor(){this.name="AvatarShader",this.defines="#define k_MaxBones 32\n",this.vertSource=[this.defines,Ms.vert.sourceCode],this.fragSource=Ms.frag.sourceCode}}Ms.vert=vs.a,Ms.frag=bs.a,Ms.uniformLayout=pi({u_color:{type:c.Float4},u_joints:{type:c.Float4x4,count:32}}),Ms.resourceLayout={uniforms:{index:0,type:v.UniformBuffer,layout:Ms.uniformLayout},globalUniforms:{index:1,type:v.UniformBuffer,layout:fs.bufferLayout}};class ws{constructor(){this.name="ModelShader",this.vertSource=ws.vert.sourceCode,this.fragSource=ws.frag.sourceCode}}ws.vert=_s.a,ws.frag=bs.a,ws.uniformLayout=pi({u_color:{type:c.Float4},u_model:{type:c.Float4x4}}),ws.resourceLayout={uniforms:{index:0,type:v.UniformBuffer,layout:ws.uniformLayout},globalUniforms:{index:1,type:v.UniformBuffer,layout:fs.bufferLayout}};class Ts{constructor(){this.models=[],this.skinnedModels=[],this.rootNodes=[],this.animations=[]}initialize({gfxDevice:t,resources:e,globalUniforms:r}){this.gfxDevice=t,this.globalUniforms=r,this.shader=t.createShader(new Ms),this.modelShader=t.createShader(new ws),e.load("data/Tn.glb","gltf",(t,e)=>{if(t)return console.error("Failed to load resource",t);const r=e;this.animations=r.animations,this.nodes=r.nodes,this.skeletons=r.skins.map(t=>{var e;return new Zi(t.joints.map(t=>this.nodes[t]),null===(e=t.inverseBindMatrices)||void 0===e?void 0:e.map(t=>{const e=new Dn;return e.elements=Array.from(t),e}))});for(let t=0;t<r.nodes.length;t++){const e=r.nodes[t],n=this.nodes[t];if(xn(e.skinId)){const t=_n(e.meshId);this.loadSkinnedModel(r,n,t,e.skinId)}else xn(e.meshId)&&this.loadModel(r,n,e.meshId)}this.rootNodes=r.rootNodeIds.map(t=>this.nodes[t]),this.rootNodes.forEach(t=>{t.updateMatrix(),t.updateMatrixWorld()}),this.mixer=new Hi(this.rootNodes[0]);const n=_n(this.animations[12]);this.mixer.clipAction(n).play()})}createMaterial(t,e){const r=e.materials[t.materialIndex],n=r.technique,i=n?n.shaderId:this.shader,a=n?function(t){const e={},r=[];for(const n of Object.keys(t.uniforms)){const i=t.uniforms[n];i.type===c.Texture2D?r.push(n):e[n]=i}const n=pi(e),i={uniforms:{index:0,type:v.UniformBuffer,layout:n}};for(let t=0;t<r.length;t++){i[r[t]]={index:t,type:v.Texture}}return i}(n):Ms.resourceLayout,o=new li(this.gfxDevice,r.name,i,a),u=a.uniforms.layout,h=new gi(r.name,this.gfxDevice,u);if(o.setUniformBuffer(this.gfxDevice,"uniforms",h),xn(a.globalUniforms)&&o.setUniformBuffer(this.gfxDevice,"globalUniforms",this.globalUniforms.buffer),n){const t=_n(r.values);for(const r of Object.keys(n.uniforms)){const i=n.uniforms[r],s=bn(t[r],i.value);if(xn(s))if(i.type===c.Texture2D){const t=e.textures[s.index].id;o.setTexture(this.gfxDevice,r,t)}else h.setFloats(r,s)}h.setVec4("u_Color0",s.fromValues(.4266,.4171,.5057,1))}else h.setVec4("u_color",s.fromValues(0,1,0,1));return o}loadSkinnedModel(t,e,r,n){const i=t.meshes[r];for(let r of i.primitives){const i=this.createMaterial(r,t),s=new di(this.gfxDevice,mi.opaque,r.mesh,i);s.bindSkeleton(this.skeletons[n]),this.skinnedModels.push(s),e.add(s)}}loadModel(t,e,r){const n=t.meshes[r];for(let r of n.primitives){const n=this.createMaterial(r,t),i=new fi(this.gfxDevice,mi.opaque,r.mesh,n);this.models.push(i),e.add(i)}}update({clock:t}){this.mixer&&this.mixer.update(t.dt/1e3)}render({gfxDevice:t,camera:e,clock:r}){for(const t of this.rootNodes)t.updateMatrixWorld();for(let r=0;r<this.skinnedModels.length;r++){const i=this.skinnedModels[r],s=i.material.getUniformBuffer("uniforms");i.updateMatrixWorld();const a=new Float32Array(i.matrixWorld.elements);i.skeleton.update(),s.getFloatArray("u_joints").set(i.skeleton.boneMatrices),xn(s.getBufferLayout().u_modelViewProjection)&&s.setMat4("u_modelViewProjection",n.multiply(n.create(),e.viewProjMatrix,a)),xn(s.getBufferLayout().u_modelViewProjection)&&s.setMat4("u_model",a),s.write(t),i.renderList.push(i.primitive)}for(let r=0;r<this.models.length;r++){const i=this.models[r];i.updateMatrixWorld();const s=new Float32Array(i.matrixWorld.elements),a=i.material.getUniformBuffer("uniforms");a.setMat4("u_modelViewProjection",n.multiply(n.create(),e.viewProjMatrix,s)),a.write(t),i.renderList.push(i.primitive)}}}const As={Vertical:{keyPos:"KeyW",keyNeg:"KeyS",value:0},Horizontal:{keyPos:"KeyD",keyNeg:"KeyA",value:0}};class Ss{constructor(){this.invertY=!1,this.invertX=!1,this.button=-1,this.onisdraggingchanged=null,this.listeners=[],this.scrollListeners=[],this.usePointerLock=!0,this.isInteractive=!0,this.touchGesture=0,this.prevTouchX=0,this.prevTouchY=0,this.prevPinchDist=0,this.dTouchX=0,this.dTouchY=0,this.dPinchDist=0,this.axes=As,this._onKeyDown=t=>{if(function(t){switch(t){case"ShiftLeft":case"ShiftRight":case"AltLeft":case"AltRight":return!0;default:return!1}}(t.code))t.preventDefault();else if(!this._hasFocus())return;this.keysDown.set(t.code,!t.repeat),this.callListeners()},this._onKeyUp=t=>{this.keysDown.delete(t.code),this.callListeners()},this._onBlur=()=>{this.keysDown.clear(),this.callListeners()},this._onWheel=t=>{t.preventDefault(),this.dz+=-4*Math.sign(t.deltaY),this.callScrollListeners()},this._onTouchChange=t=>{if(this.isInteractive)if(t.preventDefault(),1==t.touches.length){const e=this._getScaledTouches(t.touches);this.touchGesture=1,this.prevTouchX=e[0].x,this.prevTouchY=e[0].y,this.dTouchX=0,this.dTouchY=0}else if(2==t.touches.length){const e=this._getPinchValues(t.touches);this.touchGesture=2,this.prevTouchX=e.x,this.prevTouchY=e.y,this.prevPinchDist=e.dist,this.dTouchX=0,this.dTouchY=0,this.dPinchDist=0}else this.touchGesture=0},this._onTouchMove=t=>{if(this.isInteractive)if(t.preventDefault(),1==t.touches.length){const e=this._getScaledTouches(t.touches);this.touchGesture=1,this.dTouchX=e[0].x-this.prevTouchX,this.dTouchY=e[0].y-this.prevTouchY,this.onMotion(this.dTouchX,this.dTouchY),this.prevTouchX=e[0].x,this.prevTouchY=e[0].y}else if(2==t.touches.length){const e=this._getPinchValues(t.touches);this.touchGesture=2,this.dTouchX=e.x-this.prevTouchX,this.dTouchY=e.y-this.prevTouchY,this.dPinchDist=e.dist-this.prevPinchDist,this.prevTouchX=e.x,this.prevTouchY=e.y,this.prevPinchDist=e.dist}else this.touchGesture=0}}initialize({toplevel:t}){document.body.tabIndex=-1,this.toplevel=t,this.toplevel.tabIndex=-1,this.keysDown=new Map,document.addEventListener("keydown",this._onKeyDown,{capture:!0}),document.addEventListener("keyup",this._onKeyUp,{capture:!0}),window.addEventListener("blur",this._onBlur),this.toplevel.addEventListener("wheel",this._onWheel,{passive:!1}),this.toplevel.addEventListener("mousedown",t=>{this.isInteractive&&(this.button=t.button,Is.takeGrab(this,t,{takePointerLock:this.usePointerLock,useGrabbingCursor:!0,releaseOnMouseUp:!0}),null!==this.onisdraggingchanged&&this.onisdraggingchanged())}),this.toplevel.addEventListener("touchstart",this._onTouchChange),this.toplevel.addEventListener("touchend",this._onTouchChange),this.toplevel.addEventListener("touchcancel",this._onTouchChange),this.toplevel.addEventListener("touchmove",this._onTouchMove),this.afterFrame()}addListener(t){this.listeners.push(t)}addScrollListener(t){this.scrollListeners.push(t)}getMouseDeltaX(){return this.dx}getMouseDeltaY(){return this.dy}getTouchDeltaX(){return 2==this.touchGesture?this.dTouchX:0}getTouchDeltaY(){return 2==this.touchGesture?this.dTouchY:0}getPinchDeltaDist(){return 2==this.touchGesture?this.dPinchDist:0}isKeyDownEventTriggered(t){return!!this.keysDown.get(t)}isKeyDown(t){return this.keysDown.has(t)}isDragging(){return 0!=this.touchGesture||Is.hasGrabListener(this)}afterFrame(){this.dx=0,this.dy=0,this.dz=0,this.dTouchX=0,this.dTouchY=0,this.dPinchDist=0,this.keysDown.forEach((t,e)=>{this.keysDown.set(e,!1)})}focusViewer(){this.toplevel.focus()}_hasFocus(){return document.activeElement===document.body||document.activeElement===this.toplevel}callListeners(){for(let t=0;t<this.listeners.length;t++)this.listeners[t](this)}callScrollListeners(){for(let t=0;t<this.scrollListeners.length;t++)this.scrollListeners[t](this)}_getScaledTouches(t){const e=[],r=1e3/Math.max(1,Math.min(this.toplevel.clientWidth,this.toplevel.clientHeight));for(let n=0;n<t.length;n++)e.push({x:t[n].clientX*r,y:t[n].clientY*r});return e}_getPinchValues(t){const e=this._getScaledTouches(t);return{x:(e[0].x+e[1].x)/2,y:(e[0].y+e[1].y)/2,dist:Math.hypot(e[0].x-e[1].x,e[0].y-e[1].y)}}onMotion(t,e){this.dx+=t,this.dy+=e}onGrabReleased(){this.button=-1,null!==this.onisdraggingchanged&&this.onisdraggingchanged()}getAxis(t){const e=_n(this.axes[t]);let r=0;return xn(e.keyPos)&&this.isKeyDown(e.keyPos)&&(r+=1),xn(e.keyNeg)&&this.isKeyDown(e.keyNeg)&&(r-=1),r}}const Es=new class{constructor(){this.styleElem=document.createElement("style"),document.head.appendChild(this.styleElem),this.style=this.styleElem.sheet}setCursor(t){if(this.style.cssRules.length&&this.style.deleteRule(0),t){const e=`* { ${t.map(t=>`cursor: ${t} !important;`).join(" ")} }`;this.style.insertRule(e,0)}}};const Is=new class{constructor(){this.grabListener=null,this.grabOptions=null,this.lastX=-1,this.lastY=-1,this._onMouseMove=t=>{if(null===this.grabListener)return;let e,r;void 0!==t.movementX?(e=t.movementX,r=t.movementY):(e=t.pageX-this.lastX,r=t.pageY-this.lastY,this.lastX=t.pageX,this.lastY=t.pageY),this.grabListener.onMotion(e,r)},this._onMouseDown=t=>{const e=this.grabOptions.grabElement;e&&!function(t,e){let r=t;for(;null!==r;){if(r===e)return!0;r=r.parentElement}return!1}(t.target,e)&&this.releaseGrab()},this._onMouseUp=t=>{this.releaseGrab()}}hasGrabListener(t){return this.grabListener===t}isGrabbed(){return null!==this.grabListener}takeGrab(t,e,r){if(null!==this.grabListener)return;this.grabListener=t,this.grabOptions=r,r.useGrabbingCursor&&Es.setCursor(["grabbing","-webkit-grabbing"]),this.lastX=e.pageX,this.lastY=e.pageY,document.body.focus(),e.preventDefault();const n=e.target;r.takePointerLock&&void 0!==n.requestPointerLock&&n.requestPointerLock(),document.addEventListener("mousemove",this._onMouseMove),r.releaseOnMouseUp?document.addEventListener("mouseup",this._onMouseUp):document.addEventListener("mousedown",this._onMouseDown,{capture:!0})}releaseGrab(){document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousedown",this._onMouseDown,{capture:!0}),void 0!==document.exitPointerLock&&document.exitPointerLock(),Es.setCursor(null);const t=this.grabListener;this.grabListener=null,t.onGrabReleased(),this.grabOptions=null}};var Fs,Us=r(5),Cs=r.n(Us);!function(t){t[t.LoadingAsync=0]="LoadingAsync",t[t.LoadingSync=1]="LoadingSync",t[t.Loaded=2]="Loaded",t[t.Unloaded=3]="Unloaded",t[t.Failed=4]="Failed"}(Fs||(Fs={}));const Ns=1313821514,Rs=5130562;let Os=new TextDecoder;function ks(t){return Os.decode(t)}class Bs{constructor(t){const e=new DataView(t,0,12),r=new DataView(t,12),n=ks(new Uint8Array(t,0,4)),i=e.getUint32(4,!0);e.getUint32(8,!0);if("glTF"!==n)throw new Error("Unsupported glTF-Binary header.");if(i<2)throw new Error("Unsupported legacy binary file detected.");let s=0;for(;s<r.byteLength;){const e=r.getUint32(s,!0);s+=4;const n=r.getUint32(s,!0);switch(s+=4,n){case Ns:{const r=new Uint8Array(t,12+s,e);this.json=ks(r)}break;case Rs:{const r=12+s;this.binaryChunk=new Uint8Array(t,r,e)}break;default:console.warn("Skipping unexpected glTF-Binary chunk type:",n)}s+=e}yn(!!this.json,"glTF-Binary: JSON content not found.")}}class zs{constructor(t,e){this.gltf=t,this.bufferData=e}bufferViewData(t){if(!this.gltf.bufferViews)throw new Error("No buffer views found.");const e=this.gltf.bufferViews[t],r=_n(this.bufferData[e.buffer],`No data for buffer ${e.buffer}`),n=e.byteLength||0,i=e.byteOffset||0,s=r.buffer,a=r.byteOffset;return new Uint8Array(s,a+i,n)}accessorData(t){if(!this.gltf.accessors)throw new Error("No accessors views found.");const e=this.gltf.accessors[t],r=Ws[e.type];let n;const i=qs[e.componentType],s=i.BYTES_PER_ELEMENT*r*e.count;if(void 0!==e.bufferView){const t=this.bufferViewData(e.bufferView);n=new i(t.buffer,t.byteOffset+bn(e.byteOffset,0),e.count*r)}else n=new i(s);if(e.sparse){const{count:t,indices:i,values:s}=e.sparse;let a=qs[i.componentType],o=this.bufferViewData(i.bufferView);const u=new a(o.buffer,o.byteOffset+(i.byteOffset||0),t);a=qs[e.componentType],o=this.bufferViewData(s.bufferView);const h=new a(this.bufferViewData(s.bufferView).buffer,o.byteOffset+(s.byteOffset||0),t*r);e.bufferView&&(n=new Uint8Array(n));const c=new qs[e.componentType](n.buffer);for(let e=0;e<t;e++)for(let t=0;t<r;t++)c[r*u[e]+t]=h[r*e+t]}return n}}class Ls extends si{clone(t=!1){const e=super.clone(t);return e.morphWeight=this.morphWeight,e.meshId=this.meshId,e.skinId=this.skinId,e}}function Ds(t,e){let r;switch(e){case 5120:r=c.Char;break;case 5121:r=c.Uchar;break;case 5122:r=c.Short;break;case 5123:r=c.Ushort;break;case 5125:r=c.Uint;break;case 5126:r=c.Float;break;default:throw new Error("Invalid GLTF component type")}switch(t){case"SCALAR":r+=0;break;case"VEC2":r+=1;break;case"VEC3":r+=2;break;case"VEC4":r+=3;break;case"MAT2":throw new Error("2x2 Matrice not yet supported");case"MAT3":r=c.Float3x3;break;case"MAT4":r=c.Float4x4}return r}function Ps(t){switch(t){case 5124:return c.Int;case 5126:return c.Float;case 35664:return c.Float2;case 35665:return c.Float3;case 35666:return c.Float4;case 35667:return c.Int2;case 35668:return c.Int3;case 35669:return c.Int4;case 35675:return c.Float3x3;case 35676:return c.Float4x4;case 35678:return c.Texture2D;default:throw new Error("Invalid GLTF component type")}}function Vs(t){switch(t){case 0:return p.Points;case 1:return p.Lines;case 2:return p.LineLoop;case 3:return p.LineStrip;case 4:return p.Triangles;case 5:return p.TriangleStrip;case 6:return p.TriangleFan;default:throw new Error("Invalid GLTF primitive mode")}}const js={9728:d.Nearest,9729:d.Linear},Gs={9728:d.Nearest,9729:d.Linear},qs={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Ws={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Hs={POSITION:"a_pos",NORMAL:"a_normal",TANGENT:"a_tangent",JOINTS_0:"a_joints",WEIGHTS_0:"a_weights",COLOR_0:"a_color",TEXCOORD_0:"a_uv0",TEXCOORD_1:"a_uv1",MORPH0_POSITION:"a_posMorph0"},Xs={NORMAL:"HAS_NORMALS 1",TANGENT:"HAS_TANGENT 1",JOINTS_0:"HAS_JOINT_SET0 1",WEIGHTS_0:"HAS_WEIGHT_SET0 1",COLOR_0:"HAS_COLOR0 1",TEXCOORD_0:"HAS_UV_SET0 1",TEXCOORD_1:"HAS_UV_SET1 1"},Ys={CUBICSPLINE:void 0,LINEAR:2301,STEP:2300},$s={translation:"position",rotation:"quaternion",scale:"scale",weights:"_UNSUPPORTED"};function Zs(t,e,r){const n=r,i=e.gltf;let s;if(!xn(r.material))throw new Error("Default material not yet supported");s=_n(t.transient.materials[r.material]);const a=[];let o=void 0;const u=[];if(xn(n.indices)){const r=_n(i.accessors)[n.indices];o=Js(t,e,_n(r.bufferView),g.Index)}let h;if(xn(s.techniqueIndex)){h={};const e=_n(t.transient.techniques).techniques[s.techniqueIndex],r=Object.keys(e.attributes);for(const t of r){h[e.attributes[t].semantic]=t}}else h=Hs;const c={buffers:[]},l={};for(let r in n.attributes){const s=_n(i.accessors)[n.attributes[r]],o=_n(s.bufferView,"Undefined accessor buffers are not yet implemented"),f=l[o];let d;if(xn(f))d=c.buffers[f];else{l[o]=u.length;const r=Js(t,e,o,g.Vertex);d={stride:bn(_n(i.bufferViews)[o].byteStride,0),layout:{}},u.push(r),c.buffers.push(d)}const m=Xs[r];xn(m)&&a.push(m);const p=_n(h[r],`Unknown vertex attribute semantic: ${r}`);d.layout[p]={type:Ds(s.type,s.componentType),offset:s.byteOffset||0}}if(n.targets){a.push("HAS_MORPH0 1"),yn(1===n.targets.length,"Only 1 morph target is currently supported");const r=n.targets[0];for(let n in r)if("POSITION"===n){const s=_n(i.accessors)[r[n]],a=_n(s.bufferView,"Undefined accessor buffers are not yet implemented"),o=_n(i.bufferViews)[a];let l=c.buffers[a];const f=Js(t,e,a,g.Vertex);xn(l)||(u[a]=f,l=c.buffers[a]={stride:bn(o.byteStride,0),layout:{}});const d=h[`MORPH0_${n}`];l.layout[d]={type:Ds(s.type,s.componentType),offset:s.byteOffset||0}}}const f=i.accessors[_n(n.indices,"Only indexed primitives are currently supported")],d=_n(o,"Only indexed primitives are currently supported");return{mesh:{elementCount:f.count,vertexBuffers:u,primitiveType:Vs(bn(n.mode,4)),indexType:Ds(f.type,f.componentType),indexBuffer:d,vertexLayout:c},materialIndex:r.material}}function Js(t,e,r,n){if(xn(t.bufferViews[r]))return t.bufferViews[r];const i=_n(e.gltf.bufferViews)[r].name||`buffer${r}`;t.bufferData[r]=new Uint8Array(e.bufferViewData(r)).buffer,yn(!t.transferList.includes(t.bufferData[r])),t.transferList.push(t.bufferData[r]);const s={name:i,type:n,buffer:-1};return t.bufferViews[r]=s,s}function Ks(t,e){return bn(e.gltf.materials,[]).map((t,e)=>{var r;const n=null===(r=t.extensions)||void 0===r?void 0:r.KHR_techniques_webgl,i=n?n.technique:void 0,s=n?n.values:void 0;return{name:bn(t.name,`Material${e}`),renderFormat:{blendingEnabled:!1},cullMode:t.doubleSided?_.None:_.Back,techniqueIndex:i,values:s}})}function Qs(t,e){var r;if(!(null===(r=e.gltf.extensionsUsed)||void 0===r?void 0:r.includes("KHR_techniques_webgl")))return;const n=_n(e.gltf.extensions.KHR_techniques_webgl);return{shaderData:n.shaders.map((r,n)=>{const i=_n(r.bufferView,"Shader loading from URI not yet supported"),s=new Uint8Array(e.bufferViewData(i)).buffer;return yn(!t.transferList.includes(s)),t.transferList.push(s),s}),shaders:n.programs.map(t=>({name:t.name,fsIndex:t.fragmentShader,vsIndex:t.vertexShader})),techniques:n.techniques.map((t,e)=>{const r={};for(const e in bn(t.uniforms,{})){const n=t.uniforms[e];r[e]=Object.assign(Object.assign({},n),{type:Ps(n.type)})}return{shaderIndex:t.program,attributes:bn(t.attributes,{}),uniforms:r}})}}function ta(t,e){return bn(e.gltf.nodes,[]).map(t=>{const r=bn(t.scale,[1,1,1]),s=bn(t.rotation,[0,0,0,1]),o=bn(t.translation,[0,0,0]),u={name:t.name,scale:i.fromValues(r[0],r[1],r[2]),rotation:a.fromValues(s[0],s[1],s[2],s[3]),translation:i.fromValues(o[0],o[1],o[2]),morphWeight:bn(t.weights,[0])[0],transform:n.create(),meshId:xn(t.mesh)?t.mesh:void 0,skinId:xn(t.skin)?t.skin:void 0,children:[]};if(xn(t.matrix)?(u.transform.set(t.matrix),n.getRotation(u.rotation,u.transform),n.getTranslation(u.translation,u.transform),n.getScaling(u.scale,u.transform)):u.transform=n.fromRotationTranslationScale(n.create(),u.rotation,u.translation,u.scale),xn(t.children))for(let r=0;r<t.children.length;r++){const n=t.children[r];_n(e.gltf.nodes)[n];u.children.push(n)}return u})}async function ea(t,e){const r=bn(e.gltf.images,[]),n=bn(e.gltf.textures,[]),i=bn(e.gltf.samplers,[]),s={type:l.Texture2D,format:f.U8x4,usage:y.Static},a={wrapS:10497,wrapT:10497},o=r.map(r=>{const n=_n(r.bufferView,"Image loading from a URI is not yet supported"),i=e.bufferViewData(n);let s;if(xn(self.createImageBitmap)){const t=new Blob([i],{type:_n(r.mimeType)});s=createImageBitmap(t)}else s=Promise.resolve(new Uint8Array(i).buffer);return s.then(e=>(yn(!t.transferList.includes(e)),t.transferList.push(e),e))}),u=n.map(t=>{const e=bn(i[t.sampler],a),r=Object.assign({},s);return xn(e.magFilter)&&(r.defaultMagFilter=js[e.magFilter],xn(r.defaultMagFilter)||console.warn(`Unsupported texture mag filter: ${e.magFilter}`)),xn(e.minFilter)&&(r.defaultMagFilter=Gs[e.minFilter],xn(r.defaultMagFilter)||console.warn(`Unsupported texture min filter: ${e.magFilter}`)),(xn(e.wrapS)||xn(e.wrapT))&&(xn(r.defaultMagFilter)||console.warn(`Texture wrapping not yet supported: ${e.magFilter}`)),{name:t.name,desc:r,imageIndex:_n(t.source)}});return{imageData:await Promise.all(o),textures:u}}function ra(t,e){let r=[];for(const n of bn(e.gltf.animations,[])){const i=n.samplers.map(r=>{yn(5126===e.gltf.accessors[r.input].componentType,"Non-float animation time type unsupported"),yn(5126===e.gltf.accessors[r.output].componentType,"Non-float animation values type unsupported");const n=new Float32Array(e.accessorData(r.input)),i=new Float32Array(e.accessorData(r.output));return t.transferList.push(n.buffer,i.buffer),{times:n,values:i}}),s=[];for(const t of n.channels){const e=t.target.node;if(!xn(e))continue;const r=$s[t.target.path],a=i[t.sampler],o=bn(n.samplers[t.sampler].interpolation,"LINEAR");s.push({targetNodeId:e,targetProperty:r,times:a.times,values:a.values,interpolation:o})}r.push({name:n.name,maxTime:n.maxTime,tracks:s})}return r}class na extends _i{copySampleValue_(t){for(var e=this.resultBuffer,r=this.sampleValues,n=this.valueSize,i=t*n*3+n,s=0;s!==n;s++)e[s]=r[i+s];return e}beforeStart_(t){this.copySampleValue_(t)}afterEnd_(t){this.copySampleValue_(t)}interpolate_(t,e,r,n){const i=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=2*a,u=3*a,h=n-e,c=(r-e)/h,l=c*c,f=l*c,d=t*u,m=d-u,p=-2*f+3*l,g=f-l,v=1-p,y=g-l+c;for(let t=0;t!==a;t++){const e=s[m+t+a],r=s[m+t+o]*h,n=s[d+t+a],u=s[d+t]*h;i[t]=v*e+y*r+p*n+g*u}return i}}const ia={texture:new class{async loadAsync(t){const e=await fetch(t.source.uri);if(200!=e.status)throw new Error("Failed to download image");const r=t.source.uri.match(/.*\/(.+?)\./);t.name=r&&r.length>1?r[1]:"Unknown",self.createImageBitmap?(t.imageBitmap=await createImageBitmap(await e.blob()),t.transferList.push(t.imageBitmap),t.status=Fs.LoadingSync):(t.imageBuffer=await e.arrayBuffer(),t.transferList.push(t.imageBuffer),t.status=Fs.LoadingSync)}loadSync(t,e){if(e.imageBitmap)e.texture=t.renderer.createTexture(e.name,{usage:y.Static,type:l.Texture2D,format:f.U8x3,maxAnistropy:16},e.imageBitmap),e.imageBitmap.close(),delete e.imageBitmap,e.status=Fs.Loaded;else{if(e.imageBuffer){var r=new Blob([e.imageBuffer],{type:"image/jpeg"});let t=window.URL.createObjectURL(r);delete e.imageBuffer,e.imageElement=new Image,e.imageElement.src=t,e.status=Fs.LoadingSync}xn(e.imageElement)&&e.imageElement.complete&&(e.texture=t.renderer.createTexture(e.name,{usage:y.Static,type:l.Texture2D,format:f.U8x3,maxAnistropy:16},e.imageElement),delete e.imageElement,e.status=Fs.Loaded)}}unloadSync(t,e){xn(e.texture)&&t.renderer.removeTexture(e.texture),xn(e.imageBitmap)&&e.imageBitmap.close()}},gltf:new class{async loadAsync(t){const e=await fetch(t.source.uri);if(200!=e.status)throw new Error("Failed to download GLTF");const r=await e.arrayBuffer(),n=new Bs(r),i=JSON.parse(n.json),s=new zs(i,[n.binaryChunk]);t.nodes=[],t.meshes=[],t.materials=[],t.textures=[],t.bufferViews=[],t.animations=[],t.rootNodeIds=[],t.bufferData=[],t.transient={techniques:Qs(t,s),materials:Ks(0,s),nodes:ta(0,s),animation:ra(t,s),textures:await ea(t,s)},function(t,e){const r=bn(e.gltf.meshes,[]);t.meshes=[];for(let n=0;n<r.length;n++){const i=_n(r[n]),s=[];for(let r of i.primitives)s.push(Zs(t,e,r));const a={name:i.name,id:n,primitives:s};t.meshes[n]=a}}(t,s),function(t,e){const r=bn(e.gltf.skins,[]);t.skins=[];for(let n=0;n<r.length;n++){const i=r[n];let s=void 0;if(xn(i.inverseBindMatrices)){const r=new Float32Array(e.accessorData(i.inverseBindMatrices));yn(!t.transferList.includes(r.buffer)),t.transferList.push(r.buffer),s=[];for(let t=0;t<i.joints.length;t++)s[t]=r.subarray(16*t,16*t+16)}t.skins[n]={name:i.name,skeleton:i.skeleton,joints:i.joints,inverseBindMatrices:s}}}(t,s),function(t,e){const r=bn(e.gltf.scene,0);if(xn(r)){const n=_n(e.gltf.scenes),i=_n(n[r]);t.rootNodeIds=bn(i.nodes,[])}}(t,s),yn(!t.transferList.includes(r)),t.status=Fs.LoadingSync}loadSync(t,e){if(xn(self.createImageBitmap))e.status=Fs.Loaded;else if(function(t,e){let r=!1;const n=t.transient.textures;let i=0;for(let a=0;a<n.textures.length;a++){const o=n.textures[a],u=n.imageData[o.imageIndex];if(xn(t.textures[a]))i+=1;else{if(u instanceof ArrayBuffer){r=!0;var s=new Blob([u],{type:"image/jpeg"});let e=window.URL.createObjectURL(s);n.imageData[o.imageIndex]=new Image,n.imageData[o.imageIndex].src=e,t.status=Fs.LoadingSync}u.complete&&(yn(xn(t.textures),"This should have been defined as an empty array by loadTexturesSync()"),t.textures[a]={desc:o.desc,name:o.name,id:e.renderer.createTexture(o.name,o.desc,u)})}}return i===n.textures.length?t.status=Fs.Loaded:t.status=Fs.LoadingSync,!r}(e,t))return;e.techniques=function(t,e){if(!xn(t))return[];const r=t.shaders.map(r=>{const n=t.shaderData[r.vsIndex],i=t.shaderData[r.fsIndex],s={name:r.name,vertSource:ks(n),fragSource:ks(i)};return e.renderer.createShader(s)});return t.techniques.map(t=>({shaderId:r[t.shaderIndex],attributes:t.attributes,uniforms:t.uniforms}))}(e.transient.techniques,t),e.materials=function(t,e){return t.map(t=>({name:t.name,renderFormat:t.renderFormat,cullMode:t.cullMode,values:t.values,technique:xn(t.techniqueIndex)?e.techniques[t.techniqueIndex]:void 0}))}(e.transient.materials,e),e.nodes=function(t){const e=t.map((t,e)=>{const r=new Ls;return r.name=bn(t.name,`Node${e}`),r.position.set(t.translation[0],t.translation[1],t.translation[2]),r.quaternion.set(t.rotation[0],t.rotation[1],t.rotation[2],t.rotation[3]),r.scale.set(t.scale[0],t.scale[1],t.scale[2]),r.skinId=t.skinId,r.meshId=t.meshId,r.morphWeight=t.morphWeight,r});for(let r=0;r<e.length;r++){const n=t[r],i=e[r];for(const t of n.children)i.add(e[t])}return e}(e.transient.nodes),e.animations=function(t,e){const r=[];for(const n of t){const t=n.tracks.map(t=>{let r;switch(t.targetProperty){case"quaternion":r=Si;break;case"position":case"scale":r=Ei;break;default:throw new Error("Unsupported animation target property")}const n=new r(`${e.nodes[t.targetNodeId].name}.${t.targetProperty}`,t.times,t.values,Ys[t.interpolation]);return"CUBICSPLINE"===t.interpolation&&(n.createInterpolant=function(t){return new na(this.times,this.values,this.getValueSize()/3,t)},n.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),n});r.push(new Ni(n.name,n.maxTime,t))}return r}(e.transient.animation,e),e.textures=function(t,e){const r=[];if(xn(self.createImageBitmap)){for(const n of t.textures){const i=t.imageData[n.imageIndex];yn(i instanceof ImageBitmap),r.push({desc:n.desc,name:n.name,id:e.renderer.createTexture(n.name,n.desc,i)})}for(const e of t.imageData)e.close()}return r}(e.transient.textures,t);for(let r in e.bufferData){const n=e.bufferViews[r],i=e.bufferData[r];n.buffer=t.renderer.createBuffer(n.name,n.type,y.Static,i)}e.status===Fs.Loaded&&delete e.transient}unloadSync(t,e){}}};class sa{constructor(){this.messages=[],this.pending=[],this.finished=[],this.unloaded=[],this.loadingAsync=[],this.loadingSync=[],this.cache={},this.requests={}}initialize(t){this.worker=new Cs.a,this.worker.onmessage=t=>this.onMessage(t),this.context={renderer:t}}onMessage(t){this.messages.push(t)}load(t,e,r){if(!xn(ia[e]))return void r("Invalid resource type",void 0);const n="string"==typeof t?t:t.uri,i="string"==typeof t?void 0:t.headers,s=n+e;if(xn(this.cache[s]))r(void 0,this.cache[s]);else if(this.requests[s])this.requests[s].push(r);else{this.requests[s]=[r];const t={source:{uri:n,headers:i,type:e},status:Fs.LoadingAsync,transferList:[]};this.worker.postMessage([t])}}unload(t,e){const r=("string"==typeof t?t:t.uri)+e;if(xn(this.cache[r])){const t=this.cache[r];ia[t.source.type].unloadSync(this.context,t),delete this.cache[r]}else{if(!this.requests[r])throw new Error(`Attempted to unload a resource that was never loaded: ${r}`);delete this.requests[r]}}update(){for(let t of this.messages)Array.prototype.push.apply(this.pending,t.data);for(let t of this.pending){const e=t.source.uri+t.source.type;if(xn(this.requests[e])||(t.status=Fs.Unloaded),t.status===Fs.LoadingSync){ia[t.source.type].loadSync(this.context,t)}switch(t.status){case Fs.Loaded:case Fs.Failed:this.finished.push(t);break;case Fs.Unloaded:this.unloaded.push(t);break;case Fs.LoadingAsync:this.loadingAsync.push(t);break;case Fs.LoadingSync:this.loadingSync.push(t)}}this.pending.length=0;for(let t of this.finished){const e=t.source.uri+t.source.type,r=_n(this.requests[e]).length;yn(r>=1),this.cache[e]=t;for(let n=0;n<r;n++)t.status===Fs.Failed?this.requests[e][n](t.error,void 0):this.requests[e][n](void 0,t);delete this.requests[e]}const t=[];for(let e of this.loadingAsync)Array.prototype.push.apply(t,e.transferList);this.worker.postMessage(this.loadingAsync,t);for(let t of this.unloaded){ia[t.source.type].unloadSync(this.context,t)}Array.prototype.push.apply(this.pending,this.loadingSync),this.finished.length=0,this.unloaded.length=0,this.loadingAsync.length=0,this.loadingSync.length=0,this.messages.length=0}}class aa{constructor(){this.clearing=!1}initialize(t){Tn.add(this,"clearState"),this.loadState(t)&&console.log("Loaded state from localStorage")}saveState({cameraSystem:t}){const e={version:1,cameraSystem:t,DebugMenu:Tn},r=JSON.stringify(e);this.clearing||window.localStorage.setItem("state",r)}loadState({cameraSystem:t}){const e=window.localStorage.getItem("state");if(!xn(e))return!1;const r=JSON.parse(e);if(1!==r.version)return!1;try{t.fromJSON(r.cameraSystem),Tn.fromJSON(r.DebugMenu)}catch(t){return console.warn("Failed to load state:",t),!1}return!0}clearState(){window.localStorage.removeItem("state"),this.clearing=!0,location.reload()}update(t){0}}window.main=new class{constructor(){this.canvas=document.createElement("canvas"),this.gfxDevice=new H,this.camera=new Mn,this.avatar=new Ki,this.clock=new as,this.cameraSystem=new rs(this.camera),this.compositor=new os(this.canvas,this.gfxDevice),this.debugGrid=new ps,this.globalUniforms=new fs(this.gfxDevice),this.demo=new Ts,this.input=new Ss,this.resources=new sa,this.state=new aa,this.init()}async init(){return console.log(`Source for this build available at ${u}`),this.toplevel=document.createElement("div"),document.body.appendChild(this.toplevel),this.toplevel.appendChild(this.canvas),this.gfxDevice.setDebugEnabled(!1),this.gfxDevice.initialize(this.canvas)?(this.gfxDevice.resize(this.canvas.width,this.canvas.height),this.resources.initialize(this.gfxDevice),this.clock.initialize(),this.input.initialize(this),this.cameraSystem.initialize(this),this.compositor.initialize(),this.globalUniforms.initialize(),this.avatar.initialize(this),this.debugGrid.initialize(this),this.state.initialize(this),window.onresize=this.onResize.bind(this),this.onResize(),this.update(window.performance.now()),0):1}update(t){this.clock.update(t),this.resources.update(),this.cameraSystem.update(this),this.avatar.update(this),this.state.update(this),this.globalUniforms.update(),this.avatar.render(this),this.debugGrid.render(this),this.compositor.render(),this.input.afterFrame(),Tn.update(),window.requestAnimationFrame(this.update.bind(this))}onResize(){this.cameraSystem.resize(window.innerWidth,window.innerHeight),this.compositor.resize(window.innerWidth,window.innerHeight,window.devicePixelRatio)}}}]);