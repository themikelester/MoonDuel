!function(e){function t(t){for(var r,s,a=t[0],i=t[1],o=0,c=[];o<a.length;o++)s=a[o],Object.prototype.hasOwnProperty.call(n,s)&&n[s]&&c.push(n[s][0]),n[s]=0;for(r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r]);for(u&&u(t);c.length;)c.shift()()}var r={},n={1:0};function s(t){if(r[t])return r[t].exports;var n=r[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.e=function(e){var t=[],r=n[e];if(0!==r)if(r)t.push(r[2]);else{var a=new Promise((function(t,s){r=n[e]=[t,s]}));t.push(r[2]=a);var i,o=document.createElement("script");o.charset="utf-8",o.timeout=120,s.nc&&o.setAttribute("nonce",s.nc),o.src=function(e){return s.p+""+({2:"vendors~dat-gui"}[e]||e)+"."+{2:"45eeb7eac1fadba158ea"}[e]+".js"}(e);var u=new Error;i=function(t){o.onerror=o.onload=null,clearTimeout(c);var r=n[e];if(0!==r){if(r){var s=t&&("load"===t.type?"missing":t.type),a=t&&t.target&&t.target.src;u.message="Loading chunk "+e+" failed.\n("+s+": "+a+")",u.name="ChunkLoadError",u.type=s,u.request=a,r[1](u)}n[e]=void 0}};var c=setTimeout((function(){i({type:"timeout",target:o})}),12e4);o.onerror=o.onload=i,document.head.appendChild(o)}return Promise.all(t)},s.m=e,s.c=r,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(r,n,function(t){return e[t]}.bind(null,n));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s.oe=function(e){throw console.error(e),e};var a=window.webpackJsonp=window.webpackJsonp||[],i=a.push.bind(a);a.push=t,a=a.slice();for(var o=0;o<a.length;o++)t(a[o]);var u=i;s(s.s=9)}([function(e,t){e.exports={sourceCode:"#version 100\nprecision mediump float;uniform vec4 u_color;void main(){gl_FragColor=u_color;}",uniforms:{u_color:{variableType:"vec4",variableName:"u_color"}},consts:{}}},function(e,t){e.exports={sourceCode:"#version 100\nprecision mediump float;attribute vec3 a_pos;uniform mat4 u_model;uniform mat4 g_viewProj;void main(){gl_Position=g_viewProj*u_model*vec4(a_pos,1.);}",uniforms:{u_model:{variableType:"mat4",variableName:"u_model"},g_viewProj:{variableType:"mat4",variableName:"g_viewProj"}},consts:{}}},function(e,t){e.exports={sourceCode:"precision mediump float;\n#ifndef k_MaxBones\n#   defined k_MaxBones 32\n#endif\nattribute vec3 a_pos;attribute vec4 a_joints;attribute vec4 a_weights;uniform mat4 g_viewProj;uniform mat4 u_bones[k_MaxBones];void main(){vec4 pos=vec4(a_pos,1.);vec4 modelPos=(u_bones[int(a_joints.x)]*pos*a_weights.x)+(u_bones[int(a_joints.y)]*pos*a_weights.y)+(u_bones[int(a_joints.z)]*pos*a_weights.z)+(u_bones[int(a_joints.w)]*pos*a_weights.w);gl_Position=g_viewProj*modelPos;}",uniforms:{g_viewProj:{variableType:"mat4",variableName:"g_viewProj"},u_bones:{variableType:"mat4",variableName:"u_bones"}},consts:{}}},function(e,t,r){e.exports=function(){return new Worker(r.p+"ResourceLoading.worker.00a1f34a0742fff4678e.js")}},,,,,,function(e,t,r){"use strict";r.r(t);var n={};r.r(n),r.d(n,"create",(function(){return W})),r.d(n,"clone",(function(){return Y})),r.d(n,"copy",(function(){return K})),r.d(n,"fromValues",(function(){return J})),r.d(n,"set",(function(){return Z})),r.d(n,"identity",(function(){return Q})),r.d(n,"transpose",(function(){return ee})),r.d(n,"invert",(function(){return te})),r.d(n,"adjoint",(function(){return re})),r.d(n,"determinant",(function(){return ne})),r.d(n,"multiply",(function(){return se})),r.d(n,"translate",(function(){return ae})),r.d(n,"scale",(function(){return ie})),r.d(n,"rotate",(function(){return oe})),r.d(n,"rotateX",(function(){return ue})),r.d(n,"rotateY",(function(){return ce})),r.d(n,"rotateZ",(function(){return he})),r.d(n,"fromTranslation",(function(){return fe})),r.d(n,"fromScaling",(function(){return le})),r.d(n,"fromRotation",(function(){return de})),r.d(n,"fromXRotation",(function(){return me})),r.d(n,"fromYRotation",(function(){return pe})),r.d(n,"fromZRotation",(function(){return ge})),r.d(n,"fromRotationTranslation",(function(){return xe})),r.d(n,"fromQuat2",(function(){return be})),r.d(n,"getTranslation",(function(){return ye})),r.d(n,"getScaling",(function(){return ve})),r.d(n,"getRotation",(function(){return Me})),r.d(n,"fromRotationTranslationScale",(function(){return we})),r.d(n,"fromRotationTranslationScaleOrigin",(function(){return _e})),r.d(n,"fromQuat",(function(){return Te})),r.d(n,"frustum",(function(){return Ue})),r.d(n,"perspective",(function(){return Se})),r.d(n,"perspectiveFromFieldOfView",(function(){return Ee})),r.d(n,"ortho",(function(){return Fe})),r.d(n,"lookAt",(function(){return Ae})),r.d(n,"targetTo",(function(){return Le})),r.d(n,"str",(function(){return De})),r.d(n,"frob",(function(){return Ie})),r.d(n,"add",(function(){return Be})),r.d(n,"subtract",(function(){return Ne})),r.d(n,"multiplyScalar",(function(){return Re})),r.d(n,"multiplyScalarAndAdd",(function(){return Oe})),r.d(n,"exactEquals",(function(){return Pe})),r.d(n,"equals",(function(){return Ve})),r.d(n,"mul",(function(){return Ce})),r.d(n,"sub",(function(){return ke}));var s={};r.r(s),r.d(s,"create",(function(){return Ge})),r.d(s,"clone",(function(){return je})),r.d(s,"length",(function(){return qe})),r.d(s,"fromValues",(function(){return ze})),r.d(s,"copy",(function(){return He})),r.d(s,"set",(function(){return Xe})),r.d(s,"add",(function(){return $e})),r.d(s,"subtract",(function(){return We})),r.d(s,"multiply",(function(){return Ye})),r.d(s,"divide",(function(){return Ke})),r.d(s,"ceil",(function(){return Je})),r.d(s,"floor",(function(){return Ze})),r.d(s,"min",(function(){return Qe})),r.d(s,"max",(function(){return et})),r.d(s,"round",(function(){return tt})),r.d(s,"scale",(function(){return rt})),r.d(s,"scaleAndAdd",(function(){return nt})),r.d(s,"distance",(function(){return st})),r.d(s,"squaredDistance",(function(){return at})),r.d(s,"squaredLength",(function(){return it})),r.d(s,"negate",(function(){return ot})),r.d(s,"inverse",(function(){return ut})),r.d(s,"normalize",(function(){return ct})),r.d(s,"dot",(function(){return ht})),r.d(s,"cross",(function(){return ft})),r.d(s,"lerp",(function(){return lt})),r.d(s,"hermite",(function(){return dt})),r.d(s,"bezier",(function(){return mt})),r.d(s,"random",(function(){return pt})),r.d(s,"transformMat4",(function(){return gt})),r.d(s,"transformMat3",(function(){return xt})),r.d(s,"transformQuat",(function(){return bt})),r.d(s,"rotateX",(function(){return yt})),r.d(s,"rotateY",(function(){return vt})),r.d(s,"rotateZ",(function(){return Mt})),r.d(s,"angle",(function(){return wt})),r.d(s,"zero",(function(){return _t})),r.d(s,"str",(function(){return Tt})),r.d(s,"exactEquals",(function(){return Ut})),r.d(s,"equals",(function(){return St})),r.d(s,"sub",(function(){return Ft})),r.d(s,"mul",(function(){return At})),r.d(s,"div",(function(){return Lt})),r.d(s,"dist",(function(){return Dt})),r.d(s,"sqrDist",(function(){return It})),r.d(s,"len",(function(){return Bt})),r.d(s,"sqrLen",(function(){return Nt})),r.d(s,"forEach",(function(){return Rt}));var a={};r.r(a),r.d(a,"create",(function(){return Vt})),r.d(a,"identity",(function(){return Ct})),r.d(a,"setAxisAngle",(function(){return kt})),r.d(a,"getAxisAngle",(function(){return Gt})),r.d(a,"getAngle",(function(){return jt})),r.d(a,"multiply",(function(){return qt})),r.d(a,"rotateX",(function(){return zt})),r.d(a,"rotateY",(function(){return Ht})),r.d(a,"rotateZ",(function(){return Xt})),r.d(a,"calculateW",(function(){return $t})),r.d(a,"exp",(function(){return Wt})),r.d(a,"ln",(function(){return Yt})),r.d(a,"pow",(function(){return Kt})),r.d(a,"slerp",(function(){return Jt})),r.d(a,"random",(function(){return Zt})),r.d(a,"invert",(function(){return Qt})),r.d(a,"conjugate",(function(){return er})),r.d(a,"fromMat3",(function(){return tr})),r.d(a,"fromEuler",(function(){return rr})),r.d(a,"str",(function(){return nr})),r.d(a,"clone",(function(){return fr})),r.d(a,"fromValues",(function(){return lr})),r.d(a,"copy",(function(){return dr})),r.d(a,"set",(function(){return mr})),r.d(a,"add",(function(){return pr})),r.d(a,"mul",(function(){return gr})),r.d(a,"scale",(function(){return xr})),r.d(a,"dot",(function(){return br})),r.d(a,"lerp",(function(){return yr})),r.d(a,"length",(function(){return vr})),r.d(a,"len",(function(){return Mr})),r.d(a,"squaredLength",(function(){return wr})),r.d(a,"sqrLen",(function(){return _r})),r.d(a,"normalize",(function(){return Tr})),r.d(a,"exactEquals",(function(){return Ur})),r.d(a,"equals",(function(){return Sr})),r.d(a,"rotationTo",(function(){return Er})),r.d(a,"sqlerp",(function(){return Fr})),r.d(a,"setAxes",(function(){return Ar}));const i="a618033708a5d5b97c208367da1fc86204a9ab75",o=(i.slice(0,8),`https://github.com/themikelester/gfx-boilerplate/tree/${i}`);var u,c,h,f,l,d,m,p,g,x,b,y,v;function M(e){switch(e){case c.Float:return 4;case c.Float2:return 8;case c.Float3:return 12;case c.Float4:return 16;case c.Int:return 4;case c.Int2:return 8;case c.Int3:return 12;case c.Int4:return 16;case c.Uint:return 4;case c.Uint2:return 8;case c.Uint3:return 12;case c.Uint4:return 16;case c.Short:return 2;case c.Short2:return 4;case c.Short3:return 6;case c.Short4:return 8;case c.Ushort:return 2;case c.Ushort2:return 4;case c.Ushort3:return 6;case c.Ushort4:return 8;case c.Char:return 1;case c.Char2:return 2;case c.Char3:return 3;case c.Char4:return 4;case c.Uchar:return 1;case c.Uchar2:return 2;case c.Uchar3:return 3;case c.Uchar4:return 4;case c.Half:return 2;case c.Half2:return 4;case c.Half3:return 6;case c.Half4:return 8;case c.Float3x3:return 36;case c.Float4x4:return 64;default:throw new Error(`Unsupported type: ${e}`)}}!function(e){e[e.VertexArrayObject=1]="VertexArrayObject",e[e.TextureFloat=2]="TextureFloat",e[e.TextureHalf=4]="TextureHalf",e[e.TextureFloatLinearFiltering=8]="TextureFloatLinearFiltering",e[e.TextureHalfLinearFiltering=16]="TextureHalfLinearFiltering",e[e.TextureWrite=32]="TextureWrite",e[e.ShaderDerivatives=64]="ShaderDerivatives",e[e.Instancing=128]="Instancing",e[e.AnistropicFiltering=256]="AnistropicFiltering"}(u||(u={})),function(e){e[e.Undefined=0]="Undefined",e[e.Float=1]="Float",e[e.Float2=2]="Float2",e[e.Float3=3]="Float3",e[e.Float4=4]="Float4",e[e.Int=5]="Int",e[e.Int2=6]="Int2",e[e.Int3=7]="Int3",e[e.Int4=8]="Int4",e[e.Uint=9]="Uint",e[e.Uint2=10]="Uint2",e[e.Uint3=11]="Uint3",e[e.Uint4=12]="Uint4",e[e.Short=13]="Short",e[e.Short2=14]="Short2",e[e.Short3=15]="Short3",e[e.Short4=16]="Short4",e[e.Ushort=17]="Ushort",e[e.Ushort2=18]="Ushort2",e[e.Ushort3=19]="Ushort3",e[e.Ushort4=20]="Ushort4",e[e.Char=21]="Char",e[e.Char2=22]="Char2",e[e.Char3=23]="Char3",e[e.Char4=24]="Char4",e[e.Uchar=25]="Uchar",e[e.Uchar2=26]="Uchar2",e[e.Uchar3=27]="Uchar3",e[e.Uchar4=28]="Uchar4",e[e.Half=29]="Half",e[e.Half2=30]="Half2",e[e.Half3=31]="Half3",e[e.Half4=32]="Half4",e[e.Float3x3=33]="Float3x3",e[e.Float3x4=34]="Float3x4",e[e.Float4x4=35]="Float4x4",e[e.Texture2D=240]="Texture2D",e[e.Texture3D=241]="Texture3D",e[e.TextureCube=242]="TextureCube",e[e.Short_Norm=256]="Short_Norm",e[e.Short2_Norm=257]="Short2_Norm",e[e.Short3_Norm=258]="Short3_Norm",e[e.Short4_Norm=259]="Short4_Norm",e[e.Ushort_Norm=260]="Ushort_Norm",e[e.Ushort2_Norm=261]="Ushort2_Norm",e[e.Ushort3_Norm=262]="Ushort3_Norm",e[e.Ushort4_Norm=263]="Ushort4_Norm",e[e.Char_Norm=264]="Char_Norm",e[e.Char2_Norm=265]="Char2_Norm",e[e.Char3_Norm=266]="Char3_Norm",e[e.Char4_Norm=267]="Char4_Norm",e[e.Uchar_Norm=268]="Uchar_Norm",e[e.Uchar2_Norm=269]="Uchar2_Norm",e[e.Uchar3_Norm=270]="Uchar3_Norm",e[e.Uchar4_Norm=271]="Uchar4_Norm"}(c||(c={})),function(e){e[e.Texture2D=240]="Texture2D",e[e.Texture3D=241]="Texture3D",e[e.TextureCube=242]="TextureCube"}(h||(h={})),function(e){e[e.Undefined=0]="Undefined",e[e.U565=1]="U565",e[e.U8=2]="U8",e[e.U8_sRGB=3]="U8_sRGB",e[e.U8x2=4]="U8x2",e[e.U8x2_sRGB=5]="U8x2_sRGB",e[e.U8x3=6]="U8x3",e[e.U8x3_sRGB=7]="U8x3_sRGB",e[e.U8x4=8]="U8x4",e[e.U8x4_sRGB=9]="U8x4_sRGB",e[e.U10_10_10_2=10]="U10_10_10_2",e[e.F11_11_10=11]="F11_11_10",e[e.F16=12]="F16",e[e.F16x2=13]="F16x2",e[e.F16x3=14]="F16x3",e[e.F16x4=15]="F16x4",e[e.F32x2=16]="F32x2",e[e.F32x3=17]="F32x3",e[e.F32x4=18]="F32x4",e[e.Depth32=19]="Depth32",e[e.Depth24Stencil8=20]="Depth24Stencil8"}(f||(f={})),function(e){e[e.Nearest=0]="Nearest",e[e.Linear=1]="Linear"}(l||(l={})),function(e){e[e.Never=0]="Never",e[e.Less=1]="Less",e[e.Equal=2]="Equal",e[e.LessEqual=3]="LessEqual",e[e.Greater=4]="Greater",e[e.NotEqual=5]="NotEqual",e[e.GreaterEqual=6]="GreaterEqual",e[e.Always=7]="Always"}(d||(d={})),function(e){e[e.Points=0]="Points",e[e.Lines=1]="Lines",e[e.LineLoop=2]="LineLoop",e[e.LineStrip=3]="LineStrip",e[e.Triangles=4]="Triangles",e[e.TriangleStrip=5]="TriangleStrip",e[e.TriangleFan=6]="TriangleFan"}(m||(m={})),function(e){e[e.Undefined=0]="Undefined",e[e.Uniform=1]="Uniform",e[e.Vertex=2]="Vertex",e[e.Index=3]="Index",e[e.Readback=4]="Readback"}(p||(p={})),function(e){e[e.Undefined=0]="Undefined",e[e.UniformBuffer=1]="UniformBuffer",e[e.Texture=2]="Texture"}(g||(g={})),function(e){e[e.None=0]="None",e[e.Static=1]="Static",e[e.Dynamic=2]="Dynamic"}(x||(x={})),function(e){e[e.None=0]="None",e[e.Back=1]="Back",e[e.Front=2]="Front"}(b||(b={})),function(e){e[e.Zero=0]="Zero",e[e.One=1]="One",e[e.Source=2]="Source",e[e.OneMinusSource=3]="OneMinusSource"}(y||(y={})),function(e){e[e.Vertex=0]="Vertex",e[e.Instance=1]="Instance"}(v||(v={}));let w;function _(e){switch(e){case w.FLOAT:return c.Float;case w.FLOAT_VEC2:return c.Float2;case w.FLOAT_VEC3:return c.Float3;case w.FLOAT_VEC4:return c.Float4;case w.INT:return c.Int;case w.INT_VEC2:return c.Int2;case w.INT_VEC3:return c.Int3;case w.INT_VEC4:return c.Int4;case w.FLOAT_MAT3:return c.Float3x3;case w.FLOAT_MAT4:return c.Float4x4;case w.SAMPLER_2D:return c.Texture2D;case w.SAMPLER_3D:return c.Texture3D;case w.SAMPLER_CUBE:return c.TextureCube;case w.UNSIGNED_INT:return c.Uint;case w.UNSIGNED_INT_VEC2:return c.Uint2;case w.UNSIGNED_INT_VEC3:return c.Uint3;case w.UNSIGNED_INT_VEC4:return c.Uint4;default:return P(`Unsupported WebGL type: ${e}`)}}function T(e){switch(255&e){case c.Float:return 1;case c.Float2:return 2;case c.Float3:return 3;case c.Float4:return 4;case c.Int:return 1;case c.Int2:return 2;case c.Int3:return 3;case c.Int4:return 4;case c.Uint:return 1;case c.Uint2:return 2;case c.Uint3:return 3;case c.Uint4:return 4;case c.Short:return 1;case c.Short2:return 2;case c.Short3:return 3;case c.Short4:return 4;case c.Ushort:return 1;case c.Ushort2:return 2;case c.Ushort3:return 3;case c.Ushort4:return 4;case c.Char:return 1;case c.Char2:return 2;case c.Char3:return 3;case c.Char4:return 4;case c.Uchar:return 1;case c.Uchar2:return 2;case c.Uchar3:return 3;case c.Uchar4:return 4;case c.Half:return 1;case c.Half2:return 2;case c.Half3:return 3;case c.Half4:return 4;default:return P(`Unsupported type: ${e}`)}}function U(e){switch(e){case c.Float:case c.Float2:case c.Float3:case c.Float4:return w.FLOAT;case c.Int:case c.Int2:case c.Int3:case c.Int4:return w.INT;case c.Uint:case c.Uint2:case c.Uint3:case c.Uint4:return w.UNSIGNED_INT;case c.Short:case c.Short2:case c.Short3:case c.Short4:return w.SHORT;case c.Ushort:case c.Ushort2:case c.Ushort3:case c.Ushort4:return w.UNSIGNED_SHORT;case c.Char:case c.Char2:case c.Char3:case c.Char4:return w.BYTE;case c.Uchar:case c.Uchar2:case c.Uchar3:case c.Uchar4:return w.UNSIGNED_BYTE;case c.Half:case c.Half2:case c.Half3:case c.Half4:return w.HALF_FLOAT;default:return P(`Unsupported type: ${e}`)}}function S(e){switch(e){case m.Points:return w.POINTS;case m.Lines:return w.LINES;case m.LineLoop:return w.LINE_LOOP;case m.LineStrip:return w.LINE_STRIP;case m.Triangles:return w.TRIANGLES;case m.TriangleStrip:return w.TRIANGLE_STRIP;case m.TriangleFan:return w.TRIANGLE_FAN;default:return P(`Unsupported primitive type: ${e}`)}}function E(e){switch(e){case c.Short_Norm:case c.Short2_Norm:case c.Short3_Norm:case c.Short4_Norm:case c.Ushort_Norm:case c.Ushort2_Norm:case c.Ushort3_Norm:case c.Ushort4_Norm:case c.Char_Norm:case c.Char2_Norm:case c.Char3_Norm:case c.Char4_Norm:case c.Uchar_Norm:case c.Uchar2_Norm:case c.Uchar3_Norm:case c.Uchar4_Norm:return!0;default:return!1}}function F(e){switch(e){case c.Uchar:return w.UNSIGNED_BYTE;case c.Uint:return w.UNSIGNED_INT;case c.Ushort:return w.UNSIGNED_SHORT;default:return P(`Unsupported index type: ${e}`)}}function A(e){switch(e){case h.Texture2D:return w.TEXTURE_2D;case h.Texture3D:return w.TEXTURE_3D;case h.TextureCube:return w.TEXTURE_CUBE_MAP;default:return P(`Unsupported texture type: ${e}`)}}function L(e){switch(e){case f.U565:return w.RGB;case f.U8:return w.ALPHA;case f.U8x3:case f.U8x3_sRGB:return w.RGB;case f.U8x4:case f.U8x4_sRGB:return w.RGBA;case f.F16:return w.ALPHA;case f.F16x4:case f.F32x4:return w.RGBA;case f.Depth32:return w.DEPTH_COMPONENT;case f.Depth24Stencil8:return w.DEPTH_STENCIL;default:return P(`Unsupported texel format: ${e}`)}}function D(e){switch(e){case f.U565:return w.RGB;case f.U8:case f.U8_sRGB:return w.RED;case f.U8x2:case f.U8x2_sRGB:return w.RG;case f.U8x3:case f.U8x3_sRGB:return w.RGB;case f.U8x4:case f.U8x4_sRGB:case f.U10_10_10_2:return w.RGBA;case f.F16:return w.RED;case f.F16x2:return w.RG;case f.F16x4:return w.RGBA;case f.F32x2:return w.RG;case f.F32x4:return w.RGBA;case f.F11_11_10:return w.RGB;case f.Depth32:return w.DEPTH_COMPONENT;case f.Depth24Stencil8:return w.DEPTH_STENCIL;default:return P(`Unsupported texel format: ${e}`)}}function I(e){switch(e){case f.U565:return w.RGB565;case f.U8:case f.U8_sRGB:return w.R8;case f.U8x2:case f.U8x2_sRGB:return w.RG8;case f.U8x3:case f.U8x3_sRGB:return w.RGB8;case f.U8x4:case f.U8x4_sRGB:return w.RGBA8;case f.U10_10_10_2:return w.RGB10_A2;case f.F16:return w.R16F;case f.F16x2:return w.RG16F;case f.F16x3:return w.RGB16F;case f.F16x4:return w.RGBA16F;case f.F32x2:return w.RG32F;case f.F32x3:return w.RGB32F;case f.F32x4:return w.RGBA32F;case f.Depth32:return w.DEPTH_COMPONENT32F;case f.Depth24Stencil8:return w.DEPTH24_STENCIL8;default:return P(`Unsupported texel format: ${e}`)}}function B(e){switch(e){case f.Undefined:return 0;case f.U565:return w.UNSIGNED_SHORT_5_6_5;case f.U8:case f.U8_sRGB:case f.U8x2:case f.U8x2_sRGB:case f.U8x3:case f.U8x3_sRGB:case f.U8x4:case f.U8x4_sRGB:return w.UNSIGNED_BYTE;case f.U10_10_10_2:return w.RGBA;case f.F11_11_10:return w.FLOAT;case f.F16:case f.F16x2:case f.F16x4:return w.HALF_FLOAT;case f.F32x2:case f.F32x4:case f.Depth32:return w.FLOAT;case f.Depth24Stencil8:return w.UNSIGNED_INT_24_8;default:return P(`Unsupported texel format: ${e}`)}}function N(e){switch(e){case l.Nearest:return w.NEAREST;case l.Linear:return w.LINEAR;default:return P(`Unsupported texture filter: ${e}`)}}function R(e){switch(e){case y.Zero:return w.ZERO;case y.One:return w.One;case y.Source:return w.SRC_ALPHA;case y.OneMinusSource:return w.ONE_MINUS_SRC_ALPHA;default:return P(`Unsupported blend factor: ${e}`)}}function O(e,t="Assert failed"){e||P(t)}function P(e){throw console.error(e),new Error(e)}function V(e,t){return void 0!==e?e:t}function C(e){return null!=e}function k(e){return e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof ImageBitmap}function G(e,t,r){const n=w.createShader(t);if(w.shaderSource(n,r),w.compileShader(n),!w.getShaderParameter(n,w.COMPILE_STATUS)){P(`${t===w.VERTEX_SHADER?"Vertex":"Fragment"} compilation failed for shader ${e}:\n  ${w.getShaderInfoLog(n)}`)}return n}function j(e,t,r){const n=e.vertexLayout.buffers[r],s=e.shader.reflection,a=Object.keys(n.layout);w.bindBuffer(w.ARRAY_BUFFER,t.buffer.glId);for(let e=0;e<a.length;e++){const r=n.layout[a[e]],i=s.attributes[a[e]];if(C(i))if(t.buffer){const e=U(r.type),s=E(r.type);w.enableVertexAttribArray(i.location),w.vertexAttribPointer(i.location,i.components,e,s,n.stride,r.offset+t.offset),n.stepMode===v.Instance&&(w.instancedArrays?w.instancedArrays.vertexAttribDivisorANGLE(i.location,1):w.vertexAttribDivisor(i.location,1))}else w.disableVertexAttribArray(i.location)}}function q(e){return e.type===g.Texture}class z{constructor(){this.objects=[],this.freeList=[],this.count=0}get(e){const t=this.objects[e];return O(void 0!==t,"Invalid ID"),t}create(e){if(++this.count,this.freeList.length>0){const t=this.freeList.pop();return this.objects[t]=e,t}return this.objects.push(e),this.objects.length-1}delete(e){--this.count,delete this.objects[e],this.freeList.push(e)}}class H{constructor(){this.debugEnabled=!1,this.buffers=new z,this.textures=new z,this.shaders=new z,this.renderPipelines=new z,this.resourceTables=new z,this.vertexTables=new z,this.renderPasses=new z,this.depthStencilStates=new z}initialize(e){const t={alpha:!1,antialias:!1,preserveDrawingBuffer:!1};if(w=e.getContext("webgl2",t),w||(w=e.getContext("webgl",t)),!w)return!1;this.webGlVersion=w instanceof WebGLRenderingContext?1:2,console.debug(`Initialized WebGL${this.webGlVersion} context`),this.featureFlags=function(e){let t,r=0;return(t=w.getExtension("OES_vertex_array_object"))&&(r|=u.VertexArrayObject,w.createVertexArray=t.createVertexArrayOES.bind(t),w.deleteVertexArray=t.deleteVertexArrayOES.bind(t),w.bindVertexArray=t.bindVertexArrayOES.bind(t)),(t=w.getExtension("OES_texture_half_float"))&&(r|=u.TextureHalf,w.HALF_FLOAT=t.HALF_FLOAT_OES),(t=w.getExtension("EXT_texture_filter_anisotropic")||w.getExtension("MOZ_EXT_texture_filter_anisotropic")||w.getExtension("WEBKIT_EXT_texture_filter_anisotropic"))&&(r|=u.AnistropicFiltering,w.MAX_TEXTURE_MAX_ANISOTROPY_EXT=t.MAX_TEXTURE_MAX_ANISOTROPY_EXT,w.TEXTURE_MAX_ANISOTROPY_EXT=t.TEXTURE_MAX_ANISOTROPY_EXT),w.getExtension("OES_texture_float")&&(r|=u.TextureFloat),w.getExtension("OES_texture_float_linear")&&(r|=u.TextureFloatLinearFiltering),w.getExtension("OES_texture_half_float_linear")&&(r|=u.TextureHalfLinearFiltering),w.getExtension("OES_standard_derivatives")&&(r|=u.ShaderDerivatives),w.texSubImage2D&&(r|=u.TextureWrite),(w.instancedArrays=w.getExtension("ANGLE_instanced_arrays"))&&(r|=u.Instancing),e>=2&&(r|=u.VertexArrayObject,r|=u.TextureFloat,r|=u.TextureHalf,r|=u.Instancing),r}(this.webGlVersion),this.defaultRenderPass=this.renderPasses.create({name:"Default",width:e.width,height:e.height}),O(0===this.defaultRenderPass),this.current={},w.clearColor(0,0,0,1);const r=new Uint8Array([0,0,0,1]),n={usage:x.Static,type:h.Texture2D,format:f.U8x4,width:1,height:1},s=this.createTexture("DefaultTexture",n,r);return this.defaultTexture=this.textures.get(s),this.isGfxFeatureSupported(u.AnistropicFiltering)&&(this.maxAnisotropy=w.getParameter(w.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),w.pixelStorei(w.UNPACK_COLORSPACE_CONVERSION_WEBGL,w.NONE),!0}isGfxFeatureSupported(e){return!!(this.featureFlags&e)}setDebugEnabled(e){this.debugEnabled=e}resize(e,t){const r=this.renderPasses.get(this.defaultRenderPass);r.width=e,r.height=t}beginFrame(){}endFrame(){}bindRenderPass(e){const t=this.renderPasses.get(e);w.bindFramebuffer(w.FRAMEBUFFER,t.glFramebuffer),w.viewport(0,0,t.width,t.height);const r=w.COLOR_BUFFER_BIT;w.clear(r)}bindPipeline(e){const t=this.renderPipelines.get(e);this.pipeline=t,this.current.shader!==t.shader&&(w.useProgram(t.shader.glProgram),this.current.shader=t.shader),t.renderFormat.blendingEnabled!=this.current.blending&&(this.current.blending=t.renderFormat.blendingEnabled,t.renderFormat.blendingEnabled?w.enable(w.BLEND):w.disable(w.BLEND)),!this.current.blending||this.current.srcBlendFactor==t.renderFormat.srcBlendFactor&&this.current.dstBlendFactor==t.renderFormat.dstBlendFactor||(this.current.srcBlendFactor=V(t.renderFormat.srcBlendFactor,y.One),this.current.dstBlendFactor=V(t.renderFormat.dstBlendFactor,y.OneMinusSource),w.blendFunc(R(this.current.srcBlendFactor),R(this.current.dstBlendFactor)))}draw(e,t,r,n,s){const a=S(e),i=F(r),o=M(r),u=this.buffers.get(t);w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,u.glId),w.drawElements(a,s,i,n*o)}drawInstanced(e,t,r,n,s,a){const i=S(e),o=F(r),u=M(r),c=this.buffers.get(t);w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,c.glId),w.instancedArrays?w.instancedArrays.drawElementsInstancedANGLE(i,s,o,n*u,a):w.drawElementsInstanced(i,s,o,n*u,a)}drawNonIndexed(e,t,r){const n=S(e);w.drawArrays(n,t,r)}setDepthStencilState(e){const t=this.depthStencilStates.get(e),r=this.current.depthStencil;r&&t.depthWriteEnabled==r.depthWriteEnabled||w.depthMask(t.depthWriteEnabled),r&&t.depthCompareFunc==r.depthCompareFunc||w.depthFunc(t.depthCompareFunc),r&&t.depthTestEnabled==r.depthTestEnabled||(t.depthTestEnabled?w.enable(w.DEPTH_TEST):w.disable(w.DEPTH_TEST)),this.current.depthStencil=t}setCullMode(e){this.current.cullMode!=e&&(this.current.cullMode=e,e==b.None?w.disable(w.CULL_FACE):(w.enable(w.CULL_FACE),w.cullFace(function(e){switch(e){case b.None:return w.NONE;case b.Back:return w.BACK;case b.Front:return w.FRONT;default:return P(`Unsupported culling mode: ${e}`)}}(e))))}createDepthStencilState(e){const t=function(e){switch(e){case d.Never:return w.NEVER;case d.Less:return w.LESS;case d.Equal:return w.EQUAL;case d.LessEqual:return w.LEQUAL;case d.Greater:return w.GREATER;case d.NotEqual:return w.NOTEQUAL;case d.GreaterEqual:return w.GEQUAL;case d.Always:return w.ALWAYS;default:return P(`Unsupported compare func: ${e}`)}}(V(e.depthCompareFunc,d.Less));return this.depthStencilStates.create({depthTestEnabled:e.depthTestEnabled,depthWriteEnabled:e.depthWriteEnabled,depthCompareFunc:t})}createVertexTable(e){const t=this.renderPipelines.get(e);let r=null;return this.isGfxFeatureSupported(u.VertexArrayObject)&&(r=w.createVertexArray()),this.vertexTables.create({pipeline:t,vao:r,buffers:[]})}removeVertexTable(e){if(this.isGfxFeatureSupported(u.VertexArrayObject)){const t=this.vertexTables.get(e);w.deleteVertexArray(t.vao)}this.vertexTables.delete(e)}createResourceTable(e){return this.resourceTables.create({layout:e,buffers:[],textures:[]})}removeResourceTable(e){this.resourceTables.delete(e)}bindVertices(e){const t=this.vertexTables.get(e);if(this.isGfxFeatureSupported(u.VertexArrayObject))w.bindVertexArray(t.vao);else for(let e=0;e<t.buffers.length;e++)j(t.pipeline,t.buffers[e],e)}bindResources(e){const t=this.resourceTables.get(e),r=this.pipeline.uniformLayout,n=this.pipeline.shader.reflection,s=this.pipeline.shader.name;for(let e=0;e<n.uniforms.length;e++){const s=n.uniforms[e],a=r[s.name],i=t.buffers[a.index].buffer.cpuBuffer;O(C(i));const o=new Float32Array(i.buffer,a.offset,s.size/4),u=this.pipeline.shader.uniformVals[s.name];if(!o.every((e,t)=>e===u[t]))switch(this.pipeline.shader.uniformVals[s.name].set(o),s.type){case c.Float:w.uniform1fv(s.location,o);break;case c.Float2:w.uniform2fv(s.location,o);break;case c.Float3:w.uniform3fv(s.location,o);break;case c.Float4:w.uniform4fv(s.location,o);break;case c.Float3x3:w.uniformMatrix3fv(s.location,!1,o);break;case c.Float4x4:w.uniformMatrix4fv(s.location,!1,o);break;default:P("Unknown shader uniform type")}}for(let e=0;e<n.textureArray.length;e++){const a=n.textureArray[e],i=r[a.name].index;void 0===t.textures[i]&&console.warn(`Shader ${s} expects texture "${a.name}" (index ${i}) to be bound`);for(let e=0;e<a.count;e++){const r=t.textures[i+e]||this.defaultTexture,n=a.location+e;w.activeTexture(w.TEXTURE0+n),w.bindTexture(r.target,r.glId)}}}setVertexBuffer(e,t,r){const n=this.vertexTables.get(e),s={buffer:this.buffers.get(r.buffer),offset:r.byteOffset||0};O(t<16),n.buffers[t]=s,this.isGfxFeatureSupported(u.VertexArrayObject)&&(w.bindVertexArray(n.vao),j(n.pipeline,s,t))}setBuffer(e,t,r){const n=this.resourceTables.get(e),s=this.buffers.get(r.buffer);n.buffers[t]={buffer:s,offset:r.byteOffset||0}}setTexture(e,t,r){const n=this.resourceTables.get(e),s=r?this.textures.get(r):null;n.textures[t]=s}setTextures(e,t,r){const n=this.resourceTables.get(e);for(let e=0;e<r.length;e++){const s=r[e]?this.textures.get(r[e]):null;n.textures[t+e]=s}}writeBufferData(e,t,r){const n=this.buffers.get(e);if(n.type===p.Uniform){const e=ArrayBuffer.isView(r)?r.buffer:r,s=new Uint8Array(e);C(n.cpuBuffer)?n.cpuBuffer.set(s,t):P("No CPU buffer assigned to uniform buffer")}else w.bindBuffer(n.target,n.glId),w.bufferSubData(n.target,t,r)}createRenderPipeline(e,t,r,n){const s=this.shaders.get(e),a=Object.keys(n),i=a.map(e=>n[e]),o=s.reflection;if(this.debugEnabled){for(const e of a){const t=n[e];t.type===g.UniformBuffer&&O(void 0!==t.layout,`A BufferLayout must be provided for UniformBuffer "${e}" in the ResourceLayout passed to createRenderPipeline()`+"to define uniform binding locations. In WebGL2/GLSL300 it may be possible to define binding locations completely within the shader")}for(let e=0;e<o.uniforms.length;e++){const t=o.uniforms[e],r=i.find(e=>!q(e)&&e.layout&&e.layout[t.name]);O(void 0!==r,`Shader '${name}' expects uniform '${t.name}' to be set in a uniform buffer`);const n=r.layout[t.name].type;if(O(n===t.type,`Shader '${name}' expects uniform '${t.name}' to be type ${t.type} but the ShaderResourceLayout specifies type ${n}`),t.count>1){const e=r.layout[t.name].count;O(void 0!==e,`Shader '${name}' expects uniform '${t.name}' to be an array but the ShaderResourceLayout specifies a scalar value`),O(e>=t.count,`Shader '${name}' expects uniform '${t.name}' to be an array of length ${t.count} but the ShaderResourceLayout specifies a length of ${e}`)}}for(let e=0;e<o.textureArray.length;e++){const t=o.textureArray[e],r=i.find((e,r)=>q(e)&&a[r]===t.name);O(void 0!==r,`Shader '${name}' expects texture '${t.name}', but it is not defined in the ShaderResourceLayout`),O((r.count||1)===t.count,`Shader '${name}' expects texture '${t.name}' to be an array of length ${t.count}, but the ResourceLayout specifies length ${r.count}`)}Object.keys(o.attributes).forEach(e=>{O(void 0!==r.buffers.find(t=>t&&void 0!==t.layout[e]),`VertexLayout does not supply attribute ${e} required by Shader '${s.name}'`)}),this.isGfxFeatureSupported(u.Instancing)||r.buffers.forEach(e=>{O(e.stepMode!==v.Instance,"Instancing is not supported by this WebGL context")})}const c={};for(let e=0;e<o.uniforms.length;e++){const t=o.uniforms[e],r=i.find(e=>!q(e)&&e.layout&&e.layout[t.name]);c[t.name]={offset:r.layout[t.name].offset,index:r.index}}for(let e=0;e<o.textureArray.length;e++){const t=o.textureArray[e],r=n[t.name];c[t.name]={offset:0,index:r.index}}return this.renderPipelines.create({shader:s,renderFormat:t,vertexLayout:r,resourceLayout:n,uniformLayout:c})}removeRenderPipeline(e){this.renderPipelines.delete(e)}createShader(e){return this._createShader(e.name,e.vertSource,e.fragSource)}_createShader(e,t,r){const n=function(e,t,r){const n=G(e,w.VERTEX_SHADER,t),s=G(e,w.FRAGMENT_SHADER,r),a=w.createProgram();return w.attachShader(a,n),w.attachShader(a,s),w.linkProgram(a),w.deleteShader(n),w.deleteShader(s),w.getProgramParameter(a,w.LINK_STATUS)||P(`Linking failed for shader ${e}:\n  ${w.getProgramInfoLog(a)}`),a}(e,t instanceof Array?t.join("\n#line 0\n"):t,r instanceof Array?r.join("\n#line 0\n"):r),s=function(e){const t={},r=[],n=[],s={};let a=0;const i=w.getProgramParameter(e,w.ACTIVE_ATTRIBUTES);O(i<16);for(let t=0;t<i;t++){const r=w.getActiveAttrib(e,t),n=_(r.type);s[r.name]={location:t,count:r.size,components:T(n),glType:U(n),type:n}}const o=w.getProgramParameter(e,w.ACTIVE_UNIFORMS);O(o<64);for(let s=0;s<o;s++){const i=w.getActiveUniform(e,s),o=_(i.type),u=i.name.replace("[0]","");if(o>=h.Texture2D&&o<=h.TextureCube){const n={name:u,count:i.size,type:o,location:a,locationGl:w.getUniformLocation(e,i.name)};a+=i.size,t[u]=n,r.push(n)}else{const t={name:u,count:i.size,type:o,size:M(o)*i.size,location:w.getUniformLocation(e,i.name)};n.push(t)}}return{attributes:s,uniforms:n,textures:t,textureArray:r,textureCount:a}}(n),a={};for(let e=0;e<s.uniforms.length;e++){const t=s.uniforms[e];a[t.name]=new Float32Array(t.size/4)}w.useProgram(n);const i=Object.keys(s.textures);for(let e=0;e<i.length;e++){const t=s.textures[i[e]],r=Array.from(Array(t.count).keys()).map((e,r)=>t.location+r);w.uniform1iv(t.locationGl,r)}return this.current.shader=void 0,this.shaders.create({name:e,glProgram:n,reflection:s,uniformVals:a})}removeShader(e){const t=this.shaders.get(e);w.deleteProgram(t.glProgram),this.shaders.delete(e)}createTexture(e,t,r){const n=!r||r.buffer instanceof ArrayBuffer&&void 0!==r.byteLength,s=1===this.webGlVersion?L:D,a={target:A(t.type),format:s(t.format),internalFormat:this.webGlVersion>1?I(t.format):s(t.format),type:B(t.format),usage:t.usage,width:n?V(t.width,1):r.width,height:n?V(t.height,1):r.height,depth:t.depth||1,minFilter:N(void 0!==t.defaultMinFilter?t.defaultMinFilter:l.Linear),magFilter:N(void 0!==t.defaultMagFilter?t.defaultMagFilter:l.Linear),glId:w.createTexture()};if(w.bindTexture(a.target,a.glId),w.texParameteri(a.target,w.TEXTURE_MIN_FILTER,a.minFilter),w.texParameteri(a.target,w.TEXTURE_MAG_FILTER,a.magFilter),w.texParameteri(a.target,w.TEXTURE_WRAP_S,w.CLAMP_TO_EDGE),w.texParameteri(a.target,w.TEXTURE_WRAP_T,w.CLAMP_TO_EDGE),C(t.maxAnistropy)&&t.maxAnistropy>1&&this.isGfxFeatureSupported(u.AnistropicFiltering)){const e=Math.min(this.maxAnisotropy,t.maxAnistropy);w.texParameterf(w.TEXTURE_2D,w.TEXTURE_MAX_ANISOTROPY_EXT,e)}const i=this.webGlVersion>1?a.internalFormat:a.format;if(t.type===h.Texture3D)w.texImage3D(a.target,0,i,a.width,a.height,a.depth,0,a.format,a.type,r);else if(n)r instanceof ArrayBuffer&&(r=new Uint8Array(r)),w.texImage2D(a.target,0,i,a.width,a.height,0,a.format,a.type,r);else if(void 0!==r)w.texImage2D(a.target,0,i,a.format,a.type,r);else{O(void 0!==a.width&&void 0!==a.height,"Image is null. If attempting to create an empty texture, width and height must be specified"),w.texImage2D(a.target,0,i,t.width,t.height,0,a.format,a.type,null)}return this.textures.create(a)}writeTextureData(e,t){const r=this.textures.get(e);O(r.target===w.TEXTURE_2D,"Currently only 2D textures may be written to"),w.bindTexture(r.target,r.glId);const n=k(t)?t.width!==r.width:!!k(t)&&t.height!==r.height;this.isGfxFeatureSupported(u.TextureWrite)&&!n?k(t)?w.texSubImage2D(r.target,0,0,0,r.format,r.type,t):w.texSubImage2D(r.target,0,0,0,r.width,r.height,r.format,r.type,t):w.texImage2D(r.target,0,r.internalFormat,r.format,r.type,t)}removeTexture(e){const t=this.textures.get(e);w.deleteTexture(t.glId),this.textures.delete(e)}createBuffer(e,t,r,n){let s,a;O(r!=x.None);const i=function(e){switch(e){case p.Undefined:return 0;case p.Uniform:return w.UNIFORM_BUFFER;case p.Vertex:return w.ARRAY_BUFFER;case p.Index:return w.ELEMENT_ARRAY_BUFFER;case p.Readback:return w.TRANSFORM_FEEDBACK_BUFFER}}(t),o=e=>Number.isInteger(e),u=e=>e instanceof ArrayBuffer,c=o(n)?null:n,h=o(n)?n:n.byteLength;if(O(h>0||null!==c,"Either an ArrayBuffer or size must be provided"),t!=p.Uniform)a=w.createBuffer(),w.bindBuffer(i,a),w.bufferData(i,n,r==x.Dynamic?w.DYNAMIC_DRAW:w.STATIC_DRAW);else if(c){const e=u(c)?c:c.buffer,t=u(c)?0:c.byteOffset;s=new Uint8Array(e,t,h)}else s=new Uint8Array(h);return this.buffers.create({name:e,type:t,target:i,usage:r,size:h,glId:a,cpuBuffer:s})}removeBuffer(e){const t=this.buffers.get(e);t.type!=p.Uniform&&w.deleteBuffer(t.glId),this.buffers.delete(e)}readPixels(e,t,r,n,s){w.readPixels(e,t,r,n,w.RGBA,w.UNSIGNED_BYTE,s)}}var X="undefined"!=typeof Float32Array?Float32Array:Array,$=Math.random;Math.PI;function W(){var e=new X(16);return X!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function Y(e){var t=new X(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function K(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function J(e,t,r,n,s,a,i,o,u,c,h,f,l,d,m,p){var g=new X(16);return g[0]=e,g[1]=t,g[2]=r,g[3]=n,g[4]=s,g[5]=a,g[6]=i,g[7]=o,g[8]=u,g[9]=c,g[10]=h,g[11]=f,g[12]=l,g[13]=d,g[14]=m,g[15]=p,g}function Z(e,t,r,n,s,a,i,o,u,c,h,f,l,d,m,p,g){return e[0]=t,e[1]=r,e[2]=n,e[3]=s,e[4]=a,e[5]=i,e[6]=o,e[7]=u,e[8]=c,e[9]=h,e[10]=f,e[11]=l,e[12]=d,e[13]=m,e[14]=p,e[15]=g,e}function Q(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function ee(e,t){if(e===t){var r=t[1],n=t[2],s=t[3],a=t[6],i=t[7],o=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=n,e[9]=a,e[11]=t[14],e[12]=s,e[13]=i,e[14]=o}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function te(e,t){var r=t[0],n=t[1],s=t[2],a=t[3],i=t[4],o=t[5],u=t[6],c=t[7],h=t[8],f=t[9],l=t[10],d=t[11],m=t[12],p=t[13],g=t[14],x=t[15],b=r*o-n*i,y=r*u-s*i,v=r*c-a*i,M=n*u-s*o,w=n*c-a*o,_=s*c-a*u,T=h*p-f*m,U=h*g-l*m,S=h*x-d*m,E=f*g-l*p,F=f*x-d*p,A=l*x-d*g,L=b*A-y*F+v*E+M*S-w*U+_*T;return L?(L=1/L,e[0]=(o*A-u*F+c*E)*L,e[1]=(s*F-n*A-a*E)*L,e[2]=(p*_-g*w+x*M)*L,e[3]=(l*w-f*_-d*M)*L,e[4]=(u*S-i*A-c*U)*L,e[5]=(r*A-s*S+a*U)*L,e[6]=(g*v-m*_-x*y)*L,e[7]=(h*_-l*v+d*y)*L,e[8]=(i*F-o*S+c*T)*L,e[9]=(n*S-r*F-a*T)*L,e[10]=(m*w-p*v+x*b)*L,e[11]=(f*v-h*w-d*b)*L,e[12]=(o*U-i*E-u*T)*L,e[13]=(r*E-n*U+s*T)*L,e[14]=(p*y-m*M-g*b)*L,e[15]=(h*M-f*y+l*b)*L,e):null}function re(e,t){var r=t[0],n=t[1],s=t[2],a=t[3],i=t[4],o=t[5],u=t[6],c=t[7],h=t[8],f=t[9],l=t[10],d=t[11],m=t[12],p=t[13],g=t[14],x=t[15];return e[0]=o*(l*x-d*g)-f*(u*x-c*g)+p*(u*d-c*l),e[1]=-(n*(l*x-d*g)-f*(s*x-a*g)+p*(s*d-a*l)),e[2]=n*(u*x-c*g)-o*(s*x-a*g)+p*(s*c-a*u),e[3]=-(n*(u*d-c*l)-o*(s*d-a*l)+f*(s*c-a*u)),e[4]=-(i*(l*x-d*g)-h*(u*x-c*g)+m*(u*d-c*l)),e[5]=r*(l*x-d*g)-h*(s*x-a*g)+m*(s*d-a*l),e[6]=-(r*(u*x-c*g)-i*(s*x-a*g)+m*(s*c-a*u)),e[7]=r*(u*d-c*l)-i*(s*d-a*l)+h*(s*c-a*u),e[8]=i*(f*x-d*p)-h*(o*x-c*p)+m*(o*d-c*f),e[9]=-(r*(f*x-d*p)-h*(n*x-a*p)+m*(n*d-a*f)),e[10]=r*(o*x-c*p)-i*(n*x-a*p)+m*(n*c-a*o),e[11]=-(r*(o*d-c*f)-i*(n*d-a*f)+h*(n*c-a*o)),e[12]=-(i*(f*g-l*p)-h*(o*g-u*p)+m*(o*l-u*f)),e[13]=r*(f*g-l*p)-h*(n*g-s*p)+m*(n*l-s*f),e[14]=-(r*(o*g-u*p)-i*(n*g-s*p)+m*(n*u-s*o)),e[15]=r*(o*l-u*f)-i*(n*l-s*f)+h*(n*u-s*o),e}function ne(e){var t=e[0],r=e[1],n=e[2],s=e[3],a=e[4],i=e[5],o=e[6],u=e[7],c=e[8],h=e[9],f=e[10],l=e[11],d=e[12],m=e[13],p=e[14],g=e[15];return(t*i-r*a)*(f*g-l*p)-(t*o-n*a)*(h*g-l*m)+(t*u-s*a)*(h*p-f*m)+(r*o-n*i)*(c*g-l*d)-(r*u-s*i)*(c*p-f*d)+(n*u-s*o)*(c*m-h*d)}function se(e,t,r){var n=t[0],s=t[1],a=t[2],i=t[3],o=t[4],u=t[5],c=t[6],h=t[7],f=t[8],l=t[9],d=t[10],m=t[11],p=t[12],g=t[13],x=t[14],b=t[15],y=r[0],v=r[1],M=r[2],w=r[3];return e[0]=y*n+v*o+M*f+w*p,e[1]=y*s+v*u+M*l+w*g,e[2]=y*a+v*c+M*d+w*x,e[3]=y*i+v*h+M*m+w*b,y=r[4],v=r[5],M=r[6],w=r[7],e[4]=y*n+v*o+M*f+w*p,e[5]=y*s+v*u+M*l+w*g,e[6]=y*a+v*c+M*d+w*x,e[7]=y*i+v*h+M*m+w*b,y=r[8],v=r[9],M=r[10],w=r[11],e[8]=y*n+v*o+M*f+w*p,e[9]=y*s+v*u+M*l+w*g,e[10]=y*a+v*c+M*d+w*x,e[11]=y*i+v*h+M*m+w*b,y=r[12],v=r[13],M=r[14],w=r[15],e[12]=y*n+v*o+M*f+w*p,e[13]=y*s+v*u+M*l+w*g,e[14]=y*a+v*c+M*d+w*x,e[15]=y*i+v*h+M*m+w*b,e}function ae(e,t,r){var n,s,a,i,o,u,c,h,f,l,d,m,p=r[0],g=r[1],x=r[2];return t===e?(e[12]=t[0]*p+t[4]*g+t[8]*x+t[12],e[13]=t[1]*p+t[5]*g+t[9]*x+t[13],e[14]=t[2]*p+t[6]*g+t[10]*x+t[14],e[15]=t[3]*p+t[7]*g+t[11]*x+t[15]):(n=t[0],s=t[1],a=t[2],i=t[3],o=t[4],u=t[5],c=t[6],h=t[7],f=t[8],l=t[9],d=t[10],m=t[11],e[0]=n,e[1]=s,e[2]=a,e[3]=i,e[4]=o,e[5]=u,e[6]=c,e[7]=h,e[8]=f,e[9]=l,e[10]=d,e[11]=m,e[12]=n*p+o*g+f*x+t[12],e[13]=s*p+u*g+l*x+t[13],e[14]=a*p+c*g+d*x+t[14],e[15]=i*p+h*g+m*x+t[15]),e}function ie(e,t,r){var n=r[0],s=r[1],a=r[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*a,e[9]=t[9]*a,e[10]=t[10]*a,e[11]=t[11]*a,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function oe(e,t,r,n){var s,a,i,o,u,c,h,f,l,d,m,p,g,x,b,y,v,M,w,_,T,U,S,E,F=n[0],A=n[1],L=n[2],D=Math.hypot(F,A,L);return D<1e-6?null:(F*=D=1/D,A*=D,L*=D,s=Math.sin(r),i=1-(a=Math.cos(r)),o=t[0],u=t[1],c=t[2],h=t[3],f=t[4],l=t[5],d=t[6],m=t[7],p=t[8],g=t[9],x=t[10],b=t[11],y=F*F*i+a,v=A*F*i+L*s,M=L*F*i-A*s,w=F*A*i-L*s,_=A*A*i+a,T=L*A*i+F*s,U=F*L*i+A*s,S=A*L*i-F*s,E=L*L*i+a,e[0]=o*y+f*v+p*M,e[1]=u*y+l*v+g*M,e[2]=c*y+d*v+x*M,e[3]=h*y+m*v+b*M,e[4]=o*w+f*_+p*T,e[5]=u*w+l*_+g*T,e[6]=c*w+d*_+x*T,e[7]=h*w+m*_+b*T,e[8]=o*U+f*S+p*E,e[9]=u*U+l*S+g*E,e[10]=c*U+d*S+x*E,e[11]=h*U+m*S+b*E,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}function ue(e,t,r){var n=Math.sin(r),s=Math.cos(r),a=t[4],i=t[5],o=t[6],u=t[7],c=t[8],h=t[9],f=t[10],l=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=a*s+c*n,e[5]=i*s+h*n,e[6]=o*s+f*n,e[7]=u*s+l*n,e[8]=c*s-a*n,e[9]=h*s-i*n,e[10]=f*s-o*n,e[11]=l*s-u*n,e}function ce(e,t,r){var n=Math.sin(r),s=Math.cos(r),a=t[0],i=t[1],o=t[2],u=t[3],c=t[8],h=t[9],f=t[10],l=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=a*s-c*n,e[1]=i*s-h*n,e[2]=o*s-f*n,e[3]=u*s-l*n,e[8]=a*n+c*s,e[9]=i*n+h*s,e[10]=o*n+f*s,e[11]=u*n+l*s,e}function he(e,t,r){var n=Math.sin(r),s=Math.cos(r),a=t[0],i=t[1],o=t[2],u=t[3],c=t[4],h=t[5],f=t[6],l=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=a*s+c*n,e[1]=i*s+h*n,e[2]=o*s+f*n,e[3]=u*s+l*n,e[4]=c*s-a*n,e[5]=h*s-i*n,e[6]=f*s-o*n,e[7]=l*s-u*n,e}function fe(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function le(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function de(e,t,r){var n,s,a,i=r[0],o=r[1],u=r[2],c=Math.hypot(i,o,u);return c<1e-6?null:(i*=c=1/c,o*=c,u*=c,n=Math.sin(t),a=1-(s=Math.cos(t)),e[0]=i*i*a+s,e[1]=o*i*a+u*n,e[2]=u*i*a-o*n,e[3]=0,e[4]=i*o*a-u*n,e[5]=o*o*a+s,e[6]=u*o*a+i*n,e[7]=0,e[8]=i*u*a+o*n,e[9]=o*u*a-i*n,e[10]=u*u*a+s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function me(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=r,e[7]=0,e[8]=0,e[9]=-r,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function pe(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=0,e[2]=-r,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=r,e[9]=0,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function ge(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=r,e[2]=0,e[3]=0,e[4]=-r,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function xe(e,t,r){var n=t[0],s=t[1],a=t[2],i=t[3],o=n+n,u=s+s,c=a+a,h=n*o,f=n*u,l=n*c,d=s*u,m=s*c,p=a*c,g=i*o,x=i*u,b=i*c;return e[0]=1-(d+p),e[1]=f+b,e[2]=l-x,e[3]=0,e[4]=f-b,e[5]=1-(h+p),e[6]=m+g,e[7]=0,e[8]=l+x,e[9]=m-g,e[10]=1-(h+d),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function be(e,t){var r=new X(3),n=-t[0],s=-t[1],a=-t[2],i=t[3],o=t[4],u=t[5],c=t[6],h=t[7],f=n*n+s*s+a*a+i*i;return f>0?(r[0]=2*(o*i+h*n+u*a-c*s)/f,r[1]=2*(u*i+h*s+c*n-o*a)/f,r[2]=2*(c*i+h*a+o*s-u*n)/f):(r[0]=2*(o*i+h*n+u*a-c*s),r[1]=2*(u*i+h*s+c*n-o*a),r[2]=2*(c*i+h*a+o*s-u*n)),xe(e,t,r),e}function ye(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function ve(e,t){var r=t[0],n=t[1],s=t[2],a=t[4],i=t[5],o=t[6],u=t[8],c=t[9],h=t[10];return e[0]=Math.hypot(r,n,s),e[1]=Math.hypot(a,i,o),e[2]=Math.hypot(u,c,h),e}function Me(e,t){var r=new X(3);ve(r,t);var n=1/r[0],s=1/r[1],a=1/r[2],i=t[0]*n,o=t[1]*s,u=t[2]*a,c=t[4]*n,h=t[5]*s,f=t[6]*a,l=t[8]*n,d=t[9]*s,m=t[10]*a,p=i+h+m,g=0;return p>0?(g=2*Math.sqrt(p+1),e[3]=.25*g,e[0]=(f-d)/g,e[1]=(l-u)/g,e[2]=(o-c)/g):i>h&&i>m?(g=2*Math.sqrt(1+i-h-m),e[3]=(f-d)/g,e[0]=.25*g,e[1]=(o+c)/g,e[2]=(l+u)/g):h>m?(g=2*Math.sqrt(1+h-i-m),e[3]=(l-u)/g,e[0]=(o+c)/g,e[1]=.25*g,e[2]=(f+d)/g):(g=2*Math.sqrt(1+m-i-h),e[3]=(o-c)/g,e[0]=(l+u)/g,e[1]=(f+d)/g,e[2]=.25*g),e}function we(e,t,r,n){var s=t[0],a=t[1],i=t[2],o=t[3],u=s+s,c=a+a,h=i+i,f=s*u,l=s*c,d=s*h,m=a*c,p=a*h,g=i*h,x=o*u,b=o*c,y=o*h,v=n[0],M=n[1],w=n[2];return e[0]=(1-(m+g))*v,e[1]=(l+y)*v,e[2]=(d-b)*v,e[3]=0,e[4]=(l-y)*M,e[5]=(1-(f+g))*M,e[6]=(p+x)*M,e[7]=0,e[8]=(d+b)*w,e[9]=(p-x)*w,e[10]=(1-(f+m))*w,e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function _e(e,t,r,n,s){var a=t[0],i=t[1],o=t[2],u=t[3],c=a+a,h=i+i,f=o+o,l=a*c,d=a*h,m=a*f,p=i*h,g=i*f,x=o*f,b=u*c,y=u*h,v=u*f,M=n[0],w=n[1],_=n[2],T=s[0],U=s[1],S=s[2],E=(1-(p+x))*M,F=(d+v)*M,A=(m-y)*M,L=(d-v)*w,D=(1-(l+x))*w,I=(g+b)*w,B=(m+y)*_,N=(g-b)*_,R=(1-(l+p))*_;return e[0]=E,e[1]=F,e[2]=A,e[3]=0,e[4]=L,e[5]=D,e[6]=I,e[7]=0,e[8]=B,e[9]=N,e[10]=R,e[11]=0,e[12]=r[0]+T-(E*T+L*U+B*S),e[13]=r[1]+U-(F*T+D*U+N*S),e[14]=r[2]+S-(A*T+I*U+R*S),e[15]=1,e}function Te(e,t){var r=t[0],n=t[1],s=t[2],a=t[3],i=r+r,o=n+n,u=s+s,c=r*i,h=n*i,f=n*o,l=s*i,d=s*o,m=s*u,p=a*i,g=a*o,x=a*u;return e[0]=1-f-m,e[1]=h+x,e[2]=l-g,e[3]=0,e[4]=h-x,e[5]=1-c-m,e[6]=d+p,e[7]=0,e[8]=l+g,e[9]=d-p,e[10]=1-c-f,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Ue(e,t,r,n,s,a,i){var o=1/(r-t),u=1/(s-n),c=1/(a-i);return e[0]=2*a*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*a*u,e[6]=0,e[7]=0,e[8]=(r+t)*o,e[9]=(s+n)*u,e[10]=(i+a)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=i*a*2*c,e[15]=0,e}function Se(e,t,r,n,s){var a,i=1/Math.tan(t/2);return e[0]=i/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0?(a=1/(n-s),e[10]=(s+n)*a,e[14]=2*s*n*a):(e[10]=-1,e[14]=-2*n),e}function Ee(e,t,r,n){var s=Math.tan(t.upDegrees*Math.PI/180),a=Math.tan(t.downDegrees*Math.PI/180),i=Math.tan(t.leftDegrees*Math.PI/180),o=Math.tan(t.rightDegrees*Math.PI/180),u=2/(i+o),c=2/(s+a);return e[0]=u,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=-(i-o)*u*.5,e[9]=(s-a)*c*.5,e[10]=n/(r-n),e[11]=-1,e[12]=0,e[13]=0,e[14]=n*r/(r-n),e[15]=0,e}function Fe(e,t,r,n,s,a,i){var o=1/(t-r),u=1/(n-s),c=1/(a-i);return e[0]=-2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*u,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+r)*o,e[13]=(s+n)*u,e[14]=(i+a)*c,e[15]=1,e}function Ae(e,t,r,n){var s,a,i,o,u,c,h,f,l,d,m=t[0],p=t[1],g=t[2],x=n[0],b=n[1],y=n[2],v=r[0],M=r[1],w=r[2];return Math.abs(m-v)<1e-6&&Math.abs(p-M)<1e-6&&Math.abs(g-w)<1e-6?Q(e):(h=m-v,f=p-M,l=g-w,s=b*(l*=d=1/Math.hypot(h,f,l))-y*(f*=d),a=y*(h*=d)-x*l,i=x*f-b*h,(d=Math.hypot(s,a,i))?(s*=d=1/d,a*=d,i*=d):(s=0,a=0,i=0),o=f*i-l*a,u=l*s-h*i,c=h*a-f*s,(d=Math.hypot(o,u,c))?(o*=d=1/d,u*=d,c*=d):(o=0,u=0,c=0),e[0]=s,e[1]=o,e[2]=h,e[3]=0,e[4]=a,e[5]=u,e[6]=f,e[7]=0,e[8]=i,e[9]=c,e[10]=l,e[11]=0,e[12]=-(s*m+a*p+i*g),e[13]=-(o*m+u*p+c*g),e[14]=-(h*m+f*p+l*g),e[15]=1,e)}function Le(e,t,r,n){var s=t[0],a=t[1],i=t[2],o=n[0],u=n[1],c=n[2],h=s-r[0],f=a-r[1],l=i-r[2],d=h*h+f*f+l*l;d>0&&(h*=d=1/Math.sqrt(d),f*=d,l*=d);var m=u*l-c*f,p=c*h-o*l,g=o*f-u*h;return(d=m*m+p*p+g*g)>0&&(m*=d=1/Math.sqrt(d),p*=d,g*=d),e[0]=m,e[1]=p,e[2]=g,e[3]=0,e[4]=f*g-l*p,e[5]=l*m-h*g,e[6]=h*p-f*m,e[7]=0,e[8]=h,e[9]=f,e[10]=l,e[11]=0,e[12]=s,e[13]=a,e[14]=i,e[15]=1,e}function De(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"}function Ie(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function Be(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e[9]=t[9]+r[9],e[10]=t[10]+r[10],e[11]=t[11]+r[11],e[12]=t[12]+r[12],e[13]=t[13]+r[13],e[14]=t[14]+r[14],e[15]=t[15]+r[15],e}function Ne(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e[9]=t[9]-r[9],e[10]=t[10]-r[10],e[11]=t[11]-r[11],e[12]=t[12]-r[12],e[13]=t[13]-r[13],e[14]=t[14]-r[14],e[15]=t[15]-r[15],e}function Re(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12]*r,e[13]=t[13]*r,e[14]=t[14]*r,e[15]=t[15]*r,e}function Oe(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e[3]=t[3]+r[3]*n,e[4]=t[4]+r[4]*n,e[5]=t[5]+r[5]*n,e[6]=t[6]+r[6]*n,e[7]=t[7]+r[7]*n,e[8]=t[8]+r[8]*n,e[9]=t[9]+r[9]*n,e[10]=t[10]+r[10]*n,e[11]=t[11]+r[11]*n,e[12]=t[12]+r[12]*n,e[13]=t[13]+r[13]*n,e[14]=t[14]+r[14]*n,e[15]=t[15]+r[15]*n,e}function Pe(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]}function Ve(e,t){var r=e[0],n=e[1],s=e[2],a=e[3],i=e[4],o=e[5],u=e[6],c=e[7],h=e[8],f=e[9],l=e[10],d=e[11],m=e[12],p=e[13],g=e[14],x=e[15],b=t[0],y=t[1],v=t[2],M=t[3],w=t[4],_=t[5],T=t[6],U=t[7],S=t[8],E=t[9],F=t[10],A=t[11],L=t[12],D=t[13],I=t[14],B=t[15];return Math.abs(r-b)<=1e-6*Math.max(1,Math.abs(r),Math.abs(b))&&Math.abs(n-y)<=1e-6*Math.max(1,Math.abs(n),Math.abs(y))&&Math.abs(s-v)<=1e-6*Math.max(1,Math.abs(s),Math.abs(v))&&Math.abs(a-M)<=1e-6*Math.max(1,Math.abs(a),Math.abs(M))&&Math.abs(i-w)<=1e-6*Math.max(1,Math.abs(i),Math.abs(w))&&Math.abs(o-_)<=1e-6*Math.max(1,Math.abs(o),Math.abs(_))&&Math.abs(u-T)<=1e-6*Math.max(1,Math.abs(u),Math.abs(T))&&Math.abs(c-U)<=1e-6*Math.max(1,Math.abs(c),Math.abs(U))&&Math.abs(h-S)<=1e-6*Math.max(1,Math.abs(h),Math.abs(S))&&Math.abs(f-E)<=1e-6*Math.max(1,Math.abs(f),Math.abs(E))&&Math.abs(l-F)<=1e-6*Math.max(1,Math.abs(l),Math.abs(F))&&Math.abs(d-A)<=1e-6*Math.max(1,Math.abs(d),Math.abs(A))&&Math.abs(m-L)<=1e-6*Math.max(1,Math.abs(m),Math.abs(L))&&Math.abs(p-D)<=1e-6*Math.max(1,Math.abs(p),Math.abs(D))&&Math.abs(g-I)<=1e-6*Math.max(1,Math.abs(g),Math.abs(I))&&Math.abs(x-B)<=1e-6*Math.max(1,Math.abs(x),Math.abs(B))}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var Ce=se,ke=Ne;function Ge(){var e=new X(3);return X!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function je(e){var t=new X(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function qe(e){var t=e[0],r=e[1],n=e[2];return Math.hypot(t,r,n)}function ze(e,t,r){var n=new X(3);return n[0]=e,n[1]=t,n[2]=r,n}function He(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function Xe(e,t,r,n){return e[0]=t,e[1]=r,e[2]=n,e}function $e(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function We(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function Ye(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}function Ke(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e}function Je(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function Ze(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}function Qe(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e}function et(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e}function tt(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e}function rt(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function nt(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e}function st(e,t){var r=t[0]-e[0],n=t[1]-e[1],s=t[2]-e[2];return Math.hypot(r,n,s)}function at(e,t){var r=t[0]-e[0],n=t[1]-e[1],s=t[2]-e[2];return r*r+n*n+s*s}function it(e){var t=e[0],r=e[1],n=e[2];return t*t+r*r+n*n}function ot(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function ut(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}function ct(e,t){var r=t[0],n=t[1],s=t[2],a=r*r+n*n+s*s;return a>0&&(a=1/Math.sqrt(a)),e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a,e}function ht(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function ft(e,t,r){var n=t[0],s=t[1],a=t[2],i=r[0],o=r[1],u=r[2];return e[0]=s*u-a*o,e[1]=a*i-n*u,e[2]=n*o-s*i,e}function lt(e,t,r,n){var s=t[0],a=t[1],i=t[2];return e[0]=s+n*(r[0]-s),e[1]=a+n*(r[1]-a),e[2]=i+n*(r[2]-i),e}function dt(e,t,r,n,s,a){var i=a*a,o=i*(2*a-3)+1,u=i*(a-2)+a,c=i*(a-1),h=i*(3-2*a);return e[0]=t[0]*o+r[0]*u+n[0]*c+s[0]*h,e[1]=t[1]*o+r[1]*u+n[1]*c+s[1]*h,e[2]=t[2]*o+r[2]*u+n[2]*c+s[2]*h,e}function mt(e,t,r,n,s,a){var i=1-a,o=i*i,u=a*a,c=o*i,h=3*a*o,f=3*u*i,l=u*a;return e[0]=t[0]*c+r[0]*h+n[0]*f+s[0]*l,e[1]=t[1]*c+r[1]*h+n[1]*f+s[1]*l,e[2]=t[2]*c+r[2]*h+n[2]*f+s[2]*l,e}function pt(e,t){t=t||1;var r=2*$()*Math.PI,n=2*$()-1,s=Math.sqrt(1-n*n)*t;return e[0]=Math.cos(r)*s,e[1]=Math.sin(r)*s,e[2]=n*t,e}function gt(e,t,r){var n=t[0],s=t[1],a=t[2],i=r[3]*n+r[7]*s+r[11]*a+r[15];return i=i||1,e[0]=(r[0]*n+r[4]*s+r[8]*a+r[12])/i,e[1]=(r[1]*n+r[5]*s+r[9]*a+r[13])/i,e[2]=(r[2]*n+r[6]*s+r[10]*a+r[14])/i,e}function xt(e,t,r){var n=t[0],s=t[1],a=t[2];return e[0]=n*r[0]+s*r[3]+a*r[6],e[1]=n*r[1]+s*r[4]+a*r[7],e[2]=n*r[2]+s*r[5]+a*r[8],e}function bt(e,t,r){var n=r[0],s=r[1],a=r[2],i=r[3],o=t[0],u=t[1],c=t[2],h=s*c-a*u,f=a*o-n*c,l=n*u-s*o,d=s*l-a*f,m=a*h-n*l,p=n*f-s*h,g=2*i;return h*=g,f*=g,l*=g,d*=2,m*=2,p*=2,e[0]=o+h+d,e[1]=u+f+m,e[2]=c+l+p,e}function yt(e,t,r,n){var s=[],a=[];return s[0]=t[0]-r[0],s[1]=t[1]-r[1],s[2]=t[2]-r[2],a[0]=s[0],a[1]=s[1]*Math.cos(n)-s[2]*Math.sin(n),a[2]=s[1]*Math.sin(n)+s[2]*Math.cos(n),e[0]=a[0]+r[0],e[1]=a[1]+r[1],e[2]=a[2]+r[2],e}function vt(e,t,r,n){var s=[],a=[];return s[0]=t[0]-r[0],s[1]=t[1]-r[1],s[2]=t[2]-r[2],a[0]=s[2]*Math.sin(n)+s[0]*Math.cos(n),a[1]=s[1],a[2]=s[2]*Math.cos(n)-s[0]*Math.sin(n),e[0]=a[0]+r[0],e[1]=a[1]+r[1],e[2]=a[2]+r[2],e}function Mt(e,t,r,n){var s=[],a=[];return s[0]=t[0]-r[0],s[1]=t[1]-r[1],s[2]=t[2]-r[2],a[0]=s[0]*Math.cos(n)-s[1]*Math.sin(n),a[1]=s[0]*Math.sin(n)+s[1]*Math.cos(n),a[2]=s[2],e[0]=a[0]+r[0],e[1]=a[1]+r[1],e[2]=a[2]+r[2],e}function wt(e,t){var r=e[0],n=e[1],s=e[2],a=t[0],i=t[1],o=t[2],u=Math.sqrt(r*r+n*n+s*s)*Math.sqrt(a*a+i*i+o*o),c=u&&ht(e,t)/u;return Math.acos(Math.min(Math.max(c,-1),1))}function _t(e){return e[0]=0,e[1]=0,e[2]=0,e}function Tt(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"}function Ut(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function St(e,t){var r=e[0],n=e[1],s=e[2],a=t[0],i=t[1],o=t[2];return Math.abs(r-a)<=1e-6*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(n-i)<=1e-6*Math.max(1,Math.abs(n),Math.abs(i))&&Math.abs(s-o)<=1e-6*Math.max(1,Math.abs(s),Math.abs(o))}var Et,Ft=We,At=Ye,Lt=Ke,Dt=st,It=at,Bt=qe,Nt=it,Rt=(Et=Ge(),function(e,t,r,n,s,a){var i,o;for(t||(t=3),r||(r=0),o=n?Math.min(n*t+r,e.length):e.length,i=r;i<o;i+=t)Et[0]=e[i],Et[1]=e[i+1],Et[2]=e[i+2],s(Et,Et,a),e[i]=Et[0],e[i+1]=Et[1],e[i+2]=Et[2];return e});function Ot(e){var t=e[0],r=e[1],n=e[2],s=e[3];return Math.hypot(t,r,n,s)}function Pt(e){var t=e[0],r=e[1],n=e[2],s=e[3];return t*t+r*r+n*n+s*s}!function(){var e,t=(e=new X(4),X!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();function Vt(){var e=new X(4);return X!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function Ct(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function kt(e,t,r){r*=.5;var n=Math.sin(r);return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=Math.cos(r),e}function Gt(e,t){var r=2*Math.acos(t[3]),n=Math.sin(r/2);return n>1e-6?(e[0]=t[0]/n,e[1]=t[1]/n,e[2]=t[2]/n):(e[0]=1,e[1]=0,e[2]=0),r}function jt(e,t){var r=br(e,t);return Math.acos(2*r*r-1)}function qt(e,t,r){var n=t[0],s=t[1],a=t[2],i=t[3],o=r[0],u=r[1],c=r[2],h=r[3];return e[0]=n*h+i*o+s*c-a*u,e[1]=s*h+i*u+a*o-n*c,e[2]=a*h+i*c+n*u-s*o,e[3]=i*h-n*o-s*u-a*c,e}function zt(e,t,r){r*=.5;var n=t[0],s=t[1],a=t[2],i=t[3],o=Math.sin(r),u=Math.cos(r);return e[0]=n*u+i*o,e[1]=s*u+a*o,e[2]=a*u-s*o,e[3]=i*u-n*o,e}function Ht(e,t,r){r*=.5;var n=t[0],s=t[1],a=t[2],i=t[3],o=Math.sin(r),u=Math.cos(r);return e[0]=n*u-a*o,e[1]=s*u+i*o,e[2]=a*u+n*o,e[3]=i*u-s*o,e}function Xt(e,t,r){r*=.5;var n=t[0],s=t[1],a=t[2],i=t[3],o=Math.sin(r),u=Math.cos(r);return e[0]=n*u+s*o,e[1]=s*u-n*o,e[2]=a*u+i*o,e[3]=i*u-a*o,e}function $t(e,t){var r=t[0],n=t[1],s=t[2];return e[0]=r,e[1]=n,e[2]=s,e[3]=Math.sqrt(Math.abs(1-r*r-n*n-s*s)),e}function Wt(e,t){var r=t[0],n=t[1],s=t[2],a=t[3],i=Math.sqrt(r*r+n*n+s*s),o=Math.exp(a),u=i>0?o*Math.sin(i)/i:0;return e[0]=r*u,e[1]=n*u,e[2]=s*u,e[3]=o*Math.cos(i),e}function Yt(e,t){var r=t[0],n=t[1],s=t[2],a=t[3],i=Math.sqrt(r*r+n*n+s*s),o=i>0?Math.atan2(i,a)/i:0;return e[0]=r*o,e[1]=n*o,e[2]=s*o,e[3]=.5*Math.log(r*r+n*n+s*s+a*a),e}function Kt(e,t,r){return Yt(e,t),xr(e,e,r),Wt(e,e),e}function Jt(e,t,r,n){var s,a,i,o,u,c=t[0],h=t[1],f=t[2],l=t[3],d=r[0],m=r[1],p=r[2],g=r[3];return(a=c*d+h*m+f*p+l*g)<0&&(a=-a,d=-d,m=-m,p=-p,g=-g),1-a>1e-6?(s=Math.acos(a),i=Math.sin(s),o=Math.sin((1-n)*s)/i,u=Math.sin(n*s)/i):(o=1-n,u=n),e[0]=o*c+u*d,e[1]=o*h+u*m,e[2]=o*f+u*p,e[3]=o*l+u*g,e}function Zt(e){var t=$(),r=$(),n=$(),s=Math.sqrt(1-t),a=Math.sqrt(t);return e[0]=s*Math.sin(2*Math.PI*r),e[1]=s*Math.cos(2*Math.PI*r),e[2]=a*Math.sin(2*Math.PI*n),e[3]=a*Math.cos(2*Math.PI*n),e}function Qt(e,t){var r=t[0],n=t[1],s=t[2],a=t[3],i=r*r+n*n+s*s+a*a,o=i?1/i:0;return e[0]=-r*o,e[1]=-n*o,e[2]=-s*o,e[3]=a*o,e}function er(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e}function tr(e,t){var r,n=t[0]+t[4]+t[8];if(n>0)r=Math.sqrt(n+1),e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r;else{var s=0;t[4]>t[0]&&(s=1),t[8]>t[3*s+s]&&(s=2);var a=(s+1)%3,i=(s+2)%3;r=Math.sqrt(t[3*s+s]-t[3*a+a]-t[3*i+i]+1),e[s]=.5*r,r=.5/r,e[3]=(t[3*a+i]-t[3*i+a])*r,e[a]=(t[3*a+s]+t[3*s+a])*r,e[i]=(t[3*i+s]+t[3*s+i])*r}return e}function rr(e,t,r,n){var s=.5*Math.PI/180;t*=s,r*=s,n*=s;var a=Math.sin(t),i=Math.cos(t),o=Math.sin(r),u=Math.cos(r),c=Math.sin(n),h=Math.cos(n);return e[0]=a*u*h-i*o*c,e[1]=i*o*h+a*u*c,e[2]=i*u*c-a*o*h,e[3]=i*u*h+a*o*c,e}function nr(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}var sr,ar,ir,or,ur,cr,hr,fr=function(e){var t=new X(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},lr=function(e,t,r,n){var s=new X(4);return s[0]=e,s[1]=t,s[2]=r,s[3]=n,s},dr=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},mr=function(e,t,r,n,s){return e[0]=t,e[1]=r,e[2]=n,e[3]=s,e},pr=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e},gr=qt,xr=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e},br=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},yr=function(e,t,r,n){var s=t[0],a=t[1],i=t[2],o=t[3];return e[0]=s+n*(r[0]-s),e[1]=a+n*(r[1]-a),e[2]=i+n*(r[2]-i),e[3]=o+n*(r[3]-o),e},vr=Ot,Mr=vr,wr=Pt,_r=wr,Tr=function(e,t){var r=t[0],n=t[1],s=t[2],a=t[3],i=r*r+n*n+s*s+a*a;return i>0&&(i=1/Math.sqrt(i)),e[0]=r*i,e[1]=n*i,e[2]=s*i,e[3]=a*i,e},Ur=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},Sr=function(e,t){var r=e[0],n=e[1],s=e[2],a=e[3],i=t[0],o=t[1],u=t[2],c=t[3];return Math.abs(r-i)<=1e-6*Math.max(1,Math.abs(r),Math.abs(i))&&Math.abs(n-o)<=1e-6*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(s-u)<=1e-6*Math.max(1,Math.abs(s),Math.abs(u))&&Math.abs(a-c)<=1e-6*Math.max(1,Math.abs(a),Math.abs(c))},Er=(sr=Ge(),ar=ze(1,0,0),ir=ze(0,1,0),function(e,t,r){var n=ht(t,r);return n<-.999999?(ft(sr,ar,t),Bt(sr)<1e-6&&ft(sr,ir,t),ct(sr,sr),kt(e,sr,Math.PI),e):n>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(ft(sr,t,r),e[0]=sr[0],e[1]=sr[1],e[2]=sr[2],e[3]=1+n,Tr(e,e))}),Fr=(or=Vt(),ur=Vt(),function(e,t,r,n,s,a){return Jt(or,t,s,a),Jt(ur,r,n,a),Jt(e,or,ur,2*a*(1-a)),e}),Ar=(cr=new X(9),X!=Float32Array&&(cr[1]=0,cr[2]=0,cr[3]=0,cr[5]=0,cr[6]=0,cr[7]=0),cr[0]=1,cr[4]=1,cr[8]=1,hr=cr,function(e,t,r,n){return hr[0]=r[0],hr[3]=r[1],hr[6]=r[2],hr[1]=n[0],hr[4]=n[1],hr[7]=n[2],hr[2]=-t[0],hr[5]=-t[1],hr[8]=-t[2],Tr(e,tr(e,hr))});function Lr(e,t=""){if(!e){const e=new Error(`Assert fail: ${t}`);throw console.error(e.stack),e}}function Dr(e,t){if(null!=e)return e;throw new Error(Br(t,"Missing object"))}function Ir(e){return null!=e}function Br(e,t){return null!=e?e:t}class Nr{constructor(e,t,r,a){this.cameraMatrix=n.create(),this.viewMatrix=n.create(),this.projectionMatrix=n.create(),this.projectionMatrixInverse=n.create(),this.viewProjMatrix=n.create(),this.viewProjMatrixInverse=n.create(),this.forward=s.create(),this.up=s.create(),this.right=s.create(),e=Br(e,60/180*Math.PI),r=Br(r,1),a=Br(a,2e3),t=Br(t,1),this.setPerspective(e,t,r,a)}copy(e){this.fov=e.fov,this.near=e.near,this.far=e.far,this.aspect=e.aspect,n.copy(this.cameraMatrix,e.cameraMatrix),n.copy(this.viewMatrix,e.viewMatrix),n.copy(this.projectionMatrix,e.projectionMatrix),n.copy(this.projectionMatrixInverse,e.projectionMatrixInverse),n.copy(this.viewProjMatrix,e.viewProjMatrix),n.copy(this.viewProjMatrixInverse,e.viewProjMatrixInverse),s.copy(this.forward,e.forward),s.copy(this.up,e.up),s.copy(this.right,e.right)}getPos(e){return n.getTranslation(e,this.cameraMatrix)}viewMatrixUpdated(){n.invert(this.cameraMatrix,this.viewMatrix),s.set(this.right,this.cameraMatrix[0],this.cameraMatrix[1],this.cameraMatrix[2]),s.set(this.up,this.cameraMatrix[4],this.cameraMatrix[5],this.cameraMatrix[6]),s.set(this.forward,-this.cameraMatrix[8],-this.cameraMatrix[9],-this.cameraMatrix[10]),n.multiply(this.viewProjMatrix,this.projectionMatrix,this.viewMatrix),n.multiply(this.viewProjMatrixInverse,this.cameraMatrix,this.projectionMatrixInverse)}setPerspective(e,t,r,s=1/0){this.fov=e,this.aspect=t,this.near=r,this.far=s,n.perspective(this.projectionMatrix,e,t,r,s),n.invert(this.projectionMatrixInverse,this.projectionMatrix),n.multiply(this.viewProjMatrix,this.projectionMatrix,this.viewMatrix),n.multiply(this.viewProjMatrixInverse,this.cameraMatrix,this.projectionMatrixInverse)}}class Rr{constructor(){this._add=[],this._folders={}}add(e,t,r,n,s){this._add.push(arguments)}addFolder(e){return this._folders[e]=new Rr,this._folders[e]}async show(){var e;if(void 0===this._gui){const e=await r.e(2).then(r.bind(null,10));this._gui=new e.GUI({load:this._saveObject})}(null===(e=this._saveObject)||void 0===e?void 0:e.closed)&&this._gui.close();for(const e of this._add)this._gui.getRoot().remember(e[0]),this._gui.add.apply(this._gui,e);for(const e in this._folders)this._folders[e]._gui=this._gui.addFolder(e),this._folders[e].show();this.add=this._gui.add.bind(this._gui),this.addFolder=this._gui.addFolder.bind(this._gui),this.show=this._gui.show.bind(this._gui),this.hide=this._gui.hide.bind(this._gui)}hide(){}update(){if(this._gui&&!this._gui.closed)for(var e in this._gui.__controllers)this._gui.__controllers[e].updateDisplay()}toJSON(){return this._gui?this._gui.getSaveObject():void 0}fromJSON(e){Lr(!Ir(this._gui),"State must be loaded before the DebugMenu is shown"),this._saveObject=e}}window.onkeyup=e=>{"KeyT"===e.code&&Or.show()};let Or=new Rr;class Pr{constructor(){this.matrixWorldDirty=!0,this.matrixDirty=!0,this.name="",this.position=s.create(),this.rotation=a.create(),this.scale=s.create(),this.matrix=n.create(),this.matrixWorld=n.create(),this.parent=null,this.children=[]}updateMatrix(){n.fromRotationTranslationScale(this.matrix,this.rotation,this.position,this.scale),this.matrixWorldDirty=!0}updateMatrixWorld(e,t){const r=this.parent;if(!0===e&&Ir(r)&&r.updateMatrixWorld(!0,!1),Ir(this.parent)?n.multiply(this.matrixWorld,this.parent.matrixWorld,this.matrix):n.copy(this.matrixWorld,this.matrix),!0===t){const e=this.children;for(let t=0,r=e.length;t<r;t++)e[t].updateMatrixWorld(!1,!0)}}add(e,...t){Dr(e),Lr(e!==this,"Object can't be added as a child of itself"),null!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e);for(let e=0;e<t.length;e++)this.add(t[e]);return this}remove(e,...t){const r=this.children.indexOf(e);return-1!==r&&(e.parent=null,this.children.splice(r,1)),this}clone(e){return(new this.constructor).copy(this,e)}copy(e,t=!0){if(this.name=e.name,s.copy(this.position,e.position),a.copy(this.rotation,e.rotation),s.copy(this.scale,e.scale),this.matrix=n.copy(this.matrix,e.matrix),this.matrixWorld=n.copy(this.matrixWorld,e.matrixWorld),!0===t)for(var r=0;r<e.children.length;r++){const t=e.children[r];this.add(t.clone())}return this}}function Vr(e){return e.buffer?e:{buffer:e}}class Cr{constructor(e){this.vertexLayout=e.vertexLayout,this.vertexBuffers=e.vertexBuffers.map(e=>Vr(e)),this.elementCount=e.elementCount,this.primitiveType=Br(e.primitiveType,m.Triangles),Lr(e.vertexBuffers.length===e.vertexLayout.buffers.length),e.indexBuffer&&(this.indexBuffer=Vr(e.indexBuffer),this.indexType=Br(e.indexType,c.Ushort))}}class kr{constructor(e,t,r,n){this.shader=r,this.name=t,this.layout=n,this.resources=e.createResourceTable(this.layout)}setUniformBuffer(e,t,r){const n=Dr(this.layout[t],"Invalid resource name");Lr(n.type===g.UniformBuffer,"Mismatching resource type"),e.setBuffer(this.resources,n.index,Vr(r))}setTexture(e,t,r){const n=Dr(this.layout[t],"Invalid resource name");Lr(n.type===g.Texture,"Mismatching resource type"),Lr(!Ir(n.count),"Use Material.setTextureArray"),e.setTexture(this.resources,n.index,r)}setTextureArray(e,t,r){const n=Dr(this.layout[t],"Invalid resource name");Lr(n.type===g.Texture,"Mismatching resource type"),Lr(Ir(n.count),"Use Material.setTextureArray"),e.setTextures(this.resources,n.index,r)}}class Gr extends Pr{constructor(e,t,r,n){super(),this.renderList=t,this.mesh=r,this.material=n,this.pipeline=e.createRenderPipeline(n.shader,t.renderFormat,r.vertexLayout,n.layout),this.vertexTable=e.createVertexTable(this.pipeline),r.vertexBuffers.forEach((t,r)=>{e.setVertexBuffer(this.vertexTable,r,t)}),this.primitive={renderPipeline:this.pipeline,resourceTable:this.material.resources,vertexTable:this.vertexTable,elementCount:this.mesh.elementCount,type:this.mesh.primitiveType,indexBuffer:this.mesh.indexBuffer,indexType:this.mesh.indexType}}}const jr={opaque:new class{constructor(e,t,r){this.defaultCullMode=e,this.defaultDepthState=t,this.renderFormat=r,this.primitives=[]}push(e){this.primitives.push(e)}}(b.Back,{depthWriteEnabled:!0,depthTestEnabled:!0},{blendingEnabled:!1})};function qr(e){const t={};let r=0;const n=Object.keys(e);for(let s=0;s<n.length;s++){const a=e[n[s]];t[n[s]]=Object.assign(Object.assign({},a),{offset:r}),r+=M(a.type)*Br(a.count,1)}return t}class zr{constructor(e,t,r){this.bufferSize=0,this.bufferLayout=r;const n=Object.keys(this.bufferLayout);let s=this.bufferLayout[n[0]];for(let e=1;e<n.length;e++){const t=this.bufferLayout[n[e]];t.offset>s.offset&&(s=t)}this.bufferSize=s.offset+Hr(s),this.bufferData=new ArrayBuffer(this.bufferSize),this.bufferBytes=new Uint8Array(this.bufferData),this.bufferFloats=new Float32Array(this.bufferData),this.buffer=t.createBuffer(e,p.Uniform,x.Dynamic,this.bufferSize)}getBuffer(){return this.buffer}getBufferLayout(){return this.bufferLayout}setFloat(e,t){const r=Dr(this.bufferLayout[e],`Attempted to set unknown uniform ${e}`);this.bufferFloats[r.offset/4]=t}setVec2(e,t){const r=Dr(this.bufferLayout[e],`Attempted to set unknown uniform ${e}`);this.bufferFloats.set(t,r.offset/4)}setVec3(e,t){const r=Dr(this.bufferLayout[e],`Attempted to set unknown uniform ${e}`);this.bufferFloats.set(t,r.offset/4)}setVec4(e,t){const r=Dr(this.bufferLayout[e],`Attempted to set unknown uniform ${e}`);this.bufferFloats.set(t,r.offset/4)}setMat4(e,t){const r=Dr(this.bufferLayout[e],`Attempted to set unknown uniform ${e}`);this.bufferFloats.set(t,r.offset/4)}setBytes(e,t){const r=Dr(this.bufferLayout[e],`Attempted to set unknown uniform ${e}`);if(t.length!==Hr(r))throw new Error("Invalid size");this.bufferBytes.set(t,r.offset)}setFloats(e,t){const r=Dr(this.bufferLayout[e],`Attempted to set unknown uniform ${e}`);if(t.length!==Hr(r)/4)throw new Error("Invalid size");this.bufferFloats.set(t,r.offset/4)}getFloatArray(e){const t=this.bufferLayout[e];if(!t)throw new Error(`Attempted to set unknown uniform ${e}`);return new Float32Array(this.bufferData,t.offset,Hr(t)/4)}write(e){e.writeBufferData(this.buffer,0,this.bufferBytes)}terminate(e){e.removeBuffer(this.buffer)}}function Hr(e){return M(e.type)*Br(e.count,1)}class Xr{constructor(e){this.bufferSize=0,this.renderer=e}initialize(){this.bufferSize=0;const e=Object.keys(Xr.bufferLayout);for(let t=0;t<e.length;t++){const r=Xr.bufferLayout[e[t]];this.bufferSize+=M(r.type)}this._buffer=this.renderer.createBuffer("GlobalUniforms",p.Uniform,x.Dynamic,this.bufferSize)}setUniform(e,t){const r=Xr.bufferLayout[e];if(!r)throw new Error(`Attempted to set unknown global uniform ${e}`);const n=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this.renderer.writeBufferData(this.buffer,r.offset,n)}get buffer(){return this._buffer}}Xr.bufferLayout=qr({g_camPos:{type:c.Float3},g_proj:{type:c.Float4x4},g_viewProj:{type:c.Float4x4}});var $r=r(2),Wr=r.n($r),Yr=r(1),Kr=r.n(Yr),Jr=r(0),Zr=r.n(Jr);const Qr=n.create();function en(e,t,r){return(r-e)/(t-e)}function tn(e,t,r){return Math.max(Math.min(e,r),t)}class rn{constructor(){this.name="AvatarShader",this.defines="#define k_MaxBones 32\n",this.vertSource=[this.defines,rn.vert.sourceCode],this.fragSource=rn.frag.sourceCode}}rn.vert=Wr.a,rn.frag=Zr.a,rn.uniformLayout=qr({u_color:{type:c.Float4},u_bones:{type:c.Float4x4,count:32}}),rn.resourceLayout={uniforms:{index:0,type:g.UniformBuffer,layout:rn.uniformLayout},globalUniforms:{index:1,type:g.UniformBuffer,layout:Xr.bufferLayout}};class nn{constructor(){this.name="ModelShader",this.vertSource=nn.vert.sourceCode,this.fragSource=nn.frag.sourceCode}}nn.vert=Kr.a,nn.frag=Zr.a,nn.uniformLayout=qr({u_color:{type:c.Float4},u_model:{type:c.Float4x4}}),nn.resourceLayout={uniforms:{index:0,type:g.UniformBuffer,layout:nn.uniformLayout},globalUniforms:{index:1,type:g.UniformBuffer,layout:Xr.bufferLayout}};class sn{constructor(){this.modelUniforms=[],this.models=[],this.skinnedModels=[],this.animations=[]}initialize({gfxDevice:e,resources:t,globalUniforms:r}){this.gfxDevice=e,this.globalUniforms=r,this.shader=e.createShader(new rn),this.modelShader=e.createShader(new nn),this.skinnedUniforms=new zr("AvatarMaterial",e,rn.uniformLayout),t.load("data/Avatar.glb","gltf",(e,t)=>{if(e)return console.error("Failed to load resource",e);const r=t;this.animations=r.animations,this.rootNodes=r.rootNodeIds.map(e=>this.loadNode(r,e)),this.rootNodes.forEach(e=>{e.updateMatrix(),e.updateMatrixWorld(!1,!0)})})}loadSkinnedModel(e,t,r){const n=e.meshes[t],s=(e.skins[r],new Pr);for(let t of n.primitives){const r=new Cr({vertexLayout:t.vertexLayout,vertexBuffers:t.vertexBuffers.map(e=>e.id),elementCount:t.elementCount,indexBuffer:t.indexBuffer?t.indexBuffer.id:void 0,indexType:t.indexType,primitiveType:t.type}),n=Dr(t.material.technique),a=Br(t.material.values,[]),i={},o=[];for(const e of Object.keys(n.uniforms)){const t=n.uniforms[e];t.type===c.Texture2D?o.push(e):i[e]=t}const u=qr(i),h={uniforms:{index:0,type:g.UniformBuffer,layout:u}};for(let e=0;e<o.length;e++){h[o[e]]={index:e,type:g.Texture}}const f=new kr(this.gfxDevice,t.material.name,n.shader.id,h),l=new Gr(this.gfxDevice,jr.opaque,r,f),d=new zr(t.material.name,this.gfxDevice,u);for(const e of Object.keys(i))Ir(a[e])&&d.setFloats(e,a[e]);d.write(this.gfxDevice),l.material.setUniformBuffer(this.gfxDevice,"uniforms",d.getBuffer());for(const r of o){const n=e.textures[t.material.values[r].index].id;l.material.setTexture(this.gfxDevice,r,n)}this.modelUniforms.push(d),this.models.push(l),s.add(l)}return s}loadModel(e,t){const r=e.meshes[t],n=new Pr;for(let t of r.primitives){const r=new Cr({vertexLayout:t.vertexLayout,vertexBuffers:t.vertexBuffers.map(e=>e.id),elementCount:t.elementCount,indexBuffer:t.indexBuffer?t.indexBuffer.id:void 0,indexType:t.indexType,primitiveType:t.type}),s=Dr(t.material.technique),a=Br(t.material.values,[]),i={},o=[];for(const e of Object.keys(s.uniforms)){const t=s.uniforms[e];t.type===c.Texture2D?o.push(e):i[e]=t}const u=qr(i),h={uniforms:{index:0,type:g.UniformBuffer,layout:u}};for(let e=0;e<o.length;e++){h[o[e]]={index:e,type:g.Texture}}const f=new kr(this.gfxDevice,t.material.name,s.shader.id,h),l=new Gr(this.gfxDevice,jr.opaque,r,f),d=new zr(t.material.name,this.gfxDevice,u);for(const e of Object.keys(i))Ir(a[e])&&d.setFloats(e,a[e]);d.write(this.gfxDevice),l.material.setUniformBuffer(this.gfxDevice,"uniforms",d.getBuffer());for(const r of o){const n=e.textures[t.material.values[r].index].id;l.material.setTexture(this.gfxDevice,r,n)}this.modelUniforms.push(d),this.models.push(l),n.add(l)}return n}loadNode(e,t){const r=e.nodes[t];let n;if(Ir(r.skinId)){const t=Dr(r.meshId);n=this.loadSkinnedModel(e,t,r.skinId)}else n=Ir(r.meshId)?this.loadModel(e,r.meshId):new Pr;if(n.name=Br(r.name,`Node${t}`),s.copy(n.position,r.translation),a.copy(n.rotation,r.rotation),s.copy(n.scale,r.scale),n.updateMatrix(),r.children)for(const t of r.children){const r=this.loadNode(e,t);r.parent=n,n.add(r)}return n}update({clock:e}){const t=this.animations[0];if(t){const r=e.time/1e3%t.maxTime;for(let e=0;e<t.rotations.length;e++){const n=t.rotations[e],s=Dr(this.skinnedModels[0].skeleton.bones.find(e=>e.nodeId===n.nodeId));an(r,n,s.rotation)}for(let e=0;e<t.translations.length;e++){const n=t.translations[e],s=Dr(this.skinnedModels[0].skeleton.bones.find(e=>e.nodeId===n.nodeId));on(r,n,s.position)}for(let e=0;e<t.scales.length;e++){const n=t.scales[e],s=Dr(this.skinnedModels[0].skeleton.bones.find(e=>e.nodeId===n.nodeId));on(r,n,s.scale)}}}render({gfxDevice:e,camera:t}){for(let t=0;t<this.skinnedModels.length;t++){const r=this.skinnedModels[t];r.updateMatrixWorld(!0,!0),r.skeleton.evaluate(r.matrixWorld);const n=this.skinnedUniforms.getFloatArray("u_bones");r.skeleton.writeToBuffer(n),this.skinnedUniforms.write(e),r.renderList.push(r.primitive)}for(let r=0;r<this.models.length;r++){const s=this.models[r];s.updateMatrixWorld(!0,!0),this.modelUniforms[r].setMat4("modelViewProjection",n.multiply(n.create(),t.viewProjMatrix,s.matrixWorld)),this.modelUniforms[r].write(e),s.renderList.push(s.primitive)}}}function an(e,t,r){const n=t.times.length;let s=1,i=n-1,o=n-1;e=tn(e,t.times[0],t.times[n-1]);for(let r=0;r<n;r++){const n=t.times[r];if(n>e){s=en(t.times[Math.max(r-1,0)],n,e),o=r,i=Math.max(r-1,0);break}}let u=t.values.subarray(4*i,4*i+4),c=t.values.subarray(4*o,4*o+4);return a.lerp(r,u,c,s)}function on(e,t,r){const n=t.times.length;let a=1,i=n-1,o=n-1;e=tn(e,t.times[0],t.times[n-1]);for(let r=1;r<n;r++){const n=t.times[r];if(n>e){a=en(t.times[Math.max(r-1,0)],n,e),o=r,i=Math.max(r-1,0);break}}let u=t.values.subarray(3*i,3*i+3),c=t.values.subarray(3*o,3*o+3);return s.lerp(r,u,c,a)}const un=s.create();s.create(),s.create();class cn{constructor(e){this.camera=e,this.camPos=s.create()}initialize(){this.resize(window.innerWidth,window.innerHeight),this.controller=new fn,this.controller.camera=this.camera}resize(e,t){const r=e/t;this.camera.setPerspective(this.camera.fov,r,this.camera.near,this.camera.far)}update({globalUniforms:e,input:t,clock:r}){this.controller.update(t,r.dt);const n=this.camera.getPos(this.camPos);e.setUniform("g_camPos",new Float32Array([n[0],n[1],n[2]])),e.setUniform("g_proj",Float32Array.from(this.camera.projectionMatrix)),e.setUniform("g_viewProj",Float32Array.from(this.camera.viewProjMatrix))}toJSON(){return this.controller.toJSON()}fromJSON(e){return this.controller.fromJSON(e)}}const hn=s.fromValues(0,1,0);class fn{constructor(){this.x=-Math.PI/2,this.y=2,this.z=-4,this.orbitSpeed=-.05,this.xVel=0,this.yVel=0,this.zVel=0,this.translation=s.create(),this.txVel=0,this.tyVel=0,this.shouldOrbit=!0;const e=Or.addFolder("OrbitCamera");e.add(this,"orbitSpeed",-1,1),e.add(this,"shouldOrbit",-1,1)}update(e,t){const r=this.shouldOrbit,a=e.invertX?-1:1,i=e.invertY?-1:1;1===e.button?(this.txVel+=e.dx*(-10-Math.min(this.z,.01))/-5e3,this.tyVel+=e.dy*(-10-Math.min(this.z,.01))/5e3):e.isDragging()?(this.xVel+=e.dx/-200*a,this.yVel+=e.dy/-200*i):r&&Math.abs(this.xVel)<Math.abs(this.orbitSpeed)&&(this.xVel+=1*this.orbitSpeed/50),this.zVel+=e.dz;let o=0,u=0;e.isKeyDown("KeyA")&&(o+=.02),e.isKeyDown("KeyD")&&(o-=.02),e.isKeyDown("KeyW")&&(u+=.02),e.isKeyDown("KeyS")&&(u-=.02);const c=e.isKeyDown("ShiftLeft")||e.isKeyDown("ShiftRight");if(c?(this.xVel+=-o,this.yVel+=-u):(this.txVel+=o,this.tyVel+=-u),this.xVel=ln(this.xVel,2),this.yVel=ln(this.yVel,2),0!==this.xVel||0!==this.yVel||0!==this.zVel||0!==this.txVel||0!==this.tyVel){const t=e.isDragging()||c?.92:.96;this.x+=-this.xVel/10,this.xVel*=t,this.y+=-this.yVel/10,this.yVel*=t,this.txVel*=t,this.tyVel*=t,this.z+=4*Math.max(Math.log(Math.abs(this.zVel)),0)*Math.sign(this.zVel),0===e.dz&&(this.zVel*=.85),this.z>-10&&(this.z=-10,this.zVel=0),s.set(un,this.camera.cameraMatrix[0],this.camera.cameraMatrix[1],this.camera.cameraMatrix[2]),s.scaleAndAdd(this.translation,this.translation,un,this.txVel),s.set(un,this.camera.cameraMatrix[4],this.camera.cameraMatrix[5],this.camera.cameraMatrix[6]),s.scaleAndAdd(this.translation,this.translation,un,this.tyVel);const r=un;!function(e,t,r){const n=Math.sin(r);e[0]=n*Math.cos(t),e[1]=Math.cos(r),e[2]=n*Math.sin(t)}(r,this.x,this.y),s.scale(r,r,this.z),s.add(r,r,this.translation),n.lookAt(this.camera.viewMatrix,r,this.translation,hn),n.invert(this.camera.cameraMatrix,this.camera.viewMatrix),this.camera.viewMatrixUpdated()}return!1}toJSON(){const e=new Float32Array([this.x,this.y,this.z,this.translation[0],this.translation[1],this.translation[2]]);return btoa(String.fromCharCode.apply(null,new Uint8Array(e.buffer)))}fromJSON(e){const t=atob(e),r=new Uint8Array(24);for(let e=0,n=t.length;e<n;e++)r[e]=t.charCodeAt(e);const n=new Float32Array(r.buffer);this.x=n[0],this.y=n[1],this.z=n[2],s.copy(this.translation,n.subarray(3))}}function ln(e,t){return Math.max(-t,Math.min(e,t))}class dn{constructor(){this.dt=0,this.time=0,this.realDt=0,this.realTime=0,this.startTime=performance.now(),this.paused=!1,this.speed=1,this.stepDt=0}initialize(){Or.add(this,"paused"),Or.add(this,"speed",.001,8),Or.add(this,"step")}update(e){this.realDt=e-this.realTime,this.realTime=e,this.dt=this.paused?this.stepDt:this.realDt*this.speed,this.time=this.time+this.dt,this.stepDt=0}step(e=1e3/60){this.paused=!0,this.stepDt=e}}class mn{constructor(e,t){this.canvas=e,this.gfxDevice=t}initialize(){for(let e in jr)jr[e].defaultDepthStateId=this.gfxDevice.createDepthStencilState(jr[e].defaultDepthState)}render(){this.gfxDevice.beginFrame(),this.gfxDevice.bindRenderPass(0),function(e,t){const r=t.primitives.length;for(let n=0;n<r;n++){const r=t.primitives[n];if(e.bindPipeline(r.renderPipeline),e.bindVertices(r.vertexTable),e.bindResources(r.resourceTable),e.setCullMode(t.defaultCullMode),e.setDepthStencilState(t.defaultDepthStateId),Ir(r.indexBuffer)){const t=r.indexType===c.Ushort?2:4,n=Br(r.indexBuffer.byteOffset,0)/t;e.draw(r.type,r.indexBuffer.buffer,Dr(r.indexType),n,r.elementCount)}else e.drawNonIndexed(r.type,0,r.elementCount)}}(this.gfxDevice,jr.opaque),this.gfxDevice.endFrame();for(let e in jr)jr[e].primitives.length=0}resize(e,t,r){this.canvas.setAttribute("style",`width: ${e}px; height: ${t}px;`),this.canvas.width=e*r,this.canvas.height=t*r,this.gfxDevice&&this.gfxDevice.resize(this.canvas.width,this.canvas.height)}}class pn{constructor(){this.name="SimpleShader",this.vertSource=pn.vert.sourceCode,this.fragSource=pn.frag.sourceCode,this.resourceLayout=pn.resourceLayout}}pn.vert=Kr.a,pn.frag=Zr.a,pn.uniformLayout=qr({u_color:{type:c.Float4},u_model:{type:c.Float4x4}}),pn.resourceLayout={uniforms:{index:0,type:g.UniformBuffer,layout:pn.uniformLayout},globalUniforms:{index:1,type:g.UniformBuffer,layout:Xr.bufferLayout}};class gn{initialize({gfxDevice:e,globalUniforms:t,resources:r}){const n={buffers:[{stride:12,layout:{a_pos:{type:c.Float3,offset:0}}}]};r.load("data/Duck.glb","gltf",(e,t)=>{e&&console.error("Failed to load resource",e)}),this.shader=e.createShader(new pn),this.uniformBuffer=new zr("PlaneUniforms",e,pn.uniformLayout),this.uniformBuffer.setFloats("u_color",new Float32Array([0,0,1,1])),this.uniformBuffer.setMat4("u_model",Qr),this.uniformBuffer.write(e),this.material=new kr(e,"simple",this.shader,pn.resourceLayout),this.material.setUniformBuffer(e,"uniforms",this.uniformBuffer.getBuffer()),this.material.setUniformBuffer(e,"globalUniforms",t.buffer);const s=new Float32Array([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]);this.vertexBuffer=e.createBuffer("PlaneVertices",p.Vertex,x.Static,s),this.indexBuffer=e.createBuffer("PlaneIndices",p.Index,x.Static,new Uint16Array([0,1,2,2,1,3]).buffer),this.mesh=new Cr({vertexLayout:n,vertexBuffers:[this.vertexBuffer],elementCount:6,indexBuffer:this.indexBuffer}),this.model=new Gr(e,jr.opaque,this.mesh,this.material)}update({}){}render({}){jr.opaque.push(this.model.primitive)}}class xn{constructor(){this.invertY=!1,this.invertX=!1,this.button=-1,this.onisdraggingchanged=null,this.listeners=[],this.scrollListeners=[],this.usePointerLock=!0,this.isInteractive=!0,this.touchGesture=0,this.prevTouchX=0,this.prevTouchY=0,this.prevPinchDist=0,this.dTouchX=0,this.dTouchY=0,this.dPinchDist=0,this._onKeyDown=e=>{if(function(e){switch(e){case"ShiftLeft":case"ShiftRight":case"AltLeft":case"AltRight":return!0;default:return!1}}(e.code))e.preventDefault();else if(!this._hasFocus())return;this.keysDown.set(e.code,!e.repeat),this.callListeners()},this._onKeyUp=e=>{this.keysDown.delete(e.code),this.callListeners()},this._onBlur=()=>{this.keysDown.clear(),this.callListeners()},this._onWheel=e=>{e.preventDefault(),this.dz+=-4*Math.sign(e.deltaY),this.callScrollListeners()},this._onTouchChange=e=>{if(this.isInteractive)if(e.preventDefault(),1==e.touches.length){const t=this._getScaledTouches(e.touches);this.touchGesture=1,this.prevTouchX=t[0].x,this.prevTouchY=t[0].y,this.dTouchX=0,this.dTouchY=0}else if(2==e.touches.length){const t=this._getPinchValues(e.touches);this.touchGesture=2,this.prevTouchX=t.x,this.prevTouchY=t.y,this.prevPinchDist=t.dist,this.dTouchX=0,this.dTouchY=0,this.dPinchDist=0}else this.touchGesture=0},this._onTouchMove=e=>{if(this.isInteractive)if(e.preventDefault(),1==e.touches.length){const t=this._getScaledTouches(e.touches);this.touchGesture=1,this.dTouchX=t[0].x-this.prevTouchX,this.dTouchY=t[0].y-this.prevTouchY,this.onMotion(this.dTouchX,this.dTouchY),this.prevTouchX=t[0].x,this.prevTouchY=t[0].y}else if(2==e.touches.length){const t=this._getPinchValues(e.touches);this.touchGesture=2,this.dTouchX=t.x-this.prevTouchX,this.dTouchY=t.y-this.prevTouchY,this.dPinchDist=t.dist-this.prevPinchDist,this.prevTouchX=t.x,this.prevTouchY=t.y,this.prevPinchDist=t.dist}else this.touchGesture=0}}initialize({toplevel:e}){document.body.tabIndex=-1,this.toplevel=e,this.toplevel.tabIndex=-1,this.keysDown=new Map,document.addEventListener("keydown",this._onKeyDown,{capture:!0}),document.addEventListener("keyup",this._onKeyUp,{capture:!0}),window.addEventListener("blur",this._onBlur),this.toplevel.addEventListener("wheel",this._onWheel,{passive:!1}),this.toplevel.addEventListener("mousedown",e=>{this.isInteractive&&(this.button=e.button,yn.takeGrab(this,e,{takePointerLock:this.usePointerLock,useGrabbingCursor:!0,releaseOnMouseUp:!0}),null!==this.onisdraggingchanged&&this.onisdraggingchanged())}),this.toplevel.addEventListener("touchstart",this._onTouchChange),this.toplevel.addEventListener("touchend",this._onTouchChange),this.toplevel.addEventListener("touchcancel",this._onTouchChange),this.toplevel.addEventListener("touchmove",this._onTouchMove),this.afterFrame()}addListener(e){this.listeners.push(e)}addScrollListener(e){this.scrollListeners.push(e)}getMouseDeltaX(){return this.dx}getMouseDeltaY(){return this.dy}getTouchDeltaX(){return 2==this.touchGesture?this.dTouchX:0}getTouchDeltaY(){return 2==this.touchGesture?this.dTouchY:0}getPinchDeltaDist(){return 2==this.touchGesture?this.dPinchDist:0}isKeyDownEventTriggered(e){return!!this.keysDown.get(e)}isKeyDown(e){return this.keysDown.has(e)}isDragging(){return 0!=this.touchGesture||yn.hasGrabListener(this)}afterFrame(){this.dx=0,this.dy=0,this.dz=0,this.dTouchX=0,this.dTouchY=0,this.dPinchDist=0,this.keysDown.forEach((e,t)=>{this.keysDown.set(t,!1)})}focusViewer(){this.toplevel.focus()}_hasFocus(){return document.activeElement===document.body||document.activeElement===this.toplevel}callListeners(){for(let e=0;e<this.listeners.length;e++)this.listeners[e](this)}callScrollListeners(){for(let e=0;e<this.scrollListeners.length;e++)this.scrollListeners[e](this)}_getScaledTouches(e){const t=[],r=1e3/Math.max(1,Math.min(this.toplevel.clientWidth,this.toplevel.clientHeight));for(let n=0;n<e.length;n++)t.push({x:e[n].clientX*r,y:e[n].clientY*r});return t}_getPinchValues(e){const t=this._getScaledTouches(e);return{x:(t[0].x+t[1].x)/2,y:(t[0].y+t[1].y)/2,dist:Math.hypot(t[0].x-t[1].x,t[0].y-t[1].y)}}onMotion(e,t){this.dx+=e,this.dy+=t}onGrabReleased(){this.button=-1,null!==this.onisdraggingchanged&&this.onisdraggingchanged()}}const bn=new class{constructor(){this.styleElem=document.createElement("style"),document.head.appendChild(this.styleElem),this.style=this.styleElem.sheet}setCursor(e){if(this.style.cssRules.length&&this.style.deleteRule(0),e){const t=`* { ${e.map(e=>`cursor: ${e} !important;`).join(" ")} }`;this.style.insertRule(t,0)}}};const yn=new class{constructor(){this.grabListener=null,this.grabOptions=null,this.lastX=-1,this.lastY=-1,this._onMouseMove=e=>{if(null===this.grabListener)return;let t,r;void 0!==e.movementX?(t=e.movementX,r=e.movementY):(t=e.pageX-this.lastX,r=e.pageY-this.lastY,this.lastX=e.pageX,this.lastY=e.pageY),this.grabListener.onMotion(t,r)},this._onMouseDown=e=>{const t=this.grabOptions.grabElement;t&&!function(e,t){let r=e;for(;null!==r;){if(r===t)return!0;r=r.parentElement}return!1}(e.target,t)&&this.releaseGrab()},this._onMouseUp=e=>{this.releaseGrab()}}hasGrabListener(e){return this.grabListener===e}isGrabbed(){return null!==this.grabListener}takeGrab(e,t,r){if(null!==this.grabListener)return;this.grabListener=e,this.grabOptions=r,r.useGrabbingCursor&&bn.setCursor(["grabbing","-webkit-grabbing"]),this.lastX=t.pageX,this.lastY=t.pageY,document.body.focus(),t.preventDefault();const n=t.target;r.takePointerLock&&void 0!==n.requestPointerLock&&n.requestPointerLock(),document.addEventListener("mousemove",this._onMouseMove),r.releaseOnMouseUp?document.addEventListener("mouseup",this._onMouseUp):document.addEventListener("mousedown",this._onMouseDown,{capture:!0})}releaseGrab(){document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousedown",this._onMouseDown,{capture:!0}),void 0!==document.exitPointerLock&&document.exitPointerLock(),bn.setCursor(null);const e=this.grabListener;this.grabListener=null,e.onGrabReleased(),this.grabOptions=null}};var vn,Mn=r(3),wn=r.n(Mn);!function(e){e[e.LoadingAsync=0]="LoadingAsync",e[e.LoadingSync=1]="LoadingSync",e[e.Loaded=2]="Loaded",e[e.Unloaded=3]="Unloaded",e[e.Failed=4]="Failed"}(vn||(vn={}));class _n extends Pr{constructor(e){super(),this.nodeId=e}copy(e){return this.name=e.name,this.nodeId=e.nodeId,s.copy(this.position,e.position),a.copy(this.rotation,e.rotation),s.copy(this.scale,e.scale),this.matrix=n.copy(this.matrix,e.matrix),this.matrixWorld=n.copy(this.matrixWorld,e.matrixWorld),this.children=[],this.parent=null,this}}const Tn=1313821514,Un=5130562;let Sn=new TextDecoder;function En(e){return Sn.decode(e)}class Fn{constructor(e){const t=new DataView(e,0,12),r=new DataView(e,12),n=En(new Uint8Array(e,0,4)),s=t.getUint32(4,!0);t.getUint32(8,!0);if("glTF"!==n)throw new Error("Unsupported glTF-Binary header.");if(s<2)throw new Error("Unsupported legacy binary file detected.");let a=0;for(;a<r.byteLength;){const t=r.getUint32(a,!0);a+=4;const n=r.getUint32(a,!0);switch(a+=4,n){case Tn:{const r=new Uint8Array(e,12+a,t);this.json=En(r)}break;case Un:{const r=12+a;this.binaryChunk=new Uint8Array(e,r,t)}break;default:console.warn("Skipping unexpected glTF-Binary chunk type:",n)}a+=t}Lr(!!this.json,"glTF-Binary: JSON content not found.")}}class An{constructor(e,t){this.gltf=e,this.bufferData=t}bufferViewData(e){if(!this.gltf.bufferViews)throw new Error("No buffer views found.");const t=this.gltf.bufferViews[e],r=Dr(this.bufferData[t.buffer],`No data for buffer ${t.buffer}`),n=t.byteLength||0,s=t.byteOffset||0,a=r.buffer,i=r.byteOffset;return new Uint8Array(a,i+s,n)}accessorData(e){if(!this.gltf.accessors)throw new Error("No accessors views found.");const t=this.gltf.accessors[e],r=On[t.type];let n;const s=Rn[t.componentType],a=s.BYTES_PER_ELEMENT*r*t.count;if(void 0!==t.bufferView){const e=this.bufferViewData(t.bufferView);n=new s(e.buffer,e.byteOffset+Br(t.byteOffset,0),t.count*r)}else n=new s(a);if(t.sparse){const{count:e,indices:s,values:a}=t.sparse;let i=Rn[s.componentType],o=this.bufferViewData(s.bufferView);const u=new i(o.buffer,o.byteOffset+(s.byteOffset||0),e);i=Rn[t.componentType],o=this.bufferViewData(a.bufferView);const c=new i(this.bufferViewData(a.bufferView).buffer,o.byteOffset+(a.byteOffset||0),e*r);t.bufferView&&(n=new Uint8Array(n));const h=new Rn[t.componentType](n.buffer);for(let t=0;t<e;t++)for(let e=0;e<r;e++)h[r*u[t]+e]=c[r*t+e]}return n}}function Ln(e,t){let r;switch(t){case 5120:r=c.Char;break;case 5121:r=c.Uchar;break;case 5122:r=c.Short;break;case 5123:r=c.Ushort;break;case 5125:r=c.Uint;break;case 5126:r=c.Float;break;default:throw new Error("Invalid GLTF component type")}switch(e){case"SCALAR":r+=0;break;case"VEC2":r+=1;break;case"VEC3":r+=2;break;case"VEC4":r+=3;break;case"MAT2":throw new Error("2x2 Matrice not yet supported");case"MAT3":r=c.Float3x3;break;case"MAT4":r=c.Float4x4}return r}function Dn(e){switch(e){case 5124:return c.Int;case 5126:return c.Float;case 35664:return c.Float2;case 35665:return c.Float3;case 35666:return c.Float4;case 35667:return c.Int2;case 35668:return c.Int3;case 35669:return c.Int4;case 35675:return c.Float3x3;case 35676:return c.Float4x4;case 35678:return c.Texture2D;default:throw new Error("Invalid GLTF component type")}}function In(e){switch(e){case 0:return m.Points;case 1:return m.Lines;case 2:return m.LineLoop;case 3:return m.LineStrip;case 4:return m.Triangles;case 5:return m.TriangleStrip;case 6:return m.TriangleFan;default:throw new Error("Invalid GLTF primitive mode")}}const Bn={9728:l.Nearest,9729:l.Linear},Nn={9728:l.Nearest,9729:l.Linear},Rn={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},On={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Pn={POSITION:"a_pos",NORMAL:"a_normal",TANGENT:"a_tangent",JOINTS_0:"a_joints",WEIGHTS_0:"a_weights",COLOR_0:"a_color",TEXCOORD_0:"a_uv0",TEXCOORD_1:"a_uv1",MORPH0_POSITION:"a_posMorph0"},Vn={NORMAL:"HAS_NORMALS 1",TANGENT:"HAS_TANGENT 1",JOINTS_0:"HAS_JOINT_SET0 1",WEIGHTS_0:"HAS_WEIGHT_SET0 1",COLOR_0:"HAS_COLOR0 1",TEXCOORD_0:"HAS_UV_SET0 1",TEXCOORD_1:"HAS_UV_SET1 1"};function Cn(e,t,r){const n=r,s=t.gltf;let a;if(!Ir(r.material))throw new Error("Default material not yet supported");a=Dr(e.materials[r.material]);const i=[];let o=void 0;const u=[];if(Ir(n.indices)){const r=Dr(s.accessors)[n.indices];o=kn(e,t,Dr(r.bufferView),p.Index)}const c=Pn;if(Ir(a.technique)){const e=Object.keys(a.technique.attributes);for(const t of e){c[a.technique.attributes[t].semantic]=t}}const h={buffers:[]},f={};for(let r in n.attributes){const a=Dr(s.accessors)[n.attributes[r]],o=Dr(a.bufferView,"Undefined accessor buffers are not yet implemented"),c=f[o];let l;if(Ir(c))l=h.buffers[c];else{f[o]=u.length;const r=kn(e,t,o,p.Vertex);l={stride:Br(Dr(s.bufferViews)[o].byteStride,0),layout:{}},u.push(r),h.buffers.push(l)}const d=Vn[r];Ir(d)&&i.push(d);const m=Pn[r];l.layout[m]={type:Ln(a.type,a.componentType),offset:a.byteOffset||0}}if(n.targets){i.push("HAS_MORPH0 1"),Lr(1===n.targets.length,"Only 1 morph target is currently supported");const r=n.targets[0];for(let n in r)if("POSITION"===n){const a=Dr(s.accessors)[r[n]],i=Dr(a.bufferView,"Undefined accessor buffers are not yet implemented"),o=Dr(s.bufferViews)[i];let c=h.buffers[i];const f=kn(e,t,i,p.Vertex);Ir(c)||(u[i]=f,c=h.buffers[i]={stride:Br(o.byteStride,0),layout:{}});const l=Pn[`MORPH0_${n}`];c.layout[l]={type:Ln(a.type,a.componentType),offset:a.byteOffset||0}}}const l=s.accessors[Dr(n.indices,"Only indexed primitives are currently supported")],d=Dr(o,"Only indexed primitives are currently supported");return{elementCount:l.count,vertexBuffers:u,type:In(Br(n.mode,4)),indexType:Ln(l.type,l.componentType),indexBuffer:d,vertexLayout:h,material:a}}function kn(e,t,r,n){if(Ir(e.bufferViews[r]))return e.bufferViews[r];const s=Dr(t.gltf.bufferViews)[r].name||`buffer${r}`;e.bufferData[r]=new Uint8Array(t.bufferViewData(r)).buffer,e.transferList.push(e.bufferData[r]);const a={name:s,type:n,id:-1};return e.bufferViews[r]=a,a}const Gn={texture:new class{async loadAsync(e){const t=await fetch(e.source.uri);if(200!=t.status)throw new Error("Failed to download image");const r=e.source.uri.match(/.*\/(.+?)\./);e.name=r&&r.length>1?r[1]:"Unknown",self.createImageBitmap?(e.imageBitmap=await createImageBitmap(await t.blob()),e.transferList.push(e.imageBitmap),e.status=vn.LoadingSync):(e.imageBuffer=await t.arrayBuffer(),e.transferList.push(e.imageBuffer),e.status=vn.LoadingSync)}loadSync(e,t){if(t.imageBitmap)t.texture=e.renderer.createTexture(t.name,{usage:x.Static,type:h.Texture2D,format:f.U8x3,maxAnistropy:16},t.imageBitmap),t.imageBitmap.close(),delete t.imageBitmap,t.status=vn.Loaded;else{if(t.imageBuffer){var r=new Blob([t.imageBuffer],{type:"image/jpeg"});let e=window.URL.createObjectURL(r);delete t.imageBuffer,t.imageElement=new Image,t.imageElement.src=e,t.status=vn.LoadingSync}Ir(t.imageElement)&&t.imageElement.complete&&(t.texture=e.renderer.createTexture(t.name,{usage:x.Static,type:h.Texture2D,format:f.U8x3,maxAnistropy:16},t.imageElement),delete t.imageElement,t.status=vn.Loaded)}}unloadSync(e,t){Ir(t.texture)&&e.renderer.removeTexture(t.texture),Ir(t.imageBitmap)&&t.imageBitmap.close()}},gltf:new class{async loadAsync(e){const t=await fetch(e.source.uri);if(200!=t.status)throw new Error("Failed to download GLTF");const r=await t.arrayBuffer(),i=new Fn(r),o=JSON.parse(i.json),u=new An(o,[i.binaryChunk]);e.nodes=[],e.meshes=[],e.materials=[],e.textures=[],e.bufferViews=[],e.animations=[],e.rootNodeIds=[],e.imageData=[],e.bufferData=[];const c=function(e,t){const r=Br(t.gltf.images,[]),n=Br(t.gltf.textures,[]),s=Br(t.gltf.samplers,[]),a=[];e.textures=[],e.imageData=[];const i={type:h.Texture2D,format:f.U8x4,usage:x.Static},o={wrapS:10497,wrapT:10497};for(let n=0;n<r.length;n++){const s=Dr(r[n]),i=Dr(s.bufferView,"Image loading from a URI is not yet supported"),o=t.bufferViewData(i);let u;if(Ir(self.createImageBitmap)){const e=new Blob([o],{type:Dr(s.mimeType)});u=createImageBitmap(e)}else u=Promise.resolve(o.buffer);a.push(u.then(t=>{e.transferList.push(t),e.imageData[n]=t}))}return e.textures=n.map(e=>{const t=Br(s[e.sampler],o),r=Object.assign({},i);return Ir(t.magFilter)&&(r.defaultMagFilter=Bn[t.magFilter],Ir(r.defaultMagFilter)||console.warn(`Unsupported texture mag filter: ${t.magFilter}`)),Ir(t.minFilter)&&(r.defaultMagFilter=Nn[t.minFilter],Ir(r.defaultMagFilter)||console.warn(`Unsupported texture min filter: ${t.magFilter}`)),(Ir(t.wrapS)||Ir(t.wrapT))&&(Ir(r.defaultMagFilter)||console.warn(`Texture wrapping not yet supported: ${t.magFilter}`)),{name:e.name,desc:r,imageIndex:Dr(e.source),id:-1}}),a}(e,u);!function(e,t){var r;if(!(null===(r=t.gltf.extensionsUsed)||void 0===r?void 0:r.includes("KHR_techniques_webgl")))return;const n=Dr(t.gltf.extensions.KHR_techniques_webgl);e.shaderData=n.shaders.map((r,n)=>{const s=Dr(r.bufferView,"Shader loading from URI not yet supported"),a=new Uint8Array(t.bufferViewData(s)).buffer;return e.transferList.push(a),a}),e.shaders=n.programs.map(e=>({id:-1,name:e.name,fsIndex:e.fragmentShader,vsIndex:e.vertexShader})),e.techniques=n.techniques.map((t,r)=>{const n={};for(const e in Br(t.uniforms,{})){const r=t.uniforms[e];n[e]=Object.assign(Object.assign({},r),{type:Dn(r.type)})}return{shader:e.shaders[t.program],attributes:Br(t.attributes,{}),uniforms:n}})}(e,u),function(e,t){const r=Br(t.gltf.materials,[]);e.materials=[],e.materials=r.map((t,r)=>{var n;const s={name:Br(t.name,`Material${r}`),renderFormat:{blendingEnabled:!1},cullMode:t.doubleSided?b.None:b.Back},a=null===(n=t.extensions)||void 0===n?void 0:n.KHR_techniques_webgl;return Ir(a)&&(s.technique=e.techniques[a.technique],s.values=a.values),s})}(e,u),function(e,t){const r=Br(t.gltf.meshes,[]);e.meshes=[];for(let n=0;n<r.length;n++){const s=Dr(r[n]),a=[];for(let r of s.primitives)a.push(Cn(e,t,r));const i={name:s.name,id:n,primitives:a};e.meshes[n]=i}}(e,u),function(e,t){const r=Br(t.gltf.nodes,[]);e.nodes=[];for(let i=0;i<r.length;i++){const o=Dr(r[i]),u=Br(o.scale,[1,1,1]),c=Br(o.rotation,[0,0,0,1]),h=Br(o.translation,[0,0,0]),f={name:o.name,scale:s.fromValues(u[0],u[1],u[2]),rotation:a.fromValues(c[0],c[1],c[2],c[3]),translation:s.fromValues(h[0],h[1],h[2]),morphWeight:Br(o.weights,[0])[0]};if(Ir(o.matrix)?(f.transform=new Float32Array(o.matrix),n.getRotation(f.rotation,f.transform),n.getTranslation(f.translation,f.transform),n.getScaling(f.scale,f.transform)):f.transform=n.fromRotationTranslationScale(n.create(),f.rotation,f.translation,f.scale),Ir(o.mesh)&&(f.meshId=o.mesh),Ir(o.skin)&&(f.skinId=o.skin),Ir(o.children)){f.children=[];for(let e=0;e<o.children.length;e++){const r=o.children[e];Dr(t.gltf.nodes)[r];f.children.push(r)}}e.nodes.push(f)}}(e,u),function(e,t){const r=Br(t.gltf.skins,[]),n=Br(e.nodes,[]);e.skins=[];for(let s=0;s<r.length;s++){const a=r[s],i=[],o=[];for(let e=0;e<a.joints.length;e++){const t=a.joints[e],r=n[t],s=new _n(t);s.name=Br(r.name,`Bone${t}`),s.position=r.translation,s.rotation=r.rotation,s.scale=r.scale,i.push(s)}for(let e=0;e<a.joints.length;e++){const t=n[a.joints[e]];if(t.children)for(let r of t.children){const t=i.find(e=>e.nodeId===r);Ir(t)&&(t.parent=i[e],i[e].children.push(t))}}if(Ir(a.inverseBindMatrices)){const r=t.accessorData(a.inverseBindMatrices);e.transferList.push(r.buffer);for(let e=0;e<a.joints.length;e++)o[e]=r.subarray(16*e,16*e+16)}e.skins[s]={name:a.name,skeleton:a.skeleton,bones:i,inverseBindMatrices:o}}}(e,u),function(e,t){const r=Br(t.gltf.scene,0);if(Ir(r)){const n=Dr(t.gltf.scenes),s=Dr(n[r]);e.rootNodeIds=Br(s.nodes,[])}}(e,u),function(e,t){const r=Br(t.gltf.animations,[]);e.animations=[];for(let n=0;n<r.length;n++){const s=r[n],a=s.samplers.map(e=>(Lr(5126===t.gltf.accessors[e.input].componentType,"Non-float animation time type unsupported"),Lr(5126===t.gltf.accessors[e.output].componentType,"Non-float animation time type unsupported"),{times:t.accessorData(e.input),floats:t.accessorData(e.output)})),i=[],o=[],u=[],c=[];s.channels.forEach(e=>{const t={nodeId:Dr(e.target.node),times:a[e.sampler].times,values:a[e.sampler].floats};switch(e.target.path){case"translation":i.push(t);break;case"rotation":o.push(t);break;case"scale":u.push(t);break;case"weight":c.push(t)}});const h=Math.max(...s.samplers.map(e=>Dr(t.gltf.accessors[e.input].max)[0]));e.animations.push({name:s.name,maxTime:h,scales:u,rotations:o,translations:i,weights:c})}}(e,u),await Promise.all(c),e.status=vn.LoadingSync}loadSync(e,t){for(let r in t.bufferData){const n=t.bufferViews[r],s=t.bufferData[r];n.id=e.renderer.createBuffer(n.name,n.type,x.Static,s)}for(const r of Br(t.shaders,[])){const n=t.shaderData[r.vsIndex],s=t.shaderData[r.fsIndex],a={name:r.name,vertSource:En(n),fragSource:En(s)};r.id=e.renderer.createShader(a)}if(Ir(self.createImageBitmap)){for(const r of t.textures){const n=t.imageData[r.imageIndex];Lr(n instanceof ImageBitmap),r.id=e.renderer.createTexture(r.name,r.desc,n)}for(const e of t.imageData)e.close();delete t.imageData,t.status=vn.Loaded}else{let n=0;for(const s of t.textures){const a=t.imageData[s.imageIndex];if(-1===s.id){if(a instanceof ArrayBuffer){var r=new Blob([a],{type:"image/jpeg"});let e=window.URL.createObjectURL(r);t.imageData[s.imageIndex]=new Image,t.imageData[s.imageIndex].src=e,t.status=vn.LoadingSync}t.imageData[s.imageIndex].complete&&(s.id=e.renderer.createTexture(s.name,{usage:x.Static,type:h.Texture2D,format:f.U8x3,maxAnistropy:16},t.imageData[s.imageIndex]))}else n+=1}n===t.textures.length&&(delete t.imageData,t.status=vn.Loaded)}}unloadSync(e,t){}}};class jn{constructor(){this.messages=[],this.pending=[],this.finished=[],this.unloaded=[],this.loadingAsync=[],this.loadingSync=[],this.cache={},this.requests={}}initialize(e){this.worker=new wn.a,this.worker.onmessage=e=>this.onMessage(e),this.context={renderer:e}}onMessage(e){this.messages.push(e)}load(e,t,r){if(!Ir(Gn[t]))return void r("Invalid resource type",void 0);const n="string"==typeof e?e:e.uri,s="string"==typeof e?void 0:e.headers,a=n+t;if(Ir(this.cache[a]))r(void 0,this.cache[a]);else if(this.requests[a])this.requests[a].push(r);else{this.requests[a]=[r];const e={source:{uri:n,headers:s,type:t},status:vn.LoadingAsync,transferList:[]};this.worker.postMessage([e])}}unload(e,t){const r=("string"==typeof e?e:e.uri)+t;if(Ir(this.cache[r])){const e=this.cache[r];Gn[e.source.type].unloadSync(this.context,e),delete this.cache[r]}else{if(!this.requests[r])throw new Error(`Attempted to unload a resource that was never loaded: ${r}`);delete this.requests[r]}}update(){for(let e of this.messages)Array.prototype.push.apply(this.pending,e.data);for(let e of this.pending){const t=e.source.uri+e.source.type;if(Ir(this.requests[t])||(e.status=vn.Unloaded),e.status===vn.LoadingSync){Gn[e.source.type].loadSync(this.context,e)}switch(e.status){case vn.Loaded:case vn.Failed:this.finished.push(e);break;case vn.Unloaded:this.unloaded.push(e);break;case vn.LoadingAsync:this.loadingAsync.push(e);break;case vn.LoadingSync:this.loadingSync.push(e)}}this.pending.length=0;for(let e of this.finished){const t=e.source.uri+e.source.type,r=Dr(this.requests[t]).length;Lr(r>=1),this.cache[t]=e;for(let n=0;n<r;n++)e.status===vn.Failed?this.requests[t][n](e.error,void 0):this.requests[t][n](void 0,e);delete this.requests[t]}const e=[];for(let t of this.loadingAsync)Array.prototype.push.apply(e,t.transferList);this.worker.postMessage(this.loadingAsync,e);for(let e of this.unloaded){Gn[e.source.type].unloadSync(this.context,e)}Array.prototype.push.apply(this.pending,this.loadingSync),this.finished.length=0,this.unloaded.length=0,this.loadingAsync.length=0,this.loadingSync.length=0,this.messages.length=0}}class qn{constructor(){this.clearing=!1}initialize(e){Or.add(this,"clearState"),this.loadState(e)&&console.log("Loaded state from localStorage")}saveState({cameraSystem:e}){const t={version:1,cameraSystem:e,DebugMenu:Or},r=JSON.stringify(t);this.clearing||window.localStorage.setItem("state",r)}loadState({cameraSystem:e}){const t=window.localStorage.getItem("state");if(!Ir(t))return!1;const r=JSON.parse(t);if(1!==r.version)return!1;try{e.fromJSON(r.cameraSystem),Or.fromJSON(r.DebugMenu)}catch(e){return console.warn("Failed to load state:",e),!1}return!0}clearState(){window.localStorage.removeItem("state"),this.clearing=!0,location.reload()}update(e){0}}window.main=new class{constructor(){this.canvas=document.createElement("canvas"),this.gfxDevice=new H,this.camera=new Nr,this.clock=new dn,this.cameraSystem=new cn(this.camera),this.compositor=new mn(this.canvas,this.gfxDevice),this.globalUniforms=new Xr(this.gfxDevice),this.demo=new gn,this.input=new xn,this.resources=new jn,this.avatars=new sn,this.state=new qn,this.init()}async init(){return console.log(`Source for this build available at ${o}`),this.toplevel=document.createElement("div"),document.body.appendChild(this.toplevel),this.toplevel.appendChild(this.canvas),this.gfxDevice.setDebugEnabled(!1),this.gfxDevice.initialize(this.canvas)?(this.gfxDevice.resize(this.canvas.width,this.canvas.height),this.resources.initialize(this.gfxDevice),this.clock.initialize(),this.input.initialize(this),this.cameraSystem.initialize(),this.compositor.initialize(),this.globalUniforms.initialize(),this.demo.initialize(this),this.avatars.initialize(this),this.state.initialize(this),window.onresize=this.onResize.bind(this),this.onResize(),this.update(window.performance.now()),0):1}update(e){this.clock.update(e),this.resources.update(),this.cameraSystem.update(this),this.demo.update(this),this.avatars.update(this),this.state.update(this),this.compositor.render(),this.demo.render(this),this.avatars.render(this),this.input.afterFrame(),Or.update(),window.requestAnimationFrame(this.update.bind(this))}onResize(){this.cameraSystem.resize(window.innerWidth,window.innerHeight),this.compositor.resize(window.innerWidth,window.innerHeight,window.devicePixelRatio)}}}]);